
'Private Declare Sub Sleep Lib "kernel32" (ByVal dwMilliseconds As Long)
Dim arr(8000) As Long
Dim arr1(500) As String
Dim arr2(18000) As Long
Dim arr3(8000) As Long
Dim actual_end_time As String
Dim cutoff_time As String
Dim project_name As String
Dim deliverable_label As String
Dim Msg As String
Dim delay_cnter As Long
Dim reason_code As String
Dim comments As String
Dim sTemp As String
Dim sTemp1 As String
Dim sTemp2 As String
Dim sTemp3 As String
Dim qry_team As String
Dim qry_cust As String
Dim qry_wf As String
Dim qry_stage As String
Dim qry_iwo_due_date As String
Dim qry_iwo_receipt_date As String
Dim qry_ewo_due_date As String
Dim qry_ewo_receipt_date As String
Dim sno As Integer
Dim row_inv As Integer
Dim column_inv As Integer
Dim team_sel As Boolean
Dim cus_sel As Boolean
Dim wf_sel As Boolean
Dim stage_sel As Boolean
Dim s1 As String
Dim e1 As String
Dim actual_end As String
Dim t1, t2, t3, t4, t5, t6, t7, t8 As Integer
Dim sas_exclude As String
Dim record_counter As Integer
Dim PctDone As Variant
Dim vir_field_name As String
Dim query_flag As Integer
Dim customer_name, wf_name, project_id, pname, sub_pname, batch_number, receipt_date, planned_date, comp_date, timezone, force_time_delivery, Status, complexity, ms_pages, del_pages, cnt, customer_contact, pm_pc, csr_name, project_id_test As String

Public chkdate As Boolean

Private Sub CheckBox1_Click()

If CheckBox1.Value = True Then

    OptionButton1.Value = True
    OptionButton2.Value = False
    OptionButton2.Enabled = True
    CheckBox2.Value = False
    VIR_FORM.Caption = "Volume Inflow Report"
    TextBox1.Text = ""
    TextBox2.Text = ""

ElseIf CheckBox1.Value = False Then

    OptionButton1.Value = True
    OptionButton2.Value = False
    OptionButton2.Enabled = False
    CheckBox1.Value = False
    CheckBox2.Value = True
    VIR_FORM.Caption = "Deliverable Status Report"
    TextBox1.Text = format(Now(), "yyyy-mm-dd")
    TextBox2.Text = format(Now(), "yyyy-mm-dd")
    
End If

End Sub
Private Sub CheckBox2_Click()

If CheckBox2.Value = True Then

    OptionButton1.Value = True
    OptionButton2.Value = False
    OptionButton2.Enabled = False
    CheckBox1.Value = False
    VIR_FORM.Caption = "Deliverable Status Report"
    TextBox1.Text = format(Now(), "yyyy-mm-dd")
    TextBox2.Text = format(Now(), "yyyy-mm-dd")

ElseIf CheckBox2.Value = False Then

    OptionButton1.Value = True
    OptionButton2.Value = False
    OptionButton2.Enabled = True
    CheckBox1.Value = True
    VIR_FORM.Caption = "Volume Inflow Report"
    TextBox1.Text = ""
    TextBox2.Text = ""
    
End If

End Sub

Private Sub Cmd_Startdate_Click()
chkdate = True
'frmCalendar.Calendar1.Today
'Call frmCalendar.Show
DatePickerForm.Show
chkdate = False
End Sub

Private Sub Cmd_Enddate_Click()
'frmCalendar.Calendar1.Today
'Call frmCalendar.Show
DatePickerForm.Show
End Sub

Private Sub GEN_REPORT_Click()

s1 = format(TextBox1.Text, "yyyy-mm-dd 00:00:00")
e1 = format(TextBox2.Text, "yyyy-mm-dd 23:59:59")

cur_dt = format(Now, "yyyy-mm-dd hh:mm:ss")

'If TextBox1.Text = "" And TextBox2.Text = "" Then
'    MsgBox "Please select atleast START DATE  to  run the report!", vbExclamation
'    Call UserForm_Initialize
'    GoTo module_exit
'ElseIf TextBox1.Text <> "" And TextBox2.Text = "" Then
'    qry_iwo_due_date = " ifnull(p.revised_end_date, p.planned_end_date)>=timestamp('" & s1 & "','05:30') "
'    If OptionButton1.Value = True Then
'    qry_iwo_receipt_date = " (wd.date_in >=timestamp('" & s1 & "','05:30'))"
'    Else
'    qry_iwo_receipt_date = " if(sas.stage_id = '6',(wd.date_in >=timestamp('" & s1 & "','05:30')),(wd.end_date >=timestamp('" & s1 & "','05:30')))"
'    End If
'    qry_ewo_due_date = " ewd.estimated_completion_time >=timestamp('" & s1 & "','05:30') "
'    qry_ewo_receipt_date = " (ewd.created_on >=timestamp('" & s1 & "','05:30'))"
'Else
'    qry_iwo_due_date = " ifnull(p.revised_end_date, p.planned_end_date)>=timestamp('" & s1 & "','05:30') and ifnull(p.revised_end_date, p.planned_end_date)<=timestamp('" & e1 & "','05:30') "
'    If OptionButton1.Value = True Then
'    qry_iwo_receipt_date = " (wd.date_in >=timestamp('" & s1 & "','05:30') and wd.date_in <=timestamp('" & e1 & "','05:30'))"
'    Else
'    qry_iwo_receipt_date = " if(sas.stage_id = '6',(wd.date_in >=timestamp('" & s1 & "','05:30') and wd.date_in <=timestamp('" & e1 & "','05:30')),(wd.end_date >=timestamp('" & s1 & "','05:30') and wd.end_date <=timestamp('" & e1 & "','05:30')))"
'    End If
'    qry_ewo_due_date = "(ewd.estimated_completion_time >=timestamp('" & s1 & "','05:30') and ewd.estimated_completion_time <=timestamp('" & e1 & "','05:30')) "
'    qry_ewo_receipt_date = " (ewd.created_on >=timestamp('" & s1 & "','05:30') and ewd.created_on <=timestamp('" & e1 & "','05:30'))"
'End If

If TextBox1.Text = "" And TextBox2.Text = "" Then
    MsgBox "Please select atleast START DATE  to  run the report!", vbExclamation
    Call UserForm_Initialize
    GoTo module_exit
ElseIf TextBox1.Text <> "" And TextBox2.Text = "" Then
    qry_iwo_due_date = " timestamp(ifnull(p.revised_end_date, p.planned_end_date), if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6)))>='" & s1 & "' "
    If OptionButton1.Value = True Then
    qry_iwo_receipt_date = " (timestamp(wd.date_in, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) >='" & s1 & "')"
    Else
    qry_iwo_receipt_date = " if(sas.stage_id = '6',(timestamp(wd.date_in, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) >='" & s1 & "'),(timestamp(wd.end_date, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) >='" & s1 & "'))"
    End If
    'qry_ewo_due_date = " timestamp(ewd.estimated_completion_time, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) >='" & s1 & "' "
    qry_ewo_due_date = " ewd.estimated_completion_time >=timestamp('" & s1 & "',if(left(right(gmt_value,6),1)='+',concat('-',right(gmt_value,5)),right(gmt_value,5)))"
    'qry_ewo_receipt_date = " (timestamp(ewd.created_on, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) >='" & s1 & "')"
    qry_ewo_receipt_date = " (ewd.created_on >=timestamp('" & s1 & "',if(left(right(gmt_value,6),1)='+',concat('-',right(gmt_value,5)),right(gmt_value,5))))"
    
Else
    qry_iwo_due_date = " timestamp(ifnull(p.revised_end_date, p.planned_end_date), if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6)))>='" & s1 & "' and timestamp(ifnull(p.revised_end_date, p.planned_end_date), if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6)))<='" & e1 & "' "
    If OptionButton1.Value = True Then
    qry_iwo_receipt_date = " (timestamp(wd.date_in, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) >='" & s1 & "' and timestamp(wd.date_in, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) <='" & e1 & "')"
    Else
    qry_iwo_receipt_date = " if(sas.stage_id = '6',(timestamp(wd.date_in, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) >='" & s1 & "' and timestamp(wd.date_in, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) <='" & e1 & "'),(timestamp(wd.end_date, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) >='" & s1 & "' and timestamp(wd.end_date, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) <='" & e1 & "'))"
    End If
    'qry_ewo_due_date = "(timestamp(ewd.estimated_completion_time, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) >='" & s1 & "' and timestamp(ewd.estimated_completion_time, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) <='" & e1 & "') "
    qry_ewo_due_date = " (ewd.estimated_completion_time >=timestamp('" & s1 & "',if(left(right(gmt_value,6),1)='+',concat('-',right(gmt_value,5)),right(gmt_value,5))) and ewd.estimated_completion_time <=timestamp('" & e1 & "',if(left(right(gmt_value,6),1)='+',concat('-',right(gmt_value,5)),right(gmt_value,5))))"
    'qry_ewo_receipt_date = " (timestamp(ewd.created_on, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) >='" & s1 & "' and timestamp(ewd.created_on, if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6))) <='" & e1 & "')"
    qry_ewo_receipt_date = " (ewd.created_on >=timestamp('" & s1 & "',if(left(right(gmt_value,6),1)='+',concat('-',right(gmt_value,5)),right(gmt_value,5))) and ewd.created_on <=timestamp('" & e1 & "',if(left(right(gmt_value,6),1)='+',concat('-',right(gmt_value,5)),right(gmt_value,5))))"
End If

'Debug.Print qry_ewo_due_date

If TextBox1.Text <> "" And TextBox2.Text <> "" Then
    If TextBox1.Text > TextBox2.Text Then
        MsgBox "Start Date should be less than End Date", vbCritical
        GoTo module_exit
    End If
End If

sTemp = ""

'Team Name Select Mandatory check
Call team_list(sTemp, team_sel)

If team_sel = False Then

Ans = MsgBox("Select atleast a Team to run VIR Report...", vbOKCancel)
    
    If Ans = vbOK Then
        GoTo module_exit
    ElseIf Ans = vbCancel Then
        'Call UserForm_Activate
    End If

End If

'VIR_FORM.Hide

'CSO Assigned WO - VIR Exclude Condition Check
Call cso_vir_exclude


'Show Progress Bar
Call Progress_mod

progress_status.Caption = "Checking..."

sno = 1
row_inv = 8
column_inv = 1

Dim con_rep As ADODB.Connection
Set con_rep = New ADODB.Connection

Dim rs_iwo_vir_mapping As ADODB.Recordset
Set rs_iwo_vir_mapping = New ADODB.Recordset

con_rep.ConnectionString = "Driver={" & ODBCDRIVER & "};server=" & conip & ";user=" & userid & ";password=" & userpass & ";option=3"
con_rep.CursorLocation = adUseClient
con_rep.Open

rs_iwo_vir_mapping.Open "select iwo_due_date_query, iwo_receipt_date_query, ewo_due_date_query, ewo_receipt_date_query from workflow.cfg_vir_query order by cfg_vir_query_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

If rs_iwo_vir_mapping.RecordCount > 0 Then

If CheckBox1.Value = True Then

Sheets(1).Name = "Data"
Sheets(2).Name = "Pivot"

    If OptionButton1.Value = True Then
        Sheet1.activate
        Call header_field(1)
        Call report_fields(row_inv, column_inv)
        Call report_data(rs_iwo_vir_mapping.Fields("iwo_due_date_query"), qry_iwo_due_date, "iwo") 'INDIA DUE DATE - IWO
        Call report_data(rs_iwo_vir_mapping.Fields("ewo_due_date_query"), qry_ewo_due_date, "ewo") 'INDIA DUE DATE - EWO
    ElseIf OptionButton2.Value = True Then
        Sheet1.activate
        Call header_field(2)
        Call report_fields(row_inv, column_inv)
        Call report_data(rs_iwo_vir_mapping.Fields("iwo_receipt_date_query"), qry_iwo_receipt_date, "iwo") 'INDIA RECEIPT DATE - IWO
        Call report_data(rs_iwo_vir_mapping.Fields("ewo_receipt_date_query"), qry_ewo_receipt_date, "ewo") 'INDIA RECEIPT DATE - EWO
    End If

ElseIf CheckBox2.Value = True Then

Sheets(1).Name = "Deliverables"
Sheets(2).Name = "WIP"
    
    If OptionButton1.Value = True Then
        
        Sheet1.activate
        Call header_field(1)
        Sheet1.activate
        Call report_fields(row_inv, column_inv)
        Call report_data(rs_iwo_vir_mapping.Fields("iwo_due_date_query"), qry_iwo_due_date, "iwo") 'INDIA DUE DATE - IWO
        Call report_data(rs_iwo_vir_mapping.Fields("ewo_due_date_query"), qry_ewo_due_date, "ewo") 'INDIA DUE DATE - EWO
        
        Call report_formatting
        column_inv = 3
        row_inv = row_inv + 3
        Call legend(row_inv, column_inv)
    
        If TextBox2.Text <> "" Then
        s1 = format(DateAdd("d", 1, TextBox2.Text), "yyyy-mm-dd 00:00:00")
        Else
        s1 = format(Now + 1, "yyyy-mm-dd 00:00:00")
        End If
        
        sno = 1
        row_inv = 8
        column_inv = 1
        
        qry_iwo_due_date = " ifnull(p.revised_end_date, p.planned_end_date)>='" & s1 & "' "
        qry_ewo_due_date = " ewd.estimated_completion_time >='" & s1 & "' "
        
        Sheet2.activate
        Call header_field(1)
        Sheet2.activate
        Call report_fields(row_inv, column_inv)
        Call deliv_report_data(rs_iwo_vir_mapping.Fields("iwo_due_date_query"), qry_iwo_due_date, "iwo") 'INDIA DUE DATE - IWO
        Call deliv_report_data(rs_iwo_vir_mapping.Fields("ewo_due_date_query"), qry_ewo_due_date, "ewo") 'INDIA DUE DATE - EWO
        
        Call report_formatting
        column_inv = 3
        row_inv = row_inv + 3
        Call legend(row_inv, column_inv)
        
    End If
    
   
End If

End If

If CheckBox1.Value = True Then 'Only for VIR Report

    Call report_formatting
    
    column_inv = 3
    row_inv = row_inv + 3
    
    Call legend(row_inv, column_inv)

    If Range("A9").Value <> "" Then
    create_pivot
    End If
    
End If

Sheet1.activate

'form_reset

VIR_FORM.Hide

Erase arr
Erase arr1
Erase arr2
Erase arr3

module_exit:

End Sub

Function GetColumnLetter(colnum As Long) As String
    Dim vArr
    vArr = Split(Cells(1, colnum).Address(True, False), "$")
    GetColumnLetter = vArr(0)
End Function

Public Sub report_data(iwo_query, qry_date, wo_type)

sTemp = ""
sTemp1 = ""
sTemp2 = ""
sTemp3 = ""

Dim con_rep As ADODB.Connection
Set con_rep = New ADODB.Connection

Dim rs_receipt_date As ADODB.Recordset
Set rs_receipt_date = New ADODB.Recordset

Dim rs_deliver_date As ADODB.Recordset
Set rs_deliver_date = New ADODB.Recordset

Dim rs_corr_cnt As ADODB.Recordset
Set rs_corr_cnt = New ADODB.Recordset

Dim rs_complexity As ADODB.Recordset
Set rs_complexity = New ADODB.Recordset

Dim rs_label As ADODB.Recordset
Set rs_label = New ADODB.Recordset

Dim rs_ms_pages As ADODB.Recordset
Set rs_ms_pages = New ADODB.Recordset

Dim rs_del_pages As ADODB.Recordset
Set rs_del_pages = New ADODB.Recordset

Dim rs_ms_pages_label As ADODB.Recordset
Set rs_ms_pages_label = New ADODB.Recordset

Dim rs_iwo As ADODB.Recordset
Set rs_iwo = New ADODB.Recordset

Dim rs_team As ADODB.Recordset
Set rs_team = New ADODB.Recordset

Dim rs_timezone_value As ADODB.Recordset
Set rs_timezone_value = New ADODB.Recordset

Dim rs_query As ADODB.Recordset
Set rs_query = New ADODB.Recordset

Dim rs_query_approval As ADODB.Recordset
Set rs_query_approval = New ADODB.Recordset

Dim rs_comp As ADODB.Recordset
Set rs_comp = New ADODB.Recordset

Dim cmd As ADODB.Command
Set cmd = New ADODB.Command

Dim rs_sch As ADODB.Recordset
Set rs_sch = New ADODB.Recordset

Dim rs_del_pages_label As ADODB.Recordset
Set rs_del_pages_label = New ADODB.Recordset

Dim rs_planned_date As ADODB.Recordset
Set rs_planned_date = New ADODB.Recordset

Dim rsVault As ADODB.Recordset
Set rsVault = New ADODB.Recordset

Dim rsTitleCnt As ADODB.Recordset
Set rsTitleCnt = New ADODB.Recordset

Dim rs_JG_Complexity As ADODB.Recordset
Set rs_JG_Complexity = New ADODB.Recordset

Dim project_id As String

con_rep.ConnectionString = "Driver={" & ODBCDRIVER & "};server=" & conip & ";user=" & userid & ";password=" & userpass & ";option=3"
con_rep.CursorLocation = adUseClient
con_rep.Open

sTemp = ""
'Team Name
Call team_list(sTemp, team_sel)

If team_sel = False Then
qry_team = " 1=1 "
Else
    If wo_type = "iwo" Then
        qry_team = "vir.team_id in (" & sTemp & ")"
    Else
        qry_team = "td.team_id in (" & sTemp & ")"
    End If
End If

'Hardcoded for Jouve Production Team by Boopathi on 1-Mar-16 as requested by Srinivasan S)
If InStr(1, sTemp, "'135'") Or InStr(1, sTemp, "'48'") Then
    qry_team1 = "td.team_id not in ('99')"
Else
    qry_team1 = " 1=1 "
End If


If team_sel = True Then

rs_team.Open "select group_concat(distinct(team_name),'') as team_name from ems.team_details td where td.team_id in (" & sTemp & ") order by team_id", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

If rs_team.RecordCount > 0 Then
tt = rs_team.Fields("team_name")
rs_team.Close
Else
tt = ""
rs_team.Close
End If

Sheet1.Range("B6").Value = "Team Name"
Sheet1.Range("B6:B6").HorizontalAlignment = xlCenter
Sheet1.Range("B6:B6").MergeCells = True
Sheet1.Range("B6:B6").font.Bold = True
Sheet1.Range("B6:B6").Select
Selection.Interior.ColorIndex = 9
Selection.font.ColorIndex = 2
Sheet1.Range("B6:B6").VerticalAlignment = xlCenter
border1

Sheet1.Range("C6").Value = tt
Sheet1.Range("C6:J6").HorizontalAlignment = xlLeft
Sheet1.Range("C6:J6").MergeCells = True
Sheet1.Range("C6:J6").font.Bold = True
Sheet1.Range("C6:J6").Select
Selection.Interior.ColorIndex = 19
border1

End If

'Customer Name
Call cus_list(sTemp1, cus_sel)

If cus_sel = False Then
qry_cust = " 1=1 "
Else
qry_cust = "pd.customer_division_imprint_id in (" & sTemp1 & ")"
End If

'Workflow Name
Call workflow_list(sTemp2, wf_sel)

If wf_sel = False Then
qry_wf = " 1=1 "
Else
qry_wf = "pd.workflow_id in (" & sTemp2 & ")"
End If

'Stage Name
Call stage_list(sTemp3, stage_sel)

If stage_sel = False Then
qry_stage = " 1=1 "
Else
    If wo_type = "iwo" Then
        qry_stage = "sas.stage_id in (" & sTemp3 & ")"
    Else
        qry_stage = "ewd.stage_id in (" & sTemp3 & ")"
    End If
End If

'To get VIR exclude SAS by Team
Call vir_sas_exclude(sTemp, sas_exclude)

If wo_type = "iwo" Then
    If sas_exclude = "" Then
    sas_exclude = "1=1"
    Else
    sas_exclude = "sas.stage_id not in (" & sas_exclude & ")"
    End If
Else
    If sas_exclude = "" Then
    sas_exclude = "1=1"
    Else
    sas_exclude = "ewd.stage_id not in (" & sas_exclude & ")"
    End If
End If

'Progress Bar Reset to Default Width
LabelProgress.Width = 1

    If wo_type = "iwo" Then
    progress_status.Caption = "Checking IWO Records..."
    Else
    progress_status.Caption = "Checking EWO Records..."
    End If

str1 = iwo_query

Set cmd.ActiveConnection = con_rep
    str1 = Replace(str1, "<qry_team>", qry_team)
    str1 = Replace(str1, "<qry_cust>", qry_cust)
    str1 = Replace(str1, "<qry_wf>", qry_wf)
    str1 = Replace(str1, "<qry_stage>", qry_stage)
    str1 = Replace(str1, "<qry_date>", qry_date)
    str1 = Replace(str1, "<qry_sas_exclude>", sas_exclude)
    str1 = Replace(str1, "<qry_team1>", qry_team1)
    
    If wo_type = "ewo" Then
        If (sTemp = "'36'" Or sTemp = "'146'") Then
            str1 = Replace(str1, "<xml_team_id>", sTemp)
        Else
            str1 = Replace(str1, "<xml_team_id>", "'1'")
        End If
    End If
    
cmd.CommandText = str1
'Debug.Print str1
'MsgBox str1
cmd.CommandType = adCmdText

    Set rs_iwo = cmd.Execute

    If rs_iwo.RecordCount > 0 Then
    
    Sheet1.activate
    
    record_counter = 0
    
    If wo_type = "iwo" Then
    progress_bar_caption = "Populating IWO Records..."
    Else
    progress_bar_caption = "Populating EWO Records..."
    End If
    progress_status.Caption = progress_bar_caption
    
        Do Until rs_iwo.EOF
        
        progress_status.Caption = progress_bar_caption & " (" & (rs_iwo.RecordCount - record_counter) & ")"
        
        If wo_type = "ewo" Then
            If Not IsNull(rs_iwo.Fields("is_exclude")) And rs_iwo.Fields("is_exclude") <> "" And rs_iwo.Fields("is_exclude") = "y" Then GoTo exi
        End If
        
        If IsNull(rs_iwo.Fields("team_id")) Or rs_iwo.Fields("team_id") = "" Then
            MsgBox "For Project " & (rs_iwo.Fields("project_id")) & " - Customer '" & Trim(rs_iwo.Fields("customer_name")) & " - " & rs_iwo.Fields("wf_name") & "' is not associated to any team. Please associate and rerun VIR"
            End
        End If
        
        sno = sno
        customer_name = rs_iwo.Fields("customer_name")
        wf_name = rs_iwo.Fields("wf_name")
        project_id = rs_iwo.Fields("project_id")
        project_name = rs_iwo.Fields("project_name")
        book_title = rs_iwo.Fields("book_title")
        pname = rs_iwo.Fields("pname")
        sub_pname = rs_iwo.Fields("sub_pname")
        product_id = rs_iwo.Fields("product_id")
        
        If (InStr(1, product_id, "1") And CInt(rs_iwo.Fields("team_id")) = "131") Then
        pname = "Non-Reprint"
        End If
        
        If (CInt(rs_iwo.Fields("team_id")) = "131") Then
        rsTitleCnt.Open "select proj_cnt, date_on from (select count(project_id)as proj_cnt, year(pd.date_on) as date_on from workflow.project_details pd, ems.team_customer tc where pd.date_on >= timestamp(concat(year(current_date()),'-01-01 00:00:00'),'05:30') and tc.team_id = '131' and tc.customer_division_imprint_id = pd.customer_division_imprint_id and tc.workflow_id = pd.workflow_id and pd.customer_division_imprint_id in ('447','369') and pd.project_id <= '" & rs_iwo.Fields("project_id") & "' " & _
        "UNION " & _
        "select count(project_id)as proj_cnt, year(pd.date_on) as date_on from workflow.project_details pd, ems.team_customer tc where pd.date_on >= timestamp(concat(year(current_date())-1,'-01-01 00:00:00'),'05:30') and tc.team_id = '131' and tc.customer_division_imprint_id = pd.customer_division_imprint_id and tc.workflow_id = pd.workflow_id and pd.customer_division_imprint_id in ('447','369') and pd.project_id <= '" & rs_iwo.Fields("project_id") & "') as temp where temp.proj_cnt>0", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
            If rsTitleCnt.RecordCount > 0 Then
                title_count = rsTitleCnt.Fields("proj_cnt")
                year_id = rsTitleCnt.Fields("date_on")
                rsTitleCnt.Close
            Else
                title_count = ""
                year_id = ""
                rsTitleCnt.Close
            End If
        End If
        
        'Based on Arun request, excluded LARGEPRINT, DANTE product type and Hachette Book Group Perseus Customer IWO schedule on 14-Sep-2018
        If (wo_type = "iwo" And CInt(rs_iwo.Fields("team_id")) = "36") Then
             If InStr(1, product_id, "8") Or InStr(1, product_id, "129") Or InStr(1, product_id, "130") Or InStr(1, product_id, "131") Or InStr(1, product_id, "132") Or InStr(1, product_id, "133") Or CInt(rs_iwo.Fields("customer_division_imprint_id")) = 424 Then
             
             rsVault.Open "select customer_id from lgms.customer_division_imprint cdi where cdi.customer_division_imprint_id = '" & rs_iwo.Fields("customer_division_imprint_id") & "' and cdi.customer_id = '37'", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                    
                If rsVault.RecordCount > 0 Then
                    rsVault.Close
                    GoTo exi
                Else
                    rsVault.Close
                End If
             End If
        End If
        
        'Based on Jeeva request(TF00017918)
        If (CInt(rs_iwo.Fields("team_id")) = "4" Or CInt(rs_iwo.Fields("team_id")) = "91") Then
            If IsNull(sub_pname) Or sub_pname = "" Then
                sub_pname = "NA"
            End If
        End If

        If CInt(rs_iwo.Fields("cycle_number")) > 0 Then
        cycle_number = rs_iwo.Fields("cycle_number")
        deliverable_label = rs_iwo.Fields("deliverable_label") & " " & cycle_number
        Else
        cycle_number = rs_iwo.Fields("cycle_number")
        deliverable_label = rs_iwo.Fields("deliverable_label")
        End If

        If wo_type = "iwo" Then
            If CInt(rs_iwo.Fields("batch_number")) > 0 Then
            batch_number = CInt(rs_iwo.Fields("batch_number"))
            Else
            batch_number = ""
            End If
        ElseIf rs_iwo.Fields("batch_number") <> "" Then
        batch_number = rs_iwo.Fields("batch_number")
        Else
        batch_number = ""
        End If
        
        If IsNull(rs_iwo.Fields("comments")) Then comments = "" Else comments = rs_iwo.Fields("comments")
        
        If wo_type = "iwo" Then
'            If OptionButton1.Value = True Then
project_id_test = rs_iwo.Fields("project_id")
            If project_id_test = "320802" Then
            MsgBox rs_iwo.Fields("project_id")
            End If
                'Receipt date
                If Not IsNull(rs_iwo.Fields("receipt_date_sas")) Then
                
                    str2 = rs_iwo.Fields("receipt_date_sas")
                    
                    sas_id = CInt(rs_iwo.Fields("stage_id"))

                    'Commented SAS ID = 6 based on Panner request on 30-Sep-16.
                    'If SAS_ID = 6 Then
                    
'                    If CInt(rs_iwo.Fields("workflow_id")) = 7 Then 'Hachette Composition - Hardcoded 'Finals' SAS due to improper workflow sequence definition in Texflow. By Boopathi on 3-Feb-2015
'                    receipt_date_sas = rs_iwo.Fields("receipt_date_sas") & ",1013"
'                    Else
'                    receipt_date_sas = rs_iwo.Fields("receipt_date_sas")
'                    End If
                    
                    'Commented SAS ID = 6 based on Panner request on 30-Sep-16.
                    'rs_receipt_date.Open "select workorder_id, TIMESTAMP(date_in,'05:30') as end_date, TIMESTAMP(date_in,'" & rs_iwo.Fields("timezone_value") & "') as est_end_date from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                    "and wd.stage_activity_step_id in (" & rs_iwo.Fields("receipt_date_sas") & ") and wd.status_id <> 30 and cycle_number='" & rs_iwo.Fields("cycle_number") & "' order by workorder_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                    
                    'Else
                    
'                    Commented SAS ID = 6 based on Jeeva request on 6-Feb-2020.
                    If sas_id = 6 And CInt(rs_iwo.Fields("workflow_id")) = 4 And (CInt(rs_iwo.Fields("team_id")) = "4" Or CInt(rs_iwo.Fields("team_id")) = "91") Then 'Trade - Hardcoded 'Finals' SAS due to improper workflow sequence definition in Texflow. By Boopathi on 2-Mar-2020
                    receipt_date_sas = rs_iwo.Fields("receipt_date_sas") & ",1994"
                    
                    rs_receipt_date.Open "select workorder_id, TIMESTAMP(date_in,'05:30') as end_date, TIMESTAMP(date_in,'" & rs_iwo.Fields("timezone_value") & "') as est_end_date from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                    "and wd.stage_activity_step_id in (" & receipt_date_sas & ") and wd.status_id <> 30 and cycle_number='" & rs_iwo.Fields("cycle_number") & "' order by workorder_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                                       
                   'Hardcoded 'Castoff' SAS due to Revised CastOff IRD Capture - Updated by Boopathi on 30-Jul-2018.
                    ElseIf deliverable_label = "Revised Castoff" And (CInt(rs_iwo.Fields("team_id")) = "4" Or CInt(rs_iwo.Fields("team_id")) = "91") Then
                    
                    createdOn = rs_iwo.Fields("created_on")
                    createdOn = format(createdOn, "yyyy-mm-dd hh:mm:ss")
                    
                    'rs_receipt_date.Open "select convert(TIMESTAMP('" & createdOn & "','05:30') using utf8) as end_date, convert(TIMESTAMP('" & createdOn & "','" & rs_iwo.Fields("timezone_value") & "')using utf8) as est_end_date from dual", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                    rs_receipt_date.Open "select convert(TIMESTAMP(p.created_on,'05:30') using utf8) as end_date, convert(TIMESTAMP(p.created_on,'" & rs_iwo.Fields("timezone_value") & "')using utf8) as est_end_date from workflow.project_deliverables_schedule_details p where p.project_id = '" & rs_iwo.Fields("project_id") & "' and p.stage_activity_step_id = '" & rs_iwo.Fields("delivery_date_sas") & "' " & _
                    "and p.version_id in (select (p1.version_id+0.1) from workflow.project_deliverables_schedule_details_history p1 where p1.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                    "and p1.stage_activity_step_id = '" & rs_iwo.Fields("delivery_date_sas") & "')", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                                       
                                       
                    createdOn = ""
                                       
                    ElseIf (CInt(rs_iwo.Fields("team_id")) = "58" Or CInt(rs_iwo.Fields("team_id")) = "92") And sas_id = 6 Then 'HARDCODED AS REQUESTED BY SUBASH based on TF00020347

                    receipt_date_sas = rs_iwo.Fields("receipt_date_sas") & ",999"
                    
                    rs_receipt_date.Open "select workorder_id, TIMESTAMP(date_in,'05:30') as end_date, TIMESTAMP(date_in,'" & rs_iwo.Fields("timezone_value") & "') as est_end_date from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                    "and wd.stage_activity_step_id in (" & receipt_date_sas & ") and wd.status_id <> 30 and cycle_number='" & rs_iwo.Fields("cycle_number") & "' order by workorder_id asc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText


                    Else
                    
                    rs_receipt_date.Open "select workorder_id, TIMESTAMP(end_date,'05:30') as end_date, TIMESTAMP(end_date,'" & rs_iwo.Fields("timezone_value") & "') as est_end_date from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                    "and wd.stage_activity_step_id in ('" & rs_iwo.Fields("receipt_date_sas") & "') and wd.status_id = 50 and cycle_number='" & rs_iwo.Fields("cycle_number") & "' order by workorder_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                    
                    'Debug.Print "select workorder_id, TIMESTAMP(end_date,'05:30') as end_date, TIMESTAMP(end_date,'" & rs_iwo.Fields("timezone_value") & "') as est_end_date from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                    "and wd.stage_activity_step_id in ('" & rs_iwo.Fields("receipt_date_sas") & "') and wd.status_id = 50 and cycle_number='" & rs_iwo.Fields("cycle_number") & "' order by workorder_id desc limit 1"
                    
                    
                    End If
                    
                    If rs_receipt_date.RecordCount > 0 Then
                        If CInt(rs_iwo.Fields("timezone_id")) = 49 Then
                        receipt_date = rs_receipt_date.Fields("end_date")
                        Else
                        receipt_date = rs_receipt_date.Fields("est_end_date")
                        End If
                    Else
                    receipt_date = ""
                    End If
                rs_receipt_date.Close
                Else
                receipt_date = ""
                End If
                'end receipt date
'            Else
'                If CInt(rs_iwo.Fields("timezone_id")) = 49 Then
'                receipt_date = rs_iwo.Fields("ist_receipt_date")
'                Else
'                receipt_date = rs_iwo.Fields("est_receipt_date")
'                End If
'            End If
            
            'HARDCODED BASED ON JEEVA AND SATHISHKUMAR JAYARAMAN REQUEST on 12-JULY-2018
            'VAULT FPP/REV/FINALS/OUTSIDE
            If receipt_date = "" Then
             'If str2 = 920 Or str2 = 943 Or str2 = 2008 Or str2 = 1054 Then
             If InStr(1, str2, "920") Or InStr(1, str2, "943") Or InStr(1, str2, "2008") Or InStr(1, str2, "1054") Then
             GoTo exi
             End If
            End If

        Else
            If CInt(rs_iwo.Fields("timezone_id")) = 49 Then
            receipt_date = rs_iwo.Fields("ist_receipt_date")
            Else
            receipt_date = rs_iwo.Fields("est_receipt_date")
            End If
        End If
        

        If CInt(rs_iwo.Fields("timezone_id")) = 49 Then
        planned_date = format(rs_iwo.Fields("ist_estimate_date"), "yyyy-mm-dd hh:mm:ss AM/PM")
        Else
        planned_date = format(rs_iwo.Fields("est_estimate_date"), "yyyy-mm-dd hh:mm:ss AM/PM")
        End If
                
        timezone_date_format = format(planned_date, "yyyy-mm-dd")
        
        'to handle daylight savings
        If CInt(rs_iwo.Fields("timezone_id")) = 14 Then
        
        rs_timezone_value.Open "select if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6)) as timezone_value from workflow.cfg_datetime_preference_est " & _
        "where date('" & timezone_date_format & "') between start_date and end_date", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
        timezone_value = rs_timezone_value.Fields("timezone_value")
        
        rs_timezone_value.Close
        
        ElseIf CInt(rs_iwo.Fields("timezone_id")) = 27 Then
        
        rs_timezone_value.Open "select if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6)) as timezone_value from workflow.cfg_datetime_preference_dst " & _
        "where date('" & timezone_date_format & "') between start_date and end_date", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
        timezone_value = rs_timezone_value.Fields("timezone_value")
        
        rs_timezone_value.Close
        
        Else
        
        timezone_value = rs_iwo.Fields("timezone_value")
        
        End If
        
'        If wo_type = "iwo" Then
        'Planned Date Start - for daylight savings update - Temporary fix - This block has to be removed once datetime picker in Texflow has been handled with future daylight savings.
        If CInt(rs_iwo.Fields("timezone_id")) = 14 Then
            planned_date = rs_iwo.Fields("planned_date")
            planned_date = format(planned_date, "yyyy-mm-dd hh:mm:ss")
            created_on = rs_iwo.Fields("created_on")
            created_on = format(created_on, "yyyy-mm-dd hh:mm:ss")
            rs_planned_date.Open "select convert(timestamp('" & planned_date & "',(select if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6)) as timezone_value from workflow.cfg_datetime_preference_est " & _
            "where date('" & created_on & "') between start_date and end_date)) using utf8) as planned_date from dual", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                    
                    If rs_planned_date.RecordCount > 0 Then
                        planned_date = rs_planned_date.Fields("planned_date")
                        planned_date = format(planned_date, "yyyy-mm-dd hh:mm:ss AM/PM")
                    End If
            rs_planned_date.Close
        ElseIf CInt(rs_iwo.Fields("timezone_id")) = 27 Then
            planned_date = rs_iwo.Fields("planned_date")
            planned_date = format(planned_date, "yyyy-mm-dd hh:mm:ss")
            created_on = rs_iwo.Fields("created_on")
            created_on = format(created_on, "yyyy-mm-dd hh:mm:ss")
            rs_planned_date.Open "select convert(timestamp('" & planned_date & "',(select if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6)) as timezone_value from workflow.cfg_datetime_preference_dst " & _
            "where date('" & created_on & "') between start_date and end_date)) using utf8) as planned_date from dual", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                    
                    If rs_planned_date.RecordCount > 0 Then
                        planned_date = rs_planned_date.Fields("planned_date")
                        planned_date = format(planned_date, "yyyy-mm-dd hh:mm:ss AM/PM")
                    End If
            rs_planned_date.Close
        End If
        'Planned Date End
'        Else
'
'        End If
        
        If wo_type = "iwo" Then
            'Delivered date
            If Not IsNull(rs_iwo.Fields("delivery_date_sas")) Then
               
                rs_deliver_date.Open "select workorder_id, TIMESTAMP(end_date,'05:30') as end_date, timestamp(end_date,'" & timezone_value & "') as est_end_date from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                "and wd.project_id <> ifnull((select project_id from workflow.project_deliverables_schedule_details_history pdsh where pdsh.project_id = '" & rs_iwo.Fields("project_id") & "' and pdsh.stage_activity_step_id = '" & rs_iwo.Fields("delivery_date_sas") & "' and cycle_number='" & rs_iwo.Fields("cycle_number") & "' limit 1),1) " & _
                "and wd.stage_activity_step_id = '" & rs_iwo.Fields("delivery_date_sas") & "' and wd.status_id = 50 and cycle_number='" & rs_iwo.Fields("cycle_number") & "' order by workorder_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                
                If rs_deliver_date.RecordCount > 0 Then
                    delivered_date = format(rs_deliver_date.Fields("end_date"), "yyyy-mm-dd hh:mm:ss AM/PM")
                    est_delivered_date = format(rs_deliver_date.Fields("est_end_date"), "yyyy-mm-dd hh:mm:ss AM/PM")
                    actual_end_time = Right(delivered_date, 11)
                    actual_end_time_est = Right(est_delivered_date, 11)
                ElseIf (CInt(rs_iwo.Fields("team_id")) = "99" And CInt(rs_iwo.Fields("workflow_id")) = "66") Then
                    delivered_date = ""
                    est_delivered_date = ""
                    actual_end_time = ""
                    actual_end_time_est = ""
                Else
                    delivered_date = rs_iwo.Fields("ist_completed_date")
                    est_delivered_date = rs_iwo.Fields("est_completed_date")
                    actual_end_time = rs_iwo.Fields("ist_completed_time")
                    actual_end_time_est = rs_iwo.Fields("est_completed_time")
                End If
            rs_deliver_date.Close
            Else
                delivered_date = ""
                est_delivered_date = ""
                actual_end_time = ""
                actual_end_time_est = ""
            End If
            'end delivered date
        Else
            'for EWO
            rs_deliver_date.Open "select external_workorder_id, TIMESTAMP(end_time,'05:30') as end_date, timestamp(end_time,'" & timezone_value & "') as est_end_date from workflow.external_workorder_details ewd where ewd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                "and ewd.external_workorder_id = '" & rs_iwo.Fields("external_workorder_id") & "' and ewd.status_id = 50 and ewd.cycle_id='" & rs_iwo.Fields("cycle_number") & "' order by external_workorder_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                
            If rs_deliver_date.RecordCount > 0 Then
                delivered_date = format(rs_deliver_date.Fields("end_date"), "yyyy-mm-dd hh:mm:ss AM/PM")
                est_delivered_date = format(rs_deliver_date.Fields("est_end_date"), "yyyy-mm-dd hh:mm:ss AM/PM")
                actual_end_time = Right(delivered_date, 11)
                actual_end_time_est = Right(est_delivered_date, 11)
            Else
                delivered_date = rs_iwo.Fields("ist_completed_date")
                est_delivered_date = rs_iwo.Fields("est_completed_date")
                actual_end_time = rs_iwo.Fields("ist_completed_time")
                actual_end_time_est = rs_iwo.Fields("est_completed_time")
            End If
            rs_deliver_date.Close
            
        End If
        
        If CInt(rs_iwo.Fields("timezone_id")) = 49 Then
        comp_date = delivered_date
        Else
        comp_date = est_delivered_date
        End If
        
        If comp_date <> "" Then
            If CInt(rs_iwo.Fields("timezone_id")) = 49 Then
            actual_end = format(actual_end_time, "HH:mm:ss")
            Else
            actual_end = format(actual_end_time_est, "HH:mm:ss")
            End If
        Else
        actual_end = ""
        End If
        
        timezone = rs_iwo.Fields("timezone")
               
        If rs_iwo.Fields("force_time_delivery") = "y" Then
        cutoff_time = format(Right(planned_date, 11), "HH:mm:ss")
        Else
        cutoff_time = format(rs_iwo.Fields("cutoff_time") & ":00", "HH:mm:ss")
        End If

        'Status
        If comp_date <> "" Then
            If format(comp_date, "YYYY-MM-DD") > format(planned_date, "YYYY-MM-DD") Then
            
                Status = "Delay"
            
            ElseIf format(comp_date, "YYYY-MM-DD") < format(planned_date, "YYYY-MM-DD") Then
            
                Status = "Ahead"
            
            ElseIf format(comp_date, "YYYY-MM-DD") = format(planned_date, "YYYY-MM-DD") Then
            
                If TimeEarlierThan(actual_end, cutoff_time) = True Then
                    Status = "On Time"
                Else
                    Status = "Delay"
                End If
            
            End If
        Else
            
            Status = "WIP"
        
        End If
        
        If CheckBox2.Value = True Then
            If Status <> "WIP" Then
                If CInt(rs_iwo.Fields("team_id")) = "4" Or CInt(rs_iwo.Fields("team_id")) = "91" Or CInt(rs_iwo.Fields("team_id")) = "58" Or CInt(rs_iwo.Fields("team_id")) = "92" _
                Or CInt(rs_iwo.Fields("team_id")) = "46" Or CInt(rs_iwo.Fields("team_id")) = "93" Or CInt(rs_iwo.Fields("team_id")) = "36" Or CInt(rs_iwo.Fields("team_id")) = "99" Or CInt(rs_iwo.Fields("team_id")) = "146" Then
                    Status = "Delivered"
                End If
            End If
        End If
    

        If rs_iwo.Fields("force_time_delivery") = "y" Then
        force_time_delivery = "Yes"
        Else
        force_time_delivery = ""
        End If
        
        If IsNull(rs_iwo.Fields("reason_code")) Then reason_code = "" Else reason_code = rs_iwo.Fields("reason_code")
        
        If wo_type = "iwo" Then
            'Complexity
            rs_complexity.Open "select vir_complexity_id, vir_complexity_name, vir_complexity_query " & _
            "from workflow.cfg_vir_complexity_mapping c where vir_complexity_id = '" & rs_iwo.Fields("complexity_mapping_id") & "' limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
            
            If rs_complexity.RecordCount > 0 Then
            
            str1 = rs_complexity.Fields("vir_complexity_query")
            
            Set cmd.ActiveConnection = con_rep
            str1 = Replace(str1, "<projectid>", rs_iwo.Fields("project_id"))
            cmd.CommandText = str1
            'MsgBox str1
            cmd.CommandType = adCmdText
            
            Set rs_label = cmd.Execute
            
                If rs_label.RecordCount > 0 Then
                
                complexity = rs_label.Fields("complexity")
                
                End If
            End If
            rs_complexity.Close
            'Complexity End
        Else
            complexity = rs_iwo.Fields("complexity")
        End If
        
        
        If (CInt(rs_iwo.Fields("team_id")) = "131") Then
        
        rs_JG_Complexity.Open "select if(c.complexity_level_id between 100 and 120,concat('Level',' ',c.complexity_level_name,' (Approved)'), " & _
        "concat(c.complexity_level_name,' (Approved)')) as complexity " & _
        "from lgms.cfg_complexity_level  c where " & _
        "c.complexity_level_id=(SELECT p.approved_complexity_level_id FROM workflow.project_complexity_approval p " & _
        "where p.project_id='" & rs_iwo.Fields("project_id") & "' and p.category_id=1 and p.approval_type_id=1 and p.approval_status_id=1 " & _
        "and p.version_id=(select max(pca.version_id) from workflow.project_complexity_approval pca " & _
        "where pca.project_id = p.project_id And pca.category_id = p.category_id " & _
        "and pca.approval_status_id=p.approval_status_id and p.approval_type_id=pca.approval_type_id) limit 1) " & _
        "Union " & _
        "select if(c.complexity_level_id between 100 and 120,concat('Level',' ',c.complexity_level_name), " & _
        "c.complexity_level_name) as customer_composition_complexity " & _
        "from lgms.cfg_complexity_level c " & _
        "where c.complexity_level_id=(SELECT customer_complexity_level_id  FROM workflow.budget_estimate be, " & _
        "workflow.budget_estimate_service_item_mapping b, lgms.service_item_activity_mapping siam, lgms.cfg_service_item csi " & _
        "where be.project_id='" & rs_iwo.Fields("project_id") & "' and be.version_id = (select max(be1.version_id) from workflow.budget_estimate be1 " & _
        "where be.project_id=be1.project_id) and b.budget_estimate_id= be.budget_estimate_id " & _
        "and siam.service_item_id=b.service_item_id and b.service_item_id = csi.service_item_id " & _
        "and siam.activity_id=18 order by composition_priority_no limit 1) limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
            If rs_JG_Complexity.RecordCount > 0 Then
            
            complexity = rs_JG_Complexity.Fields("complexity")
            
            End If
        
        rs_JG_Complexity.Close
        
        End If
        
        
        If wo_type = "iwo" Then
            'MS Pages
            rs_ms_pages.Open "select vir_input_units_id, vir_input_units_name, vir_input_units_query " & _
            "from workflow.cfg_vir_input_units_mapping c where vir_input_units_id = '" & rs_iwo.Fields("ms_pages_mapping_id") & "' limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
            
            If rs_ms_pages.RecordCount > 0 Then
            
            str1 = rs_ms_pages.Fields("vir_input_units_query")
            
            Set cmd.ActiveConnection = con_rep
            str1 = Replace(str1, "<projectid>", rs_iwo.Fields("project_id"))
            str1 = Replace(str1, "<cycle>", rs_iwo.Fields("cycle_number"))
            cmd.CommandText = str1
            'MsgBox str1
            cmd.CommandType = adCmdText
            
            Set rs_ms_pages_label = cmd.Execute
            
                If rs_ms_pages_label.RecordCount > 0 Then
                
                ms_pages = rs_ms_pages_label.Fields("page_count")
                
                End If
            End If
            rs_ms_pages.Close
            'MS Pages End
        Else
            ms_pages = rs_iwo.Fields("input_units")
        End If
        
        If wo_type = "iwo" Then
            'Delivered Pages
            rs_del_pages.Open "select vir_output_units_id, vir_output_units_name, vir_output_units_query " & _
            "from workflow.cfg_vir_output_units_mapping c where vir_output_units_id = '" & rs_iwo.Fields("delivered_pages_mapping_id") & "' limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
            
            If rs_del_pages.RecordCount > 0 Then
            
            str1 = rs_del_pages.Fields("vir_output_units_query")
            
            Set cmd.ActiveConnection = con_rep
            str1 = Replace(str1, "<projectid>", rs_iwo.Fields("project_id"))
            str1 = Replace(str1, "<stageid>", rs_iwo.Fields("stage_id"))
            str1 = Replace(str1, "<cycle>", rs_iwo.Fields("cycle_number"))
            cmd.CommandText = str1
            'MsgBox str1
            cmd.CommandType = adCmdText
            
            Set rs_del_pages_label = cmd.Execute
            
                If rs_del_pages_label.RecordCount > 0 Then
                
                del_pages = rs_del_pages_label.Fields("page_count")
                
                End If
            End If
            rs_del_pages.Close
            'Delivered Pages End
        Else
        
            'Hardcoded for PUS Composition Net Galley epub request given to XML Team from JNA on 8-Jun-2016.
            stage_id = CInt(rs_iwo.Fields("stage_id"))
            activity_id = CInt(rs_iwo.Fields("activity_id"))
            step_id = CInt(rs_iwo.Fields("step_id"))
            
            If CInt(rs_iwo.Fields("workflow_id")) = 8 And stage_id = 14 And activity_id = 57 And step_id = 386 Then
            
                rs_del_pages.Open "select page_count " & _
                "from workflow.phase1_page_count_entity p,workflow.cfg_stages cs " & _
                "where p.project_id='" & rs_iwo.Fields("project_id") & "' and cs.stage_id=p.stage_id order by -sequence_no,-p.stage_id,-p.number, -phase1_page_count_entity_id limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                   
                If rs_del_pages.RecordCount > 0 Then
                    del_pages = rs_del_pages.Fields("page_count")
                Else
                    del_pages = rs_iwo.Fields("output_units")
                End If
                rs_del_pages.Close
            
            ElseIf rs_iwo.Fields("inflow_output_unit") > 0 Then
              del_pages = rs_iwo.Fields("inflow_output_unit")
            Else
               del_pages = rs_iwo.Fields("output_units")
            End If
            
        End If

        
        If wo_type = "iwo" Then
            rs_corr_cnt.Open "select project_id from workflow.correction_count_entity where project_id=" & rs_iwo.Fields("project_id") & " " & _
            "and revises_id=" & rs_iwo.Fields("cycle_number") & " and stage_id=" & rs_iwo.Fields("stage_id") & " order by version_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
            
            If rs_corr_cnt.RecordCount > 0 Then
            cnt = "Yes"
            Else
            cnt = "No"
            End If
            rs_corr_cnt.Close
        Else
            If rs_iwo.Fields("corrections_count_required") = "y" Then
            cnt = "Yes"
            Else
            cnt = "No"
            End If
        End If

        If IsNull(rs_iwo.Fields("customer_contact")) Then customer_contact = "" Else customer_contact = rs_iwo.Fields("customer_contact")
 
        If IsNull(rs_iwo.Fields("pm_pc")) Then pm_pc = "" Else pm_pc = rs_iwo.Fields("pm_pc")
        
        If IsNull(rs_iwo.Fields("csr_name")) Then csr_name = "" Else csr_name = rs_iwo.Fields("csr_name")
        
        'Composition
        If CInt(rs_iwo.Fields("workflow_id")) = "3" Or CInt(rs_iwo.Fields("team_id")) = "5" Then
        rs_comp.Open "select project_id,(select group_concat(vendor_id) from finance.purchase_order_details pod,finance.purchase_order_service_item_mapping posim " & _
        "where pod.project_id=pd.project_id and posim.purchase_order_id=pod.purchase_order_id) as vendor_id,(select group_concat(service_item_id) from finance.purchase_order_details pod, " & _
        "finance.purchase_order_service_item_mapping posim where pod.project_id=pd.project_id and posim.purchase_order_id=pod.purchase_order_id) as service_id from workflow.project_details pd " & _
        "where pd.project_id = " & rs_iwo.Fields("project_id") & " and (select group_concat(service_item_id) from finance.purchase_order_details pod, finance.purchase_order_service_item_mapping posim where pod.project_id=pd.project_id and posim.purchase_order_id=pod.purchase_order_id) " & _
        "in (select service_item_id from lgms.cfg_service_item where service_item_name like '%composition%')", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        If rs_comp.RecordCount > 0 Then
        composition = "Vendor"
        rs_comp.Close
        Else
        composition = "Jouve India"
        rs_comp.Close
        End If
        Else
        composition = "Jouve India"
        End If
        
        billing_status = rs_iwo.Fields("billing_status")
        
        est_distro_date = rs_iwo.Fields("est_distro_date")
        
        'Embargoed
        If rs_iwo("is_embargoed") = "y" Then
        is_embargoed = "Yes"
        Else
        is_embargoed = ""
        End If
        
        If rs_iwo.Fields("isbn") <> "" Then
            isbn = rs_iwo.Fields("isbn")
        Else
            isbn = ""
        End If
        
        If rs_iwo.Fields("workorder_type") <> "" Then
            workorder_type = rs_iwo.Fields("workorder_type")
        Else
            workorder_type = ""
        End If
        
        If rs_iwo.Fields("designer_contact") <> "" Then
            designer_contact = rs_iwo.Fields("designer_contact")
        Else
            designer_contact = ""
        End If
        
        If rs_iwo.Fields("prh_team") <> "" Then
            prh_team = rs_iwo.Fields("prh_team")
        Else
            prh_team = ""
        End If
              
        If Status = "Delay" Then
        
        'Delay-Color Code (RED)
        Sheet1.Rows(row_inv).Select
        Selection.font.ColorIndex = 3
        
        diff_mins = DateDiff("n", planned_date, comp_date)
            If diff_mins <= 30 Then
            t1 = t1 + 1
            Msg = "< 30 Mins"
            ElseIf diff_mins > 30 And diff_mins <= 60 Then
            t2 = t2 + 1
            Msg = "30 Mins - 1 Hour"
            ElseIf diff_mins > 60 And diff_mins <= 120 Then
            t3 = t3 + 1
            Msg = "1 Hour - 2 Hours"
            ElseIf diff_mins > 120 And diff_mins <= 180 Then
            t4 = t4 + 1
            Msg = "2 Hours - 3 Hours"
            ElseIf diff_mins > 180 And diff_mins <= 240 Then
            t5 = t5 + 1
            Msg = "3 Hours - 4 Hours"
            ElseIf diff_mins > 240 And diff_mins <= 300 Then
            t6 = t6 + 1
            Msg = "4 Hours - 5 Hours"
            ElseIf diff_mins > 300 And diff_mins <= 360 Then
            t7 = t7 + 1
            Msg = "5 Hours - 6 Hours"
            ElseIf diff_mins > 360 Then
            t8 = t8 + 1
            Msg = "> 6 Hours"
            End If
            
        project_name = rs_iwo.Fields("project_id") & " " & rs_iwo.Fields("project_name")
        If rs_iwo.Fields("reason_code") = "" Or IsNull(rs_iwo.Fields("reason_code")) Then reason_code = "" Else reason_code = rs_iwo.Fields("reason_code")
        'reason_code = rs_iwo.Fields("reason_code")
        If rs_iwo.Fields("comments") = "" Or IsNull(rs_iwo.Fields("comments")) Then comments = "" Else comments = rs_iwo.Fields("comments")
        'comments = rs_iwo.Fields("comments")
        delay_cnter = delay_cnter + 1
        
        
        If CheckBox1.Value = True Then
        Call summary(project_name, deliverable_label, Msg, delay_cnter, reason_code, comments)
        End If
        
        project_name = rs_iwo.Fields("project_name")
        
        End If
                
        'Completed - Color Code (Yellow)
        If comp_date <> "" Then
            Sheet1.Rows(row_inv).Select
            Selection.Interior.ColorIndex = 6
        End If

'Commented on 26-Jul-2016
'        'Overdue Color Code (Red)
'        If (IsNull(comp_date) Or comp_date = "") And Format(planned_date, "yyyy-mm-dd") < Format(Now(), "yyyy-mm-dd") Then
'            Sheet1.Rows(row_inv).Select
'            Selection.Font.ColorIndex = 3
'        End If
        
'Added on 26-Jul-2016 to Capture color coded based on the timezone
        'Overdue Color Code (Red)
        curr_time = ""
        curr_date = ""
        If (Left(timezone_value, 1)) = "-" Then
        curr_time = Replace(timezone_value, "-", "")
        curr_time = CInt(Left(curr_time, 2)) * 60 + CInt(Right(curr_time, 2))
        curr_time = "-" & curr_time
        ElseIf (Left(timezone_value, 1)) = "+" Then
        curr_time = Replace(timezone_value, "+", "")
        curr_time = CInt(Left(curr_time, 2)) * 60 + CInt(Right(curr_time, 2))
        ElseIf timezone_value <> "" Then
        curr_time = Replace(timezone_value, "+", "")
        curr_time = CInt(Left(curr_time, 2)) * 60 + CInt(Right(curr_time, 2))
        End If
        
        curr_date = format(DateAdd("n", curr_time, Now()), "yyyy-mm-dd")
        If (IsNull(comp_date) Or comp_date = "") And format(planned_date, "yyyy-mm-dd") < format(curr_date, "yyyy-mm-dd") Then
            Sheet1.Rows(row_inv).Select
            Selection.font.ColorIndex = 3
        End If
        
        If CInt(rs_iwo.Fields("is_onhold")) = "2" Then
            Sheet1.Rows(row_inv).Select
            Selection.Interior.ColorIndex = 22
        End If
        
        If wo_type = "ewo" Then
            If CInt(rs_iwo.Fields("status_id")) = "30" Then
                Sheet1.Rows(row_inv).Select
                Selection.Interior.ColorIndex = 22
            End If
        End If
        
        rs_query.Open "select * from roundup._issue where project_id = " & rs_iwo.Fields("project_id") & "  and _status not in (7,8) and issue_type_id=1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
        If rs_query.RecordCount > 0 Then
        query_flag = 1
        Else
        query_flag = 0
        End If
        rs_query.Close
        
        'Query Color Code
        If (IsNull(comp_date) Or comp_date = "") And query_flag = 1 Then
            Status = "Query"
            Sheet1.Rows(row_inv).Select
            Selection.Interior.ColorIndex = 44
        End If
        
        'Hardcoded for Trade US/Pre-Post team to Truncate Time Details for India Due Date Column on 28-Mar-2016
        'If CInt(rs_iwo.Fields("team_id")) = "4" Or CInt(rs_iwo.Fields("team_id")) = "91" Then
        If InStr(1, sTemp, "'4'") Or InStr(1, sTemp, "'91'") Then
        planned_date = format(Left(planned_date, 10), "yyyy-mm-dd")
        End If
        
        'Sample Castoff Approval check for TUK Team START
        If InStr(1, sTemp, "'58'") Or InStr(1, sTemp, "'92'") Then
        
        rs_query_approval.Open "select workorder_id from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "'  and wd.status_id not in (50,30) and wd.stage_activity_step_id = '1333' limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
        'rs_query_approval.Open "select approved_by_customer from workflow.puk_email_approval_details where project_id = '" & rs_iwo.Fields("project_id") & "'  order by puk_email_approval_details_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
        samplecastoff_flag = 0
        If rs_query_approval.RecordCount > 0 Then
            'If rs_query_approval.Fields("approved_by_customer") = "y" Then
            samplecastoff_flag = 1
        Else
            samplecastoff_flag = 0
            'End If
        End If
        rs_query_approval.Close
        
        'Sample Castoff Approval Color Code TUK Team
        If (InStr(1, deliverable_label, "FPP", vbTextCompare) Or InStr(1, deliverable_label, "First Proofs", vbTextCompare)) And samplecastoff_flag = 1 And comp_date = "" Then
            If IsNull(Status) Or Status = "" Then
                Status = "Sample Castoff Not Yet Approved"
            Else
            Status = Status & " and " & "Sample Castoff Not Yet Approved"
            End If
            Sheet1.Rows(row_inv).Select
            Selection.Interior.ColorIndex = 28
        End If
        
        End If
        'Sample Castoff Approval check for TUK Team END
         
qry_proj = "pd.project_id = '" & rs_iwo.Fields("project_id") & "'"

qry_stage = "s.stage_id = '" & rs_iwo.Fields("stage_id") & "'"
qry_cycle = "wd.cycle_number = '" & rs_iwo.Fields("cycle_number") & "'"

qry_stage_ewo = "wd.stage_id = '" & rs_iwo.Fields("stage_id") & "'"
qry_cycle_ewo = "wd.cycle_id = '" & rs_iwo.Fields("cycle_number") & "'"
        
If wo_type = "iwo" Then

    If (InStr(1, deliverable_label, "Vault", vbTextCompare) Or InStr(1, deliverable_label, "Spine", vbTextCompare)) Then
    
    GoTo jum:
    
    Else
            
        If (sTemp = "'36'" Or sTemp = "'146'") Then
        
        rs_sch.Open "select pd.project_id, pd.project_name, pd.workflow_id, (concat_ws(' ',(select customer_name from lgms.customer_details c where c.customer_id=cdi.customer_id), (select division_name from lgms.division_details c where c.division_id=cdi.division_id), (select imprint_name from lgms.imprint_details c where c.imprint_id=cdi.imprint_id))) as Customer, " & _
        "pt.product_name, if(wd.stage_activity_step_id in (2303,2505,1061,827,765), Ifnull((select if(cl.complexity_level_id between 100 and 120,concat('Level',' ',cl.complexity_level_name) ,cl.complexity_level_name) from lgms.cfg_complexity_level cl where cl.complexity_level_id =(select complexity_level_id from workflow.xml_job_analysis xja where xja.project_id = pd.project_id " & _
        "order by version_id desc limit 1)),(select if(cl.complexity_level_id between 100 and 120,concat('Level',' ',cl.complexity_level_name) ,cl.complexity_level_name) from lgms.cfg_complexity_level cl where cl.complexity_level_id =(select complexity_level_id from workflow.backlist_file_analysis bfa where bfa.project_id = pd.project_id limit 1))), ifnull((select if(c.complexity_level_id between 100 and 120,concat('Level','',c.complexity_level_name), c.complexity_level_name) " & _
        "from lgms.cfg_complexity_level  c where c.complexity_level_id=(SELECT p.internal_complexity_level_id FROM workflow.project_complexity_mapping p where p.project_id = pd.project_id And p.category_id = 1 and p.version_id=(select max(p1.version_id) from workflow.project_complexity_mapping p1 where p.project_id=p1.project_id and p.category_id=p1.category_id) limit 1) limit 1), (SELECT (select if(cl.complexity_level_id between 100 and 120,concat('Level',' ',complexity_level_name),concat(complexity_level_name)) from lgms.cfg_complexity_level cl where cl.complexity_level_id = ifnull(textech_complexity_level_id,customer_complexity_level_id)) " & _
        "FROM workflow.budget_estimate_service_item_mapping b, lgms.cfg_service_item cs, workflow.budget_estimate be where pd.project_id=be.project_id and b.budget_estimate_id=be.budget_estimate_id and be.version_id = (select max(version_id) from workflow.budget_estimate be1 where be1.project_id=be.project_id) and cs.service_item_id=b.service_item_id  and cs.composition_priority_no <> 1000 order by composition_priority_no limit 1)))  as compcmpx, " & _
        "s.stage_id, s.stage_name, wd.cycle_number, convert(if(wd.stage_activity_step_id in (2303,2505,1061,827,765),(Ifnull((select no_of_pages from workflow.xml_job_analysis xja where xja.project_id = pd.project_id order by version_id desc limit 1),(select bfa.no_of_pages from workflow.backlist_file_analysis bfa where bfa.project_id = pd.project_id limit 1))), (select page_count from workflow.phase1_page_count_entity p where p.project_id = pd.project_id And s.stage_id = p.stage_id and p.number=wd.cycle_number order by -sequence_no,-p.stage_id,-p.number limit 1) " & _
        ") using utf8) as typeset_pages, Ifnull((select blank_pages from workflow.xml_job_analysis xja where xja.project_id = pd.project_id order by version_id desc limit 1),(select blank_pages from workflow.backlist_file_analysis bfa where bfa.project_id = pd.project_id limit 1)) as blank_pages, " & _
        "(select input_type from workflow.cfg_input_type it where it.input_type_id = (select Ifnull((select input_file_id from workflow.xml_job_analysis xja " & _
        "where xja.project_id = pd.project_id order by version_id desc limit 1), " & _
        "(select input_type_id from workflow.backlist_file_analysis bfa where bfa.project_id = pd.project_id limit 1)))) as input_type, " & _
        "timestamp(wd.start_date,'05:30') as start_date,timestamp((select end_date from workflow.workorder_details pic where pic.project_id=wd.project_id " & _
        "and if(wd.stage_activity_step_id in (873),pic.stage_activity_step_id in (875),if(wd.stage_activity_step_id in (346),pic.stage_activity_step_id in (857),if(wd.stage_activity_step_id in (375),pic.stage_activity_step_id in (934), " & _
        "if(wd.stage_activity_step_id in (2303),pic.stage_activity_step_id in (2303),if(wd.stage_activity_step_id in (2505),pic.stage_activity_step_id in (2505),if(wd.stage_activity_step_id in (1061),pic.stage_activity_step_id in (1061), " & _
        "if(wd.stage_activity_step_id in (827),pic.stage_activity_step_id in (827),if(wd.stage_activity_step_id in (765),pic.stage_activity_step_id in (765),pic.stage_activity_step_id in (955) )))))))) " & _
        "and wd.cycle_number=pic.cycle_number and pic.status_id =50 limit 1),'05:30') as coq_out, wd.employee_assigned_to, concat(tr.fname) as Name, (select team_name from ems.team_member tm, ems.team_details td where tm.team_id=td.team_id and tm.empid =wd.employee_assigned_to and member_type_id=1 limit 1) as vendor_name, " & _
        "(select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_id, " & _
        "(select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_name " & _
        "from workflow.workorder_details wd, workflow.project_details pd, lgms.customer_division_imprint cdi, workflow.cfg_product pt, workflow.cfg_stages s, workflow.cfg_stage_activity_step sas, ems.textech_resources tr where wd.project_id = pd.project_id And pd.project_status_id <> 30 " & _
        "and " & qry_proj & " and " & qry_cust & " and " & qry_wf & " and " & qry_stage & " and " & qry_cycle & " and pd.customer_division_imprint_id= cdi.customer_division_imprint_id and pd.product_id=pt.product_id and wd.stage_activity_step_id=sas.stage_activity_step_id and sas.stage_id=s.stage_id and wd.status_id =50 and wd.stage_activity_step_id in (375, 346, 405, 873,2303,2505,1061,827,765) and wd.employee_assigned_to =tr.empid and (tr.company_id=4 or (tr.company_id = 1 and tr.resource_type_id = 2)) " & _
        "and ((wd.stage_activity_step_id in (873) and wd.approval_counter in (2)) or (wd.stage_activity_step_id in (346) and wd.approval_counter in (2)) or (wd.stage_activity_step_id in (375) and wd.approval_counter in (3)) or (wd.stage_activity_step_id in (405) and wd.approval_counter in (3)) or (wd.stage_activity_step_id in (2303) and wd.approval_counter in (0)) or (wd.stage_activity_step_id in (2505) and wd.approval_counter in (0)) or (wd.stage_activity_step_id in (1061) and wd.approval_counter in (0)) " & _
        "or (wd.stage_activity_step_id in (827) and wd.approval_counter in (0)) or (wd.stage_activity_step_id in (765) and wd.approval_counter in (0)) )", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        'and " & date_qry2 & "
        
        Else
        
        qry_ewo1 = "select pd.project_id, pd.project_name, pd.workflow_id, (concat_ws(' ',(select customer_name from lgms.customer_details c where c.customer_id=cdi.customer_id), (select division_name from lgms.division_details c where c.division_id=cdi.division_id), (select imprint_name from lgms.imprint_details c where c.imprint_id=cdi.imprint_id))) as Customer, " & _
        "pt.product_name, (select product_sub_type_name from workflow.cfg_product_sub_type pst where pst.product_sub_type_id = pd.product_sub_type_id) as product_sub_name, " & _
        "ifnull((select if(c.complexity_level_id between 100 and 120,concat('Level','',c.complexity_level_name), c.complexity_level_name) " & _
        "from lgms.cfg_complexity_level  c where c.complexity_level_id=(SELECT p.internal_complexity_level_id " & _
        "FROM workflow.project_complexity_mapping p where p.project_id = pd.project_id And p.category_id = 1 " & _
        "and p.version_id=(select max(p1.version_id) from workflow.project_complexity_mapping p1 " & _
        "where p.project_id=p1.project_id and p.category_id=p1.category_id) limit 1) limit 1), (SELECT (select if(cl.complexity_level_id between 100 and 120,concat('Level',' ',complexity_level_name),concat(complexity_level_name)) from lgms.cfg_complexity_level cl where cl.complexity_level_id = ifnull(textech_complexity_level_id,customer_complexity_level_id)) " & _
        "FROM workflow.budget_estimate_service_item_mapping b, lgms.cfg_service_item cs, workflow.budget_estimate be where pd.project_id=be.project_id and b.budget_estimate_id=be.budget_estimate_id and be.version_id = (select max(version_id) from workflow.budget_estimate be1 where be1.project_id=be.project_id) and cs.service_item_id=b.service_item_id  and cs.composition_priority_no <> 1000 order by composition_priority_no limit 1)) as compcmpx, " & _
        "s.stage_id, s.stage_name, wd.cycle_number, (select page_count from workflow.phase1_page_count_entity p where p.project_id = pd.project_id And s.stage_id = p.stage_id and p.number=wd.cycle_number order by -sequence_no,-p.stage_id,-p.number limit 1) as typeset_pages, timestamp(wd.start_date,'05:30') as start_date, timestamp((select end_date from workflow.workorder_details pic where pic.project_id=wd.project_id and if(wd.stage_activity_step_id in (873),pic.stage_activity_step_id in (875),if(wd.stage_activity_step_id in (346),pic.stage_activity_step_id in (857),if(wd.stage_activity_step_id in (375),pic.stage_activity_step_id in (934),if(wd.stage_activity_step_id in (470),pic.stage_activity_step_id in (827),if(wd.stage_activity_step_id in (530),pic.stage_activity_step_id in (531),pic.stage_activity_step_id in (955) ))))) and wd.cycle_number=pic.cycle_number and pic.status_id =50 limit 1),'05:30') as coq_out, " & _
        "wd.employee_assigned_to, concat(tr.fname) as Name, (select team_name from ems.team_member tm, ems.team_details td where tm.team_id=td.team_id and tm.empid =wd.employee_assigned_to and member_type_id=1 limit 1) as vendor_name, " & _
        "(select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_id, " & _
        "(select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_name " & _
        "from workflow.workorder_details wd, workflow.project_details pd, lgms.customer_division_imprint cdi, workflow.cfg_product pt, workflow.cfg_stages s, workflow.cfg_stage_activity_step sas, ems.textech_resources tr where wd.project_id = pd.project_id And pd.project_status_id <> 30 " & _
        "and " & qry_proj & " and " & qry_cust & " and " & qry_wf & " and " & qry_stage & " and " & qry_cycle & " and pd.customer_division_imprint_id= cdi.customer_division_imprint_id and pd.product_id=pt.product_id and wd.stage_activity_step_id=sas.stage_activity_step_id and sas.stage_id=s.stage_id and wd.status_id =50 and wd.stage_activity_step_id in (375, 346, 405, 873,470,530) and wd.employee_assigned_to =tr.empid and (tr.company_id=4 or (tr.company_id = 1 and tr.resource_type_id = 2)) and ((wd.stage_activity_step_id in (873) and wd.approval_counter in (2)) or (wd.stage_activity_step_id in (346) and wd.approval_counter in (2)) or (wd.stage_activity_step_id in (375) and wd.approval_counter in (3)) or (wd.stage_activity_step_id in (405) and wd.approval_counter in (3)) or (wd.stage_activity_step_id in (470) and wd.approval_counter in (0)) or (wd.stage_activity_step_id in (530) and wd.approval_counter in (89)) ) "
        
        qry_ewo2 = qry_ewo1
        
        rs_sch.Open qry_ewo2, con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
        'and " & date_qry3 & "
        
        'and (sewo.customer_division_imprint_id in (258) and sewo.customer_standard_ewo_details_id in (69173))
        
        End If
        
        If rs_sch.RecordCount > 0 Then

        vendor_name = rs_sch.Fields("Name")
        
        End If
        
        rs_sch.Close
    
jum:
    
    End If

Else


qry_ewo2 = "select pd.project_id, pd.project_name, pd.workflow_id, (select workflow_name from workflow.workflow_details wd where wd.workflow_id = pd.workflow_id) as workflow_name,(concat_ws(' ',(select customer_name from lgms.customer_details c where c.customer_id=cdi.customer_id), (select division_name from lgms.division_details c where c.division_id=cdi.division_id), (select imprint_name from lgms.imprint_details c where c.imprint_id=cdi.imprint_id))) as Customer, " & _
"pt.product_name, (select product_sub_type_name from workflow.cfg_product_sub_type pst where pst.product_sub_type_id = pd.product_sub_type_id) as product_sub_name, ifnull((select if(c.complexity_level_id between 100 and 120,concat('Level','',c.complexity_level_name), c.complexity_level_name) " & _
"from lgms.cfg_complexity_level  c where c.complexity_level_id=(SELECT p.internal_complexity_level_id " & _
"FROM workflow.project_complexity_mapping p where p.project_id = pd.project_id And p.category_id = 1 " & _
"and p.version_id=(select max(p1.version_id) from workflow.project_complexity_mapping p1 " & _
"where p.project_id=p1.project_id and p.category_id=p1.category_id) limit 1) limit 1), (SELECT (select if(cl.complexity_level_id between 100 and 120,concat('Level',' ',complexity_level_name),concat(complexity_level_name)) from lgms.cfg_complexity_level cl where cl.complexity_level_id = ifnull(textech_complexity_level_id,customer_complexity_level_id)) " & _
"FROM workflow.budget_estimate_service_item_mapping b, lgms.cfg_service_item cs, workflow.budget_estimate be where pd.project_id=be.project_id and b.budget_estimate_id=be.budget_estimate_id and be.version_id = (select max(version_id) from workflow.budget_estimate be1 where be1.project_id=be.project_id) and cs.service_item_id=b.service_item_id  and cs.composition_priority_no <> 1000 order by composition_priority_no limit 1)) as compcmpx, " & _
"s.stage_id, s.stage_name, wd.cycle_id, convert((select page_count from workflow.phase1_page_count_entity p where p.project_id = pd.project_id And s.stage_id = p.stage_id and p.number=wd.cycle_id order by -sequence_no,-p.stage_id,-p.number,-phase1_page_count_entity_id limit 1)using utf8) as typeset_pages , timestamp(wd.start_time,'05:30') as start_date, timestamp((select end_time from workflow.external_workorder_details pic,workflow.cfg_stage_activity_step sas where pic.project_id=wd.project_id and wd.external_workorder_id = pic.external_workorder_id " & _
"and pic.stage_id = sas.stage_id and pic.activity_id = sas.activity_id and pic.step_id = sas.step_id and " & _
"if(sas.stage_activity_step_id in (827),sas.stage_activity_step_id in (827), if(sas.stage_activity_step_id in (344),sas.stage_activity_step_id in (344), if(sas.stage_activity_step_id in (375),sas.stage_activity_step_id in (375), " & _
"sas.stage_activity_step_id in (827)))) and wd.cycle_id=pic.cycle_id and pic.status_id =50 limit 1),'05:30') as coq_out, " & _
"wd.assigned_to, concat(tr.fname) as Name, (select team_name from ems.team_member tm, ems.team_details td where tm.team_id=td.team_id and tm.empid =wd.assigned_to and member_type_id=1 limit 1) as vendor_name, " & _
"(select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_id, " & _
"(select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_name " & _
"from workflow.external_workorder_details wd, workflow.project_details pd, lgms.customer_division_imprint cdi, workflow.cfg_product pt, workflow.cfg_stages s, workflow.cfg_stage_activity_step sas, ems.textech_resources tr,vms.freelancer_details fd where wd.project_id = pd.project_id And pd.project_status_id <> 30 And fd.freelancer_id = tr.empid And fd.vendor_type_id in (1,2) " & _
"and " & qry_proj & " and " & qry_cust & " and " & qry_wf & " and " & qry_stage_ewo & " and " & qry_cycle_ewo & " " & _
"and wd.stage_id = sas.stage_id and wd.activity_id = sas.activity_id and wd.step_id = sas.step_id " & _
"and pd.customer_division_imprint_id= cdi.customer_division_imprint_id and pd.product_id=pt.product_id and sas.stage_id=s.stage_id and wd.status_id =50 and sas.stage_activity_step_id in (827,344,375) and wd.assigned_to =tr.empid " & _
"and (tr.company_id=4 or (tr.company_id = 1 and tr.resource_type_id = 2)) and (wd.summary= 'AuroTech-XML - Perform XSLT' or wd.summary= 'MightyMinds-XML - Perform XSLT' or wd.summary= 'AuroTech-FPP - Perform FPP' or wd.summary= 'MightyMinds-FPP - Perform FPP' or wd.summary= 'AuroTech-Revises - Perform Revises' or wd.summary= 'MightyMinds-Revises - Perform Revises' or wd.summary= 'ProMicro - Perform FPP' or wd.summary= 'ProMicro-Revises - Perform Revises' or wd.summary= 'Globalen - Perform FPP' or wd.summary= 'Globalen-Revises - Perform Revises') " & _
"and ((sas.stage_activity_step_id in (827) and wd.cycle_id in (0)) or (sas.stage_activity_step_id in (344) and wd.cycle_id in (0)) or (sas.stage_activity_step_id in (375) ) ) "


'#### COMMENTED BY BOOPATHI ON 20-MAR-2020 BASED ON JEEVA REQUEST TH00000316
'qry_ewo2 = "select pd.project_id, pd.project_name, pd.workflow_id, (concat_ws(' ',(select customer_name from lgms.customer_details c where c.customer_id=cdi.customer_id), (select division_name from lgms.division_details c where c.division_id=cdi.division_id), (select imprint_name from lgms.imprint_details c where c.imprint_id=cdi.imprint_id))) as Customer, " & _
"pt.product_name, (select product_sub_type_name from workflow.cfg_product_sub_type pst where pst.product_sub_type_id = pd.product_sub_type_id) as product_sub_name, ifnull((select if(c.complexity_level_id between 100 and 120,concat('Level','',c.complexity_level_name), c.complexity_level_name) " & _
"from lgms.cfg_complexity_level  c where c.complexity_level_id=(SELECT p.internal_complexity_level_id " & _
"FROM workflow.project_complexity_mapping p where p.project_id = pd.project_id And p.category_id = 1 " & _
"and p.version_id=(select max(p1.version_id) from workflow.project_complexity_mapping p1 " & _
"where p.project_id=p1.project_id and p.category_id=p1.category_id) limit 1) limit 1), (SELECT (select if(cl.complexity_level_id between 100 and 120,concat('Level',' ',complexity_level_name),concat(complexity_level_name)) from lgms.cfg_complexity_level cl where cl.complexity_level_id = ifnull(textech_complexity_level_id,customer_complexity_level_id)) " & _
"FROM workflow.budget_estimate_service_item_mapping b, lgms.cfg_service_item cs, workflow.budget_estimate be where pd.project_id=be.project_id and b.budget_estimate_id=be.budget_estimate_id and be.version_id = (select max(version_id) from workflow.budget_estimate be1 where be1.project_id=be.project_id) and cs.service_item_id=b.service_item_id  and cs.composition_priority_no <> 1000 order by composition_priority_no limit 1)) as compcmpx, " & _
"s.stage_id, s.stage_name, wd.cycle_id, (select page_count from workflow.phase1_page_count_entity p where p.project_id = pd.project_id And s.stage_id = p.stage_id and p.number=wd.cycle_id order by -sequence_no,-p.stage_id,-p.number limit 1) as typeset_pages, timestamp(wd.start_time,'05:30') as start_date, timestamp((select end_time from workflow.external_workorder_details pic,workflow.cfg_stage_activity_step sas where pic.project_id=wd.project_id " & _
"and pic.stage_id = sas.stage_id and pic.activity_id = sas.activity_id and pic.step_id = sas.step_id and " & _
"if(sas.stage_activity_step_id in (827),sas.stage_activity_step_id in (827), " & _
"sas.stage_activity_step_id in (827)) and wd.cycle_id=pic.cycle_id and pic.status_id =50 limit 1),'05:30') as coq_out, " & _
"wd.assigned_to, concat(tr.fname) as Name, (select team_name from ems.team_member tm, ems.team_details td where tm.team_id=td.team_id and tm.empid =wd.assigned_to and member_type_id=1 limit 1) as vendor_name, " & _
"(select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_id, " & _
"(select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_name " & _
"from workflow.external_workorder_details wd, workflow.project_details pd, lgms.customer_division_imprint cdi, workflow.cfg_product pt, workflow.cfg_stages s, workflow.cfg_stage_activity_step sas, ems.textech_resources tr where wd.project_id = pd.project_id And pd.project_status_id <> 30 " & _
"and " & qry_proj & " and " & qry_cust & " and " & qry_wf & " and " & qry_stage_ewo & " and " & qry_cycle_ewo & " " & _
"and wd.stage_id = sas.stage_id and wd.activity_id = sas.activity_id and wd.step_id = sas.step_id " & _
"and pd.customer_division_imprint_id= cdi.customer_division_imprint_id and pd.product_id=pt.product_id and sas.stage_id=s.stage_id and wd.status_id =50 and sas.stage_activity_step_id in (827) and wd.assigned_to =tr.empid " & _
"and (tr.company_id=4 or (tr.company_id = 1 and tr.resource_type_id = 2))  and (wd.summary= 'AuroTech-XML - Perform XSLT' or wd.summary= 'MightyMinds-XML - Perform XSLT') " & _
"and ((sas.stage_activity_step_id in (827) and wd.cycle_id in (0)) )"

rs_sch.Open qry_ewo2, con_rep, adOpenKeyset, adLockOptimistic, adCmdText

'"and pd.customer_division_imprint_id = sewo.customer_division_imprint_id " & _
',lgms.customer_standard_ewo_details sewo

If rs_sch.RecordCount > 0 Then

vendor_name = rs_sch.Fields("Name")
        
End If
        
rs_sch.Close

End If
        
       
       'Call value layout proceedure
        Call vir_value_display(sno, customer_name, wf_name, project_id, query_flag, project_name, book_title, pname, sub_pname, workorder_type, deliverable_label, batch_number, comments, receipt_date, planned_date, comp_date, actual_end, timezone, cutoff_time, force_time_delivery, Status, reason_code, complexity, ms_pages, del_pages, cnt, customer_contact, pm_pc, csr_name, composition, est_distro_date, billing_status, isbn, is_embargoed, vendor_name, title_count, year_id, designer_contact, prh_team)
         
        Status = ""
        complexity = ""
        ms_pages = ""
        del_pages = ""
        vendor_name = ""
        deliverable_label = ""
        title_count = ""
        year_id = ""
        
        row_inv = row_inv + 1
        column_inv = 1
        sno = sno + 1
        
exi:
        str2 = ""
        
        record_counter = record_counter + 1
        
        Call progress_bar((record_counter / rs_iwo.RecordCount), rs_iwo.RecordCount)
               
        rs_iwo.MoveNext
        Loop

End If

    If wo_type = "iwo" Then
        If rs_iwo.RecordCount = 0 Then
        progress_status.Caption = "No IWO Records available...!"
        Else
        progress_status.Caption = "IWO Records...Done!" & " (" & rs_iwo.RecordCount & ")"
        progress_status.Caption = "Checking EWO Records..."
        End If
    Else
        If rs_iwo.RecordCount = 0 Then
        progress_status.Caption = "No EWO Records available...!"
        Else
        progress_status.Caption = "EWO Records...Done!" & " (" & rs_iwo.RecordCount & ")"
        End If
    End If
    

End Sub
Sub progress_bar(Width As Variant, rec_count As Variant)

'Update Progress bar width
'PctDone = PctDone + 0.1
LabelProgress.Caption = format(Width, "0%") 'Format(PctDone, "0%")
UpdateProgressBar (204 / rec_count)

End Sub

Public Sub header_field(a)

'Sheet1.activate

If a = 1 Then
desc = "By India Due Date"
ElseIf a = 2 Then
desc = "By India Receipt Date"
End If

Range("D3").Select
ActiveCell.FormulaR1C1 = "Volume Inflow Report - " & desc
    Range("D3:J3").Select
    With Selection
        .HorizontalAlignment = xlCenterAcrossSelection
        .VerticalAlignment = xlBottom
        .WrapText = False
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
    End With
    With Selection.Interior
        .ColorIndex = 9
        .Pattern = xlSolid
    End With
    Selection.font.ColorIndex = 2
    Selection.font.Bold = True
    
If CheckBox1.Value = True Then
    
    Sheet1.activate
    If TextBox1.Text <> "" And TextBox2.Text = "" Then
    ActiveSheet.Range("D4").Value = "From " & format(s1, "mm-dd-yyyy") & "  (mm-dd-yyyy) "
    Else
    ActiveSheet.Range("D4").Value = "Between " & format(s1, "mm-dd-yyyy") & " and " & format(e1, "mm-dd-yyyy") & "  (mm-dd-yyyy) "
    End If
    ActiveSheet.Range("D4:J4").HorizontalAlignment = xlCenter
    ActiveSheet.Range("D4:J4").MergeCells = True
    ActiveSheet.Range("D4:J4").font.Bold = True
    ActiveSheet.Range("D4:J4").Select
    Selection.Interior.ColorIndex = 19
    ActiveSheet.Range("E4:J4").VerticalAlignment = xlCenter
    border1
    
ElseIf CheckBox2.Value = True Then

    Sheet1.activate
    ActiveSheet.Range("D3").Select
    ActiveCell.FormulaR1C1 = "Deliverables Status Report " & " (Today Deliverables)"

    If TextBox1.Text = TextBox2.Text Then
    Sheet1.Range("D4").Value = "As on " & format(TextBox1.Text, "mm-dd-yyyy") & "  (mm-dd-yyyy) "
    Else
    Sheet1.Range("D4").Value = "Between " & format(TextBox1.Text, "mm-dd-yyyy") & " and " & format(TextBox2.Text, "mm-dd-yyyy") & "  (mm-dd-yyyy) "
    End If
    ActiveSheet.Range("D4:J4").HorizontalAlignment = xlCenter
    ActiveSheet.Range("D4:J4").MergeCells = True
    ActiveSheet.Range("D4:J4").font.Bold = True
    ActiveSheet.Range("D4:J4").Select
    Selection.Interior.ColorIndex = 19
    ActiveSheet.Range("E4:J4").VerticalAlignment = xlCenter
    border1
    
    Sheet2.activate
    ActiveSheet.Range("D3").Select
    ActiveCell.FormulaR1C1 = "Deliverables Status Report " & " (WIP)"
    
    Sheet2.Range("D4").Value = "From " & format(s1, "mm-dd-yyyy") & "  (mm-dd-yyyy) "
    
    ActiveSheet.Range("D4:J4").HorizontalAlignment = xlCenter
    ActiveSheet.Range("D4:J4").MergeCells = True
    ActiveSheet.Range("D4:J4").font.Bold = True
    ActiveSheet.Range("D4:J4").Select
    Selection.Interior.ColorIndex = 19
    ActiveSheet.Range("E4:J4").VerticalAlignment = xlCenter
    border1
    
End If

End Sub

Public Sub report_fields(row_inv, column_inv)

Dim default_report_fields As Boolean

default_report_fields = True

'Sheet1.activate

Dim con As ADODB.Connection
Dim rs_team_config As ADODB.Recordset
Dim rs_head As ADODB.Recordset
Dim rs_deliv_head As ADODB.Recordset

Set con = New ADODB.Connection
Set rs_team_config = New ADODB.Recordset
Set rs_head = New ADODB.Recordset
Set rs_deliv_head = New ADODB.Recordset


con.ConnectionString = "Driver={" & ODBCDRIVER & "};server=" & conip & ";user=" & userid & ";password=" & userpass & ";option=3"
con.CursorLocation = adUseClient
con.Open



If team_sel = True Then


If CheckBox2.Value = True Then

rs_deliv_head.Open "select * from workflow.cfg_vir_delivery_header_sequence ds where ds.team_id in (" & sTemp & ") limit 1", con, adOpenKeyset, adLockOptimistic, adCmdText

If rs_deliv_head.RecordCount > 0 Then

default_report_fields = False

If ActiveSheet.Name = "Deliverables" Then

rs_team_config.Open "select * from workflow.cfg_vir_header th, workflow.cfg_vir_delivery_header_sequence sq where " & _
"(th.team_id in (" & sTemp & ") or th.is_default='y') and th.is_active = 'y' and sq.team_id in (" & sTemp & ") and th.cfg_vir_header_id = sq.header_id and sq.sheet_id = '1' order by sq.sequence_id asc", con, adOpenKeyset, adLockOptimistic, adCmdText

ElseIf ActiveSheet.Name = "WIP" Then

rs_team_config.Open "select * from workflow.cfg_vir_header th, workflow.cfg_vir_delivery_header_sequence sq where " & _
"(th.team_id in (" & sTemp & ") or th.is_default='y') and th.is_active = 'y' and sq.team_id in (" & sTemp & ") and th.cfg_vir_header_id = sq.header_id and sq.sheet_id = '2' order by sq.sequence_id asc", con, adOpenKeyset, adLockOptimistic, adCmdText

End If

Else

default_report_fields = True

End If

End If




counter = 0

If default_report_fields = True Then

rs_head.Open "select team_id from workflow.cfg_vir_header_sequence sq where sq.team_id in (" & sTemp & ") limit 1", con, adOpenKeyset, adLockOptimistic, adCmdText

If rs_head.RecordCount > 0 Then

rs_team_config.Open "select * from workflow.cfg_vir_header th, workflow.cfg_vir_header_sequence sq where " & _
"(th.team_id in (" & sTemp & ") or th.is_default='y') and th.is_active = 'y' and sq.team_id in (" & sTemp & ") and th.cfg_vir_header_id = sq.header_id order by sq.sequence_id asc", con, adOpenKeyset, adLockOptimistic, adCmdText

Else

rs_team_config.Open "SELECT cfg_vir_header_id, header_desc, vir_field_name FROM workflow.cfg_vir_header c " & _
"where (c.team_id in (" & sTemp & ") or c.is_default='y') and c.is_active = 'y'order by cfg_vir_header_id asc", con, adOpenKeyset, adLockOptimistic, adCmdText

End If

End If


If rs_team_config.RecordCount > 0 Then

Do Until rs_team_config.EOF

header_desc = rs_team_config.Fields("header_desc")

ActiveSheet.Cells(row_inv, column_inv) = header_desc
column_inv = column_inv + 1
counter = counter + 1

If counter = 1 Then
vir_field_name = rs_team_config.Fields("vir_field_name")
Else
vir_field_name = vir_field_name & "," & rs_team_config.Fields("vir_field_name")
End If


rs_team_config.MoveNext
Loop

End If

'Debug.Print vir_field_name

'ActiveSheet.Cells(row_inv, column_inv) = "S.No"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Customer Name"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Workflow Name"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Project ID"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Project Name"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Book Title"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Product Type"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Sub-Product Type"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Stage"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Batch No./EWO Summary"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Comments"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "India Receipt Date"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "India Due Date"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Delivered Date"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Delivered Time"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Cutoff Timezone"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Cutoff Time"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Force Time?"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Status"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Reason Code"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Complexity"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "MS Pages"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Delivered Pages"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Correction Count"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Customer Contact"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "PM/PC"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "CSR Name"
'
'column_inv = column_inv + 1
'ActiveSheet.Cells(row_inv, column_inv) = "Composition"

Dim LastCol As Long
LastCol = Cells.Find("*", _
    searchorder:=xlByColumns, LookIn:=xlValues, _
    SearchDirection:=xlPrevious).EntireColumn.Column
    'MsgBox LastCol
    
myCol = GetColumnLetter(LastCol)

Range("A" & row_inv, myCol & row_inv).Select
Selection.HorizontalAlignment = xlCenter
Selection.font.Bold = True
Selection.Interior.ColorIndex = 40
'border

row_inv = row_inv + 1
column_inv = 1

Else

MsgBox "Please select atleast a Team to run VIR Report", vbCritical

End If

End Sub
Public Function vir_sas_exclude(sTemp, sas_exclude)

Dim con_rep As ADODB.Connection
Set con_rep = New ADODB.Connection

Dim rs_vir_sas_exclude As ADODB.Recordset
Set rs_vir_sas_exclude = New ADODB.Recordset

con_rep.ConnectionString = "Driver={" & ODBCDRIVER & "};server=" & conip & ";user=" & userid & ";password=" & userpass & ";option=3"
con_rep.CursorLocation = adUseClient
con_rep.Open

'rs_vir_sas_exclude.Open "select team_id, vir_exclude_stage_id from workflow.cfg_vir_mapping_team_settings vts where vts.team_id in (" & sTemp & ") order by vir_mapping_team_settings_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
rs_vir_sas_exclude.Open "select group_concat(vir_exclude_stage_id)as vir_exclude_stage_id from workflow.cfg_vir_sas_exclude ex where ex.team_id in (" & sTemp & ") limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

If rs_vir_sas_exclude.RecordCount > 0 Then
    If IsNull(rs_vir_sas_exclude.Fields("vir_exclude_stage_id")) Then
    sas_exclude = ""
    Else
    sas_exclude = rs_vir_sas_exclude.Fields("vir_exclude_stage_id")
    End If
Else
    sas_exclude = ""
End If

rs_vir_sas_exclude.Close

End Function
Public Function team_list(sTemp, team_sel)

' Team Name

team_sel = False
Dim oItem As Variant
    'Dim sTemp As String
    Dim iCount As Integer
    iCount = 0
    With Me.ListBox1
            For i = 0 To .ListCount - 1
            If .Selected(i) Then
                      
            If iCount = 0 Then
                sTemp = sTemp & "'" & arr(i + 1) & "'"
                iCount = iCount + 1
            Else
                sTemp = sTemp & ",'" & arr(i + 1) & "'"
                iCount = iCount + 1
            End If
            End If
        Next i
    If iCount = 0 Then
            For i = 0 To .ListCount - 1
                                
            If iCount = 0 Then
                sTemp = sTemp & "'" & arr(i + 1) & "'"
                iCount = iCount + 1
            Else
                sTemp = sTemp & ",'" & arr(i + 1) & "'"
                iCount = iCount + 1
            End If
            Next i
           
            'MsgBox sTemp
    Else
    team_sel = True
    End If
    End With
'     MsgBox sTemp

End Function

Public Function cus_list(sTemp1, cus_sel)

' Customer Name

cus_sel = False
Dim oItem1 As Variant
    'Dim sTemp1 As String
    Dim iCount1 As Integer
    iCount1 = 0
    Dim s As Integer
    s = 0
    With Me.ListBox2
            For i = 0 To .ListCount - 1
            If .Selected(i) Then
                      
            If iCount1 = 0 Then
                sTemp1 = sTemp1 & "'" & arr1(i + 1) & "'"
                iCount1 = iCount1 + 1
            Else
                sTemp1 = sTemp1 & ",'" & arr1(i + 1) & "'"
                iCount1 = iCount1 + 1

            End If
            End If
        Next i
    If iCount1 = 0 Then
            For i = 0 To .ListCount - 1
                                
            If iCount1 = 0 Then
                sTemp1 = sTemp1 & "'" & arr1(i + 1) & "'"
                iCount1 = iCount1 + 1
            Else
                sTemp1 = sTemp1 & ",'" & arr1(i + 1) & "'"
                iCount1 = iCount1 + 1
            End If
            Next i
           
            'MsgBox sTemp1
    Else
    cus_sel = True
    End If
    End With
    
End Function

Public Function workflow_list(sTemp2, wf_sel)

' Workflow Name

wf_sel = False
Dim oItem2 As Variant
    'Dim sTemp2 As String
    Dim iCount2 As Integer
    iCount2 = 0
   
    With Me.ListBox3
            For i = 0 To .ListCount - 1
            If .Selected(i) Then
                      
            If iCount2 = 0 Then
                sTemp2 = sTemp2 & "'" & arr2(i + 1) & "'"
                iCount2 = iCount2 + 1
            Else
                sTemp2 = sTemp2 & ",'" & arr2(i + 1) & "'"
                iCount2 = iCount2 + 1
            End If
            End If
        Next i
    If iCount2 = 0 Then
            For i = 0 To .ListCount - 1
                                
            If iCount2 = 0 Then
                sTemp2 = sTemp2 & "'" & arr2(i + 1) & "'"
                iCount2 = iCount2 + 1
            Else
                sTemp2 = sTemp2 & ",'" & arr2(i + 1) & "'"
                iCount2 = iCount2 + 1
            End If
            Next i
           
            'MsgBox sTemp2
    Else
    wf_sel = True
    End If
    End With

'MsgBox sTemp2

End Function

Public Function stage_list(sTemp3, stage_sel)

' Stage Name

stage_sel = False
Dim oItem3 As Variant
    'Dim stemp3 As String
    Dim iCount3 As Integer
    iCount3 = 0
    
    With Me.ListBox4
            For i = 0 To .ListCount - 1
            If .Selected(i) Then
                       
            If iCount3 = 0 Then
                sTemp3 = sTemp3 & "'" & arr3(i + 1) & "'"
                iCount3 = iCount3 + 1
            Else
                sTemp3 = sTemp3 & ",'" & arr3(i + 1) & "'"
                iCount3 = iCount3 + 1
            End If
            End If
        Next i
    If iCount3 = 0 Then
            For i = 0 To .ListCount - 1
                                 
            If iCount3 = 0 Then
                sTemp3 = sTemp3 & "'" & arr3(i + 1) & "'"
                iCount3 = iCount3 + 1
            Else
                sTemp3 = sTemp3 & ",'" & arr3(i + 1) & "'"
                iCount3 = iCount3 + 1
            End If
            Next i
            
            'MsgBox sTemp2
    Else
    stage_sel = True
    End If
    End With
    
    'MsgBox stemp3
End Function


Private Sub Label19_Click()
Dim URL As String
URL = "https://texflow.jouve.in/timesheet/VolumeInflowReportDetails.jsp?"
    On Error GoTo problem
    ActiveWorkbook.FollowHyperlink Address:=URL, NewWindow:=True
    Exit Sub
problem:
    MsgBox "Cannot open " & URL
'Call MakeLink("https://192.168.1.5/timesheet/VolumeInflowReportDetails.jsp?")
End Sub
Sub MakeLink(ByVal cell As Range, ByVal URL As String, _
    ByVal txt As String, ByVal tooltip_text As String)
    ActiveSheet.Hyperlinks.Add _
        Anchor:=cell, _
        Address:=URL, _
        ScreenTip:=tooltip_text, _
        TextToDisplay:=txt
End Sub
Sub RemoveLink()
Sheet2.Cells.Hyperlinks.Delete
End Sub


Private Sub Image1_Click()

End Sub

Private Sub OptionButton1_Click()
Label7.Caption = OptionButton1.Caption
End Sub

Private Sub OptionButton2_Click()
Label7.Caption = OptionButton2.Caption
End Sub

Private Sub RESET_CLICK_Click()
Call UserForm_Initialize
End Sub

Public Sub UserForm_Initialize()
'RemoveLink
clear_format2
clear_format1
clear_format3

'Rows("9:9").Select
'UnFreeze

VIR_FORM.Top = 0
    VIR_FORM.Left = 0
VIR_FORM.Height = 418.5 '410.25
VIR_FORM.Width = 594.75
VIR_FORM.StartUpPosition = 1

Image1.Visible = True
Image2.Visible = True
Image3.Visible = True
Image4.Visible = True
Image5.Visible = True
Image6.Visible = True
Image7.Visible = True

Label1.Visible = True
'Label2.Visible = True
Label3.Visible = True
Label4.Visible = True
Label5.Visible = True
Label6.Visible = True
Label7.Visible = True
Label8.Visible = True
Label9.Visible = True
Label10.Visible = True
Label11.Visible = True

OptionButton1.Visible = True
OptionButton2.Visible = True

Cmd_Startdate.Visible = True
Cmd_Enddate.Visible = True

TextBox1.Visible = True
TextBox2.Visible = True

GEN_REPORT.Visible = True
RESET_CLICK.Visible = True

ListBox1.Visible = True
ListBox2.Visible = True
ListBox3.Visible = True
ListBox4.Visible = True

progress_status.Visible = False
LabelProgress.Visible = False
back_img.Visible = False

CheckBox1.Value = True

OptionButton1.Value = True

Dim con_rep As ADODB.Connection
Dim rs_cust As ADODB.Recordset
Dim rs_proj_lod As ADODB.Recordset

Set con_rep = New ADODB.Connection
Set rs_cust = New ADODB.Recordset
Set rs_proj_lod = New ADODB.Recordset

Dim rs_wf As ADODB.Recordset
Set rs_wf = New ADODB.Recordset

Dim rs_team As ADODB.Recordset
Set rs_team = New ADODB.Recordset

Dim rs_emp_team As ADODB.Recordset
Set rs_emp_team = New ADODB.Recordset

Dim rs_stage As ADODB.Recordset
Set rs_stage = New ADODB.Recordset

Dim rs_emp As ADODB.Recordset
Set rs_emp = New ADODB.Recordset

Dim s, s1, s2, s3  As Integer

con_rep.ConnectionString = "Driver={" & ODBCDRIVER & "};server=" & conip & ";user=" & userid & ";password=" & userpass & ";option=3"
con_rep.CursorLocation = adUseClient
con_rep.Open

On Error Resume Next

rs_emp.Open "select empid, concat(fname,' ',lname,' ',initial)as empname, deptid, desgid, (select team_id from ems.team_member tm where tm.member_type_id = 1 and tm.empid = tr.empid) as team_id from ems.textech_resources tr where tr.empid = '" & LOGIN_FORM.TextBox1.Text & "' limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

If LOGIN_FORM.TextBox1.Text = "" Then
LOGIN_FORM.TextBox1.Text = "1526"  'For Troubleshooting purpose
End If

If (LOGIN_FORM.TextBox1.Text = "1526" Or LOGIN_FORM.TextBox1.Text = "0003" Or LOGIN_FORM.TextBox1.Text = "0801" Or rs_emp.Fields("deptid") = "PROC" Or rs_emp.Fields("deptid") = "TECH" Or rs_emp.Fields("deptid") = "ADMN" Or rs_emp.Fields("desgid") = "6255" Or rs_emp.Fields("desgid") = "6111" Or rs_emp.Fields("desgid") = "6114" Or rs_emp.Fields("desgid") = "6110" Or CInt(rs_emp.Fields("team_id")) = 74) Then
'For Troubleshooting purpose and enable QMS team dept and its designations

rs_team.Open "select team_id, team_name from ems.team_details td " & _
"where td.team_status_id=1 and td.is_production='y'and td.is_vendor = 'n' " & _
"and td.owner_id in (select empid from ems.textech_resources where company_id=1) " & _
"order by team_name", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

ElseIf LOGIN_FORM.TextBox1.Text <> "1526" Then

rs_team.Open "select team_id,team_name " & _
"from ems.team_details td " & _
"where td.team_status_id = 1 and td.is_production='y' and td.is_vendor = 'n' " & _
"and (td.owner_id ='" & LOGIN_FORM.TextBox1.Text & "' or td.backup_owner_id ='" & LOGIN_FORM.TextBox1.Text & "' or (owner_id in (select empid from ems.team_member tm, ems.team_details td " & _
"where td.team_status_id = 1 And td.team_id = tm.team_id And tm.member_type_id = 1 " & _
"and td.owner_id = '" & LOGIN_FORM.TextBox1.Text & "'))) " & _
"Union " & _
"select team_id, team_name from ems.team_details td " & _
"where td.team_status_id=1 and td.is_production='y'and td.is_vendor = 'n' " & _
"and td.owner_id in (select empid from ems.textech_resources where company_id=1) " & _
"and team_id in (select team_id from ems.team_member where empid in " & _
"(select empid from ems.textech_resources tr where tr.empid = '" & LOGIN_FORM.TextBox1.Text & "' and (tr.relieved is null or tr.relieved <> 'y'))) " & _
"order by team_name", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

End If

rs_cust.Open "select distinct cdi.customer_division_imprint_id, concat((select c.customer_name from lgms.customer_details c where c.customer_id=cdi.customer_id),' ', " & _
"if((cdi.division_id is not null), (select d.division_name from lgms.division_details d where d.division_id=cdi.division_id),''),' ', " & _
"if((cdi.imprint_id is not null),(select i.imprint_name from lgms.imprint_details i where i.imprint_id=cdi.imprint_id),'')) as cus_name " & _
"from workflow.project_details p left outer join lgms.customer_division_imprint cdi " & _
"on p.customer_division_imprint_id = cdi.customer_division_imprint_id order by cus_name", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

rs_wf.Open "select workflow_id, workflow_name from  workflow.workflow_details wd where wd.workflow_id in(  " & _
"select workflow_id from ems.team_customer tc where tc.team_id in (select team_id from ems.team_details td where " & _
"team_type_id=2 and td.team_status_id=1 and td.is_production='y' and td.owner_id in (select empid from ems.textech_resources tr where tr.company_id=1) " & _
")) and wd.workflow_id not in (38,45,46,50,30,44,43,52,48,41,42,31,30,28,26) order by workflow_name", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

rs_stage.Open "select stage_id, stage_name from workflow.cfg_stages stg where stage_id not in (14,1, 10, 12, 8,22) order by stage_name", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

If rs_emp.RecordCount > 0 Then
    Label1.Caption = "Welcome, " & rs_emp.Fields("empname")
Else
    Label1.Caption = "Welcome, Guest!"
End If

ListBox1.clear
s = 1

Do Until rs_team.EOF
ListBox1.AddItem rs_team.Fields("team_name")
arr(s) = rs_team.Fields("team_id")
rs_team.MoveNext
s = s + 1
Loop


ListBox2.clear
s1 = 1
'On Error Resume Next

Do Until rs_cust.EOF
ListBox2.AddItem rs_cust.Fields("cus_name")
arr1(s1) = rs_cust.Fields("customer_division_imprint_id")
rs_cust.MoveNext
s1 = s1 + 1
Loop


ListBox3.clear
s2 = 1

Do Until rs_wf.EOF
ListBox3.AddItem rs_wf.Fields("workflow_name")
arr2(s2) = rs_wf.Fields("workflow_id")
rs_wf.MoveNext
s2 = s2 + 1
Loop

ListBox4.clear
s3 = 1

Do Until rs_stage.EOF
ListBox4.AddItem rs_stage.Fields("stage_name")
arr3(s3) = rs_stage.Fields("stage_id")
rs_stage.MoveNext
s3 = s3 + 1
Loop


rs_stage.Close
rs_team.Close
rs_wf.Close
rs_cust.Close
rs_proj_lod.Close
rs_pm.Close
rs_emp.Close

con_rep.Close

TextBox1.Text = ""
TextBox2.Text = ""

Sheet1.activate

End Sub

Public Function TimeEarlierThan(TimeString As String, _
  CompareTo As String) As Boolean
'Takes two time strings as returns true if the
'first is earlier than the second

'Example Usage:
'Checks if it is before 6:00 PM
'If TimeEarlierThan(Format(Now, "Short Time"), "6:00 PM") Then
'    MsgBox "Good Afternoon (or morning)"
'Else
'    MsgBox "Good Evening"
'End If

If Not IsTime(TimeString) Or Not IsTime(CompareTo) Then _
    Exit Function
'TimeEarlierThan = CDate(TimeString) <= CDate(CompareTo)
'MsgBox CDate(TimeString) <= CDate(CompareTo)
TimeEarlierThan = CDate(TimeString) <= CDate(CompareTo)
End Function

Private Function IsTime(sTime As String) As Boolean
'http://www.freevbcode.com/ShowCode.Asp?ID=1321
'by Phil Fresle
    If Left(Trim(sTime), 1) Like "#" Then
        IsTime = IsDate(date & " " & sTime)
    End If
End Function

Sub summary(proj As String, s As String, m As String, c As Long, rc As String, ct As String)
'MsgBox proj
'MsgBox m
Dim row_num, col_num As Integer
Sheet3.activate
row_num = 0 + c
col_num = 1
Sheet3.Cells(row_num, col_num) = proj
Sheet3.Cells(row_num, col_num).Select
border1
col_num = col_num + 1
Sheet3.Cells(row_num, col_num) = s
Sheet3.Cells(row_num, col_num).Select
border1
col_num = col_num + 1
Sheet3.Cells(row_num, col_num) = m
Sheet3.Cells(row_num, col_num).Select
border1
col_num = col_num + 1
Sheet3.Cells(row_num, col_num) = rc
Sheet3.Cells(row_num, col_num).Select
border1
col_num = col_num + 1
Sheet3.Cells(row_num, col_num) = ct
Sheet3.Cells(row_num, col_num).Select
With Selection
        .HorizontalAlignment = xlGeneral
        .VerticalAlignment = xlBottom
        .WrapText = True
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
End With
border1
Sheet1.activate
End Sub

Sub cso_vir_exclude()

Dim con As ADODB.Connection
Dim rs_cso_ex As ADODB.Recordset

Set con = New ADODB.Connection
Set rs_cso_ex = New ADODB.Recordset

con.ConnectionString = "Driver={" & ODBCDRIVER & "};server=" & conip & ";user=" & userid & ";password=" & userpass & ";option=3"
con.CursorLocation = adUseClient
con.Open

'Alert for CSO VIR EXCLUDE based on TIME SET in DB
rs_cso_ex.Open "select ex.empid, ex.end_date, concat(tr.fname,' ',tr.lname,' ',tr.initial) as csr_name from workflow.cso_emp_vir_exclude ex, ems.textech_resources tr " & _
"where DATE_ADD(ex.end_date,INTERVAL -7 Day) < date(now()) and tr.empid = ex.empid and (tr.relieved is null or tr.relieved <> 'y') order by cso_emp_vir_id desc limit 1", con, adOpenKeyset, adLockOptimistic, adCmdText

If rs_cso_ex.RecordCount > 0 Then

    sd_dt = format(Now(), "yyyy-mm-dd")
    ed_dt = format(rs_cso_ex.Fields("end_date"), "yyyy-mm-dd")
    
    ex_diff = DateDiff("d", sd_dt, ed_dt)
     
    MsgBox "Please update END DATE for CSO EMPLOYEES VIR EXCLUSION in Texflow Database. Kindly inform Texflow team (texflow.internal@jouve.in) to update the Enddate in DB table " & _
    "'workflow.cso_emp_vir_exclude' WITHIN  " & ex_diff & "  DAYS to avoid CSO Assigned EWO's participation in VIR report...", vbCritical

End If

rs_cso_ex.Close

End Sub

Private Sub ListBox1_Change()

sTemp = ""

'Team Name
Call team_list(sTemp, team_sel)

If team_sel = False Then
qry_team = " 1=1 "
Else
qry_team = "tc.team_id in (" & sTemp & ")"
End If

Dim con_rep As ADODB.Connection
Set con_rep = New ADODB.Connection

Dim rs_cust As ADODB.Recordset
Set rs_cust = New ADODB.Recordset

Dim rs_wf As ADODB.Recordset
Set rs_wf = New ADODB.Recordset


con_rep.ConnectionString = "Driver={" & ODBCDRIVER & "};server=" & conip & ";user=" & userid & ";password=" & userpass & ";option=3"
con_rep.CursorLocation = adUseClient
con_rep.Open

rs_cust.Open "select distinct (cdi.customer_division_imprint_id), concat((select c.customer_name from lgms.customer_details c where c.customer_id=cdi.customer_id),' ', " & _
"if((cdi.division_id is not null), (select d.division_name from lgms.division_details d where d.division_id=cdi.division_id),''),' ', " & _
"if((cdi.imprint_id is not null),(select i.imprint_name from lgms.imprint_details i where i.imprint_id=cdi.imprint_id),'')) as cus_name from " & _
"lgms.customer_division_imprint cdi,ems.team_customer tc where cdi.customer_division_imprint_id = tc.customer_division_imprint_id " & _
"and " & qry_team & " order by cus_name", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

rs_wf.Open "select distinct workflow_name, wd.workflow_id from workflow.workflow_details wd, ems.team_customer tc " & _
"where wd.workflow_id = tc.workflow_id and " & qry_team & " and wd.workflow_id not in (38,45,46,50,57,30,44,43,52,48,41,42,31,30,28,26)", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

ListBox2.clear
Dim s1 As Integer
s1 = 1
Do Until rs_cust.EOF
ListBox2.AddItem rs_cust.Fields("cus_name")
arr1(s1) = rs_cust.Fields("customer_division_imprint_id")
rs_cust.MoveNext
s1 = s1 + 1
Loop
rs_cust.Close

ListBox3.clear
Dim s2 As Integer
s2 = 1
Do Until rs_wf.EOF
ListBox3.AddItem rs_wf.Fields("workflow_name")
arr2(s2) = rs_wf.Fields("workflow_id")
rs_wf.MoveNext
s2 = s2 + 1
Loop
rs_wf.Close

con_rep.Close

End Sub

Private Sub ListBox2_Change()

sTemp = ""

'Team Name
Call team_list(sTemp, team_sel)

If team_sel = False Then
qry_team = " 1=1 "
Else
qry_team = "tc.team_id in (" & sTemp & ")"
End If

sTemp1 = ""

'Customer Name
Call cus_list(sTemp1, cus_sel)

If cus_sel = False Then
qry_cust = " 1=1 "
Else
qry_cust = "tc.customer_division_imprint_id in (" & sTemp1 & ")"
End If

Dim con_rep As ADODB.Connection
Set con_rep = New ADODB.Connection

Dim rs_wf As ADODB.Recordset
Set rs_wf = New ADODB.Recordset


con_rep.ConnectionString = "Driver={" & ODBCDRIVER & "};server=" & conip & ";user=" & userid & ";password=" & userpass & ";option=3"
con_rep.CursorLocation = adUseClient
con_rep.Open

rs_wf.Open "select distinct workflow_name, wd.workflow_id from workflow.workflow_details wd, ems.team_customer tc " & _
"where wd.workflow_id = tc.workflow_id and " & qry_team & " and " & qry_cust & " and wd.workflow_id not in (38, 45, 46)", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

ListBox3.clear
Dim s2 As Integer
s2 = 1

Do Until rs_wf.EOF
ListBox3.AddItem rs_wf.Fields("workflow_name")
arr2(s2) = rs_wf.Fields("workflow_id")
rs_wf.MoveNext
s2 = s2 + 1
Loop

rs_wf.Close

con_rep.Close

End Sub

Sub report_formatting()

Dim lastrow As Integer

lastrow = ActiveSheet.Cells.Find("*", _
    searchorder:=xlByRows, LookIn:=xlValues, _
    SearchDirection:=xlPrevious).EntireRow.row
    
Dim LastCol As Long
LastCol = Cells.Find("*", _
    searchorder:=xlByColumns, LookIn:=xlValues, _
    SearchDirection:=xlPrevious).EntireColumn.Column
    'MsgBox LastCol
    
myCol = GetColumnLetter(LastCol)

Range("A8:" & myCol & lastrow).Select
border

'For Deliverable Status Report - ROW Height (Trade UK, PUS, Tradr US Teams)
 If CheckBox2.Value = True Then
    If InStr(1, sTemp, "46", vbTextCompare) Then
        ActiveSheet.Range("A8:" & myCol & lastrow).RowHeight = 25
        Call Status_sort(LastCol)
    ElseIf InStr(1, sTemp, "58", vbTextCompare) Then
        ActiveSheet.Range("A8:" & myCol & lastrow).RowHeight = 25
        Call Status_sort(LastCol)
    ElseIf InStr(1, sTemp, "4", vbTextCompare) Then
        ActiveSheet.Range("A8:" & myCol & lastrow).RowHeight = 25
        Call Status_sort(LastCol)
    End If
End If

For h = 1 To (lastrow - 8)

Cells(8 + h, 1).Value = h

Next h

'Range("A9:A" & lastrow).Select
'Selection.HorizontalAlignment = xlCenter
'
'Range("D9:D" & lastrow).Select
'Selection.HorizontalAlignment = xlCenter
'
'Range("L9:S" & lastrow).Select
'Selection.HorizontalAlignment = xlCenter
'
'Range("U9:X" & lastrow).Select
'Selection.HorizontalAlignment = xlCenter
'
'Range("L9:N" & lastrow).Select
'Selection.NumberFormat = "[$-409]d-mmm;@"

'Sheet1.activate

Range("A8:" & myCol & 8).Select
Selection.AutoFilter

Columns("A:AF").AutoFit

For j = 1 To LastCol
    If Cells(8, j).Value = "Project Name" Then
    ActiveSheet.Columns(j).ColumnWidth = 25
    ElseIf Cells("8", j).Value = "Book Title" Then
    ActiveSheet.Columns(j).ColumnWidth = 35
    ElseIf Cells("8", j).Value = "Batch No./EWO Summary" Then
    ActiveSheet.Columns(j).ColumnWidth = 35
    ElseIf Cells("8", j).Value = "Comments" Then
    ActiveSheet.Columns(j).ColumnWidth = 35
    End If
Next j

'Columns("E:E").ColumnWidth = 25
'Columns("F:F").ColumnWidth = 35
'Columns("J:J").ColumnWidth = 35
'Columns("K:K").ColumnWidth = 35

myCol = GetColumnLetter(LastCol + 1)

Range(myCol & 8 & ":BA" & lastrow).Select
Selection.Interior.ColorIndex = 2

'Rows("9:9").Select
'Freeze

Range("A9").Select

End Sub

Sub legend(row_inv, column_inv)

ActiveSheet.Cells(row_inv, column_inv) = ""
ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
ActiveSheet.Cells(row_inv, column_inv).Select
Selection.Interior.ColorIndex = 6
border1

column_inv = column_inv + 1
ActiveSheet.Cells(row_inv, column_inv) = "Delivered"
ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
ActiveSheet.Cells(row_inv, column_inv).Select
border1

column_inv = 3
row_inv = row_inv + 1
ActiveSheet.Cells(row_inv, column_inv) = ""
ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
ActiveSheet.Cells(row_inv, column_inv).Select
Selection.Interior.ColorIndex = 44
border1

column_inv = column_inv + 1
ActiveSheet.Cells(row_inv, column_inv) = "Query"
ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
ActiveSheet.Cells(row_inv, column_inv).Select
border1

column_inv = 3
row_inv = row_inv + 1
ActiveSheet.Cells(row_inv, column_inv) = ""
ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
ActiveSheet.Cells(row_inv, column_inv).Select
border1

column_inv = column_inv + 1
ActiveSheet.Cells(row_inv, column_inv) = "WIP"
ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
ActiveSheet.Cells(row_inv, column_inv).Select
border1

column_inv = 3
row_inv = row_inv + 1
ActiveSheet.Cells(row_inv, column_inv) = ""
ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
ActiveSheet.Cells(row_inv, column_inv).Select
Selection.Interior.ColorIndex = 22
border1

column_inv = column_inv + 1
ActiveSheet.Cells(row_inv, column_inv) = "On Hold"
ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
ActiveSheet.Cells(row_inv, column_inv).Select
border1

column_inv = 3
row_inv = row_inv + 1
ActiveSheet.Cells(row_inv, column_inv) = ""
ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
ActiveSheet.Cells(row_inv, column_inv).Select
Selection.Interior.ColorIndex = 3
border1

column_inv = column_inv + 1
ActiveSheet.Cells(row_inv, column_inv) = "Overdue/Delay"
ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
ActiveSheet.Cells(row_inv, column_inv).Select
border1

If InStr(1, sTemp, "'58'") Or InStr(1, sTemp, "'92'") Then

column_inv = 3
row_inv = row_inv + 1
ActiveSheet.Cells(row_inv, column_inv) = ""
ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
ActiveSheet.Cells(row_inv, column_inv).Select
Selection.Interior.ColorIndex = 28
border1

column_inv = column_inv + 1
ActiveSheet.Cells(row_inv, column_inv) = "Sample Castoff Not Yet Approved"
ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
ActiveSheet.Cells(row_inv, column_inv).Select
border1

End If

Range("A9").Select

End Sub

Sub create_pivot()
 
Dim LastCol As Long
LastCol = Cells.Find("*", _
    searchorder:=xlByColumns, LookIn:=xlValues, _
    SearchDirection:=xlPrevious).EntireColumn.Column
    'MsgBox LastCol
    
myCol = GetColumnLetter(LastCol)

Dim lastrow As Integer

lastrow = Cells.Find("*", _
    searchorder:=xlByRows, LookIn:=xlValues, _
    SearchDirection:=xlPrevious).EntireRow.row
   
   Call AllWorksheetPivots
    Range("A7").Select
    ActiveWorkbook.PivotCaches.Add(SourceType:=xlDatabase, SourceData:= _
        "Data!R8C2:R" & lastrow - 8 & "C" & LastCol).CreatePivotTable TableDestination:= _
        "'[Texflow_Direct_Reports_LAN.xls]Pivot'!R3C2", TableName:="PivotTable2", _
        DefaultVersion:=xlPivotTableVersion10
        
    Sheet2.PivotTables("PivotTable2").AddFields RowFields:=Array( _
        "Status", "Stage")
    Sheet2.PivotTables("PivotTable2").AddDataField Sheet2.PivotTables( _
        "PivotTable2").PivotFields("Project ID"), "Sum of Project ID", xlCount
        
lastrow = Cells.Find("*", _
    searchorder:=xlByRows, LookIn:=xlValues, _
    SearchDirection:=xlPrevious).EntireRow.row

Sheet2.activate

Sheet2.Columns("A:A").ColumnWidth = 5
    Sheet2.Columns("B:B").ColumnWidth = 25
    Sheet2.Columns("C:C").ColumnWidth = 24
    Sheet2.Columns("D:D").ColumnWidth = 25
    Sheet2.Columns("E:E").ColumnWidth = 30
    
lastrow = Cells.Find("*", _
    searchorder:=xlByRows, LookIn:=xlValues, _
    SearchDirection:=xlPrevious).EntireRow.row

Sheet2.Cells(lastrow + 8, 2) = "Project ID"
Sheet2.Cells(lastrow + 8, 2).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 8, 2).font.Bold = True
Sheet2.Cells(lastrow + 8, 2).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 8, 3) = "Stage"
Sheet2.Cells(lastrow + 8, 3).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 8, 3).font.Bold = True
Sheet2.Cells(lastrow + 8, 3).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 8, 4) = "Delayed By"
Sheet2.Cells(lastrow + 8, 4).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 8, 4).font.Bold = True
Sheet2.Cells(lastrow + 8, 4).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 8, 5) = "Reason Code"
Sheet2.Cells(lastrow + 8, 5).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 8, 5).font.Bold = True
Sheet2.Cells(lastrow + 8, 5).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 8, 6) = "Comments"
Sheet2.Cells(lastrow + 8, 6).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 8, 6).font.Bold = True
Sheet2.Cells(lastrow + 8, 6).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.activate
Sheet2.Cells(lastrow + 5, 2) = "Delayed By"
Sheet2.Cells(lastrow + 5, 2).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 5, 2).font.Bold = True
Sheet2.Cells(lastrow + 5, 2).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 5, 3) = "< 30 Mins"
Sheet2.Cells(lastrow + 5, 3).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 5, 3).font.Bold = True
Sheet2.Cells(lastrow + 5, 3).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 5, 4) = "30 Mins - 1 Hour"
Sheet2.Cells(lastrow + 5, 4).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 5, 4).font.Bold = True
Sheet2.Cells(lastrow + 5, 4).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 5, 5) = "1 Hour - 2 Hours"
Sheet2.Cells(lastrow + 5, 5).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 5, 5).font.Bold = True
Sheet2.Cells(lastrow + 5, 5).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 5, 6) = "2 Hours - 3 Hours"
Sheet2.Cells(lastrow + 5, 6).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 5, 6).font.Bold = True
Sheet2.Cells(lastrow + 5, 6).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 5, 7) = "3 Hours - 4 Hours"
Sheet2.Cells(lastrow + 5, 7).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 5, 7).font.Bold = True
Sheet2.Cells(lastrow + 5, 7).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 5, 8) = "4 Hours - 5 Hours"
Sheet2.Cells(lastrow + 5, 8).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 5, 8).font.Bold = True
Sheet2.Cells(lastrow + 5, 8).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 5, 9) = "5 Hours - 6 Hours"
Sheet2.Cells(lastrow + 5, 9).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 5, 9).font.Bold = True
Sheet2.Cells(lastrow + 5, 9).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 5, 10) = "> 6 Hours"
Sheet2.Cells(lastrow + 5, 10).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 5, 10).font.Bold = True
Sheet2.Cells(lastrow + 5, 10).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 6, 2) = "Total"
Sheet2.Cells(lastrow + 6, 2).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 6, 2).font.Bold = True
Sheet2.Cells(lastrow + 6, 2).Select
Selection.Interior.ColorIndex = 40
border1
         
Sheet2.Cells(lastrow + 6, 3) = t1
Sheet2.Cells(lastrow + 6, 3).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 6, 3).font.Bold = True
Sheet2.Cells(lastrow + 6, 3).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 6, 4) = t2
Sheet2.Cells(lastrow + 6, 4).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 6, 4).font.Bold = True
Sheet2.Cells(lastrow + 6, 4).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 6, 5) = t3
Sheet2.Cells(lastrow + 6, 5).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 6, 5).font.Bold = True
Sheet2.Cells(lastrow + 6, 5).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 6, 6) = t4
Sheet2.Cells(lastrow + 6, 6).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 6, 6).font.Bold = True
Sheet2.Cells(lastrow + 6, 6).Select
Selection.Interior.ColorIndex = 40
border1

Sheet2.Cells(lastrow + 6, 7) = t5
Sheet2.Cells(lastrow + 6, 7).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 6, 7).font.Bold = True
Sheet2.Cells(lastrow + 6, 7).Select
Selection.Interior.ColorIndex = 40
border1
        
Sheet2.Cells(lastrow + 6, 8) = t6
Sheet2.Cells(lastrow + 6, 8).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 6, 8).font.Bold = True
Sheet2.Cells(lastrow + 6, 8).Select
Selection.Interior.ColorIndex = 40
border1
        
Sheet2.Cells(lastrow + 6, 9) = t7
Sheet2.Cells(lastrow + 6, 9).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 6, 9).font.Bold = True
Sheet2.Cells(lastrow + 6, 9).Select
Selection.Interior.ColorIndex = 40
border1
        
Sheet2.Cells(lastrow + 6, 10) = t8
Sheet2.Cells(lastrow + 6, 10).HorizontalAlignment = xlCenter
Sheet2.Cells(lastrow + 6, 10).font.Bold = True
Sheet2.Cells(lastrow + 6, 10).Select
Selection.Interior.ColorIndex = 40
border1
        
Sheet3.activate
If Range("A1").Value <> "" Then

lastrow1 = Cells.Find("*", _
    searchorder:=xlByRows, LookIn:=xlValues, _
    SearchDirection:=xlPrevious).EntireRow.row

Sheet3.Range("A1:E" & lastrow1).Select
Selection.Cut

Sheet2.activate
Sheet2.Columns("A:A").ColumnWidth = 5
    Sheet2.Columns("B:B").ColumnWidth = 25
    Sheet2.Columns("C:C").ColumnWidth = 24
    Sheet2.Columns("D:D").ColumnWidth = 25
    Sheet2.Columns("E:E").ColumnWidth = 30
Range("B" & lastrow + 9).Select
ActiveSheet.Paste
    Sheet2.Columns("A:A").ColumnWidth = 5
    Sheet2.Columns("B:B").ColumnWidth = 25
    Sheet2.Columns("C:C").ColumnWidth = 24
    Sheet2.Columns("D:D").ColumnWidth = 25
    Sheet2.Columns("E:E").ColumnWidth = 30
    Sheet2.activate
    Range("A4").Select
    End If
End Sub

Sub Progress_mod()

Image1.Visible = False
Image2.Visible = False
Image3.Visible = False
Image4.Visible = False
Image5.Visible = False
Image6.Visible = False
Image7.Visible = False

Label1.Visible = False
'Label2.Visible = True
Label3.Visible = False
Label4.Visible = False
Label5.Visible = False
Label6.Visible = False
Label7.Visible = False
Label8.Visible = False
Label9.Visible = False
Label10.Visible = False
Label11.Visible = False

OptionButton1.Visible = False
OptionButton2.Visible = False

Cmd_Startdate.Visible = False
Cmd_Enddate.Visible = False

TextBox1.Visible = False
TextBox2.Visible = False

GEN_REPORT.Visible = False
RESET_CLICK.Visible = False

ListBox1.Visible = False
ListBox2.Visible = False
ListBox3.Visible = False
ListBox4.Visible = False

VIR_FORM.Top = 200
VIR_FORM.Left = 400
VIR_FORM.Height = 103.5
VIR_FORM.Width = 240
VIR_FORM.StartUpPosition = 2

progress_status.Height = 12
progress_status.Left = 16
progress_status.Top = 10
progress_status.Width = 200
progress_status.Visible = True

LabelProgress.Height = 18
LabelProgress.Left = 16
LabelProgress.Top = 30
LabelProgress.Width = 1
LabelProgress.Visible = True

'Sleep 100
back_img.Visible = True
back_img.Height = 228
back_img.Left = -342
back_img.Top = -108
back_img.Width = 654


End Sub

Sub UpdateProgressBar(Width As Variant)
        ' Increase the Label width.
        LabelProgress.Width = LabelProgress.Width + Width '(LabelProgress.width / rec_count)
        DoEvents
End Sub


Sub form_reset()

VIR_FORM.Top = 0
VIR_FORM.Left = 0
VIR_FORM.Height = 418.5 '410.25
VIR_FORM.Width = 594.75
VIR_FORM.StartUpPosition = 1

Image1.Visible = True
Image2.Visible = True
Image3.Visible = True
Image4.Visible = True
Image5.Visible = True
Image6.Visible = True
Image7.Visible = True

Label1.Visible = True
'Label2.Visible = True
Label3.Visible = True
Label4.Visible = True
Label5.Visible = True
Label6.Visible = True
Label7.Visible = True
Label8.Visible = True
Label9.Visible = True
Label10.Visible = True
Label11.Visible = True

OptionButton1.Visible = True
OptionButton2.Visible = True

Cmd_Startdate.Visible = True
Cmd_Enddate.Visible = True

TextBox1.Visible = True
TextBox2.Visible = True

GEN_REPORT.Visible = True
RESET_CLICK.Visible = True

ListBox1.Visible = True
ListBox2.Visible = True
ListBox3.Visible = True
ListBox4.Visible = True

ListBox1.Selected(ListBox1.ListIndex) = False
ListBox2.Selected(ListBox1.ListIndex) = False
ListBox3.Selected(ListBox1.ListIndex) = False
ListBox4.Selected(ListBox1.ListIndex) = False

progress_status.Visible = False
LabelProgress.Visible = False
back_img.Visible = False

OptionButton1.Value = True

TextBox1.Text = ""
TextBox2.Text = ""

Sheet1.activate

End Sub

Public Sub deliv_report_data(iwo_query, qry_date, wo_type)

sTemp = ""
sTemp1 = ""
sTemp2 = ""
sTemp3 = ""

Dim con_rep As ADODB.Connection
Set con_rep = New ADODB.Connection

Dim rs_receipt_date As ADODB.Recordset
Set rs_receipt_date = New ADODB.Recordset

Dim rs_deliver_date As ADODB.Recordset
Set rs_deliver_date = New ADODB.Recordset

Dim rs_corr_cnt As ADODB.Recordset
Set rs_corr_cnt = New ADODB.Recordset

Dim rs_complexity As ADODB.Recordset
Set rs_complexity = New ADODB.Recordset

Dim rs_label As ADODB.Recordset
Set rs_label = New ADODB.Recordset

Dim rs_ms_pages As ADODB.Recordset
Set rs_ms_pages = New ADODB.Recordset

Dim rs_del_pages As ADODB.Recordset
Set rs_del_pages = New ADODB.Recordset

Dim rs_ms_pages_label As ADODB.Recordset
Set rs_ms_pages_label = New ADODB.Recordset

Dim rs_iwo As ADODB.Recordset
Set rs_iwo = New ADODB.Recordset

Dim rs_team As ADODB.Recordset
Set rs_team = New ADODB.Recordset

Dim rs_timezone_value As ADODB.Recordset
Set rs_timezone_value = New ADODB.Recordset

Dim rs_query As ADODB.Recordset
Set rs_query = New ADODB.Recordset

Dim rs_query_approval As ADODB.Recordset
Set rs_query_approval = New ADODB.Recordset

Dim rs_comp As ADODB.Recordset
Set rs_comp = New ADODB.Recordset

Dim cmd As ADODB.Command
Set cmd = New ADODB.Command

Dim rs_del_pages_label As ADODB.Recordset
Set rs_del_pages_label = New ADODB.Recordset

Dim rs_sch As ADODB.Recordset
Set rs_sch = New ADODB.Recordset

Dim rs_planned_date As ADODB.Recordset
Set rs_planned_date = New ADODB.Recordset

Dim rsVault As ADODB.Recordset
Set rsVault = New ADODB.Recordset

Dim rsTitleCnt As ADODB.Recordset
Set rsTitleCnt = New ADODB.Recordset

Dim rs_JG_Complexity As ADODB.Recordset
Set rs_JG_Complexity = New ADODB.Recordset

Dim project_id As String

con_rep.ConnectionString = "Driver={" & ODBCDRIVER & "};server=" & conip & ";user=" & userid & ";password=" & userpass & ";option=3"
con_rep.CursorLocation = adUseClient
con_rep.Open

sTemp = ""

'Team Name
Call team_list(sTemp, team_sel)

If team_sel = False Then
qry_team = " 1=1 "
Else
    If wo_type = "iwo" Then
        qry_team = "vir.team_id in (" & sTemp & ")"
    Else
        qry_team = "td.team_id in (" & sTemp & ")"
    End If
End If

'Hardcoded for Jouve Production Team by Boopathi on 1-Mar-16 as requested by Srinivasan S)
If InStr(1, sTemp, "'135'") Or InStr(1, sTemp, "'48'") Then
    qry_team1 = "td.team_id not in ('99')"
Else
    qry_team1 = " 1=1 "
End If

If team_sel = True Then

rs_team.Open "select group_concat(distinct(team_name),'') as team_name from ems.team_details td where td.team_id in (" & sTemp & ") order by team_id", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

If rs_team.RecordCount > 0 Then
tt = rs_team.Fields("team_name")
rs_team.Close
Else
tt = ""
rs_team.Close
End If

Sheet2.activate

Sheet2.Range("B6").Value = "Team Name"
Sheet2.Range("B6:B6").HorizontalAlignment = xlCenter
Sheet2.Range("B6:B6").MergeCells = True
Sheet2.Range("B6:B6").font.Bold = True
Sheet2.Range("B6:B6").Select
Selection.Interior.ColorIndex = 9
Selection.font.ColorIndex = 2
Sheet2.Range("B6:B6").VerticalAlignment = xlCenter
border1

Sheet2.Range("C6").Value = tt
Sheet2.Range("C6:J6").HorizontalAlignment = xlLeft
Sheet2.Range("C6:J6").MergeCells = True
Sheet2.Range("C6:J6").font.Bold = True
Sheet2.Range("C6:J6").Select
Selection.Interior.ColorIndex = 19
border1

End If

'Customer Name
Call cus_list(sTemp1, cus_sel)

If cus_sel = False Then
qry_cust = " 1=1 "
Else
qry_cust = "pd.customer_division_imprint_id in (" & sTemp1 & ")"
End If

'Workflow Name
Call workflow_list(sTemp2, wf_sel)

If wf_sel = False Then
qry_wf = " 1=1 "
Else
qry_wf = "pd.workflow_id in (" & sTemp2 & ")"
End If

'Stage Name
Call stage_list(sTemp3, stage_sel)

If stage_sel = False Then
qry_stage = " 1=1 "
Else
    If wo_type = "iwo" Then
        qry_stage = "sas.stage_id in (" & sTemp3 & ")"
    Else
        qry_stage = "ewd.stage_id in (" & sTemp3 & ")"
    End If
End If

'To get VIR exclude SAS by Team
Call vir_sas_exclude(sTemp, sas_exclude)

If wo_type = "iwo" Then
    If sas_exclude = "" Then
    sas_exclude = "1=1"
    Else
    sas_exclude = "sas.stage_id not in (" & sas_exclude & ")"
    End If
Else
    If sas_exclude = "" Then
    sas_exclude = "1=1"
    Else
    sas_exclude = "ewd.stage_id not in (" & sas_exclude & ")"
    End If
End If

'Progress Bar Reset to Default Width
LabelProgress.Width = 1

    If wo_type = "iwo" Then
    progress_status.Caption = "Checking IWO Records..."
    Else
    progress_status.Caption = "Checking EWO Records..."
    End If

str1 = iwo_query

Set cmd.ActiveConnection = con_rep
    str1 = Replace(str1, "<qry_team>", qry_team)
    str1 = Replace(str1, "<qry_cust>", qry_cust)
    str1 = Replace(str1, "<qry_wf>", qry_wf)
    str1 = Replace(str1, "<qry_stage>", qry_stage)
    str1 = Replace(str1, "<qry_date>", qry_date)
    str1 = Replace(str1, "<qry_sas_exclude>", sas_exclude)
    str1 = Replace(str1, "<qry_team1>", qry_team1)
    
    If wo_type = "ewo" Then
        If (sTemp = "'36'" Or sTemp = "'146'") Then
            str1 = Replace(str1, "<xml_team_id>", sTemp)
        Else
            str1 = Replace(str1, "<xml_team_id>", "'1'")
        End If
    End If
    
cmd.CommandText = str1
'Debug.Print str1
'MsgBox str1
cmd.CommandType = adCmdText

    Set rs_iwo = cmd.Execute

    If rs_iwo.RecordCount > 0 Then
    
    Sheet2.activate
    
    record_counter = 0
    
    If wo_type = "iwo" Then
    progress_bar_caption = "Populating IWO Records..."
    Else
    progress_bar_caption = "Populating EWO Records..."
    End If
    progress_status.Caption = progress_bar_caption
    
        Do Until rs_iwo.EOF
        
        progress_status.Caption = progress_bar_caption & " (" & (rs_iwo.RecordCount - record_counter) & ")"
        
        If wo_type = "ewo" Then
            If Not IsNull(rs_iwo.Fields("is_exclude")) And rs_iwo.Fields("is_exclude") <> "" And rs_iwo.Fields("is_exclude") = "y" Then GoTo exi
        End If
        
        If IsNull(rs_iwo.Fields("team_id")) Or rs_iwo.Fields("team_id") = "" Then
            MsgBox "For Project " & (rs_iwo.Fields("project_id")) & " - Customer '" & Trim(rs_iwo.Fields("customer_name")) & " - " & rs_iwo.Fields("wf_name") & "' is not associated to any team. Please associate and rerun VIR"
            End
        End If
        
        sno = sno
        customer_name = rs_iwo.Fields("customer_name")
        wf_name = rs_iwo.Fields("wf_name")
        project_id = rs_iwo.Fields("project_id")
        project_name = rs_iwo.Fields("project_name")
        book_title = rs_iwo.Fields("book_title")
        pname = rs_iwo.Fields("pname")
        sub_pname = rs_iwo.Fields("sub_pname")
        product_id = rs_iwo.Fields("product_id")
        
        If (InStr(1, product_id, "1") And CInt(rs_iwo.Fields("team_id")) = "131") Then
        pname = "Non-Reprint"
        End If
        
        If (CInt(rs_iwo.Fields("team_id")) = "131") Then
        rsTitleCnt.Open "select proj_cnt,date_on from (select count(project_id)as proj_cnt, year(pd.date_on) as date_on from workflow.project_details pd, ems.team_customer tc where pd.date_on >= timestamp(concat(year(current_date()),'-01-01 00:00:00'),'05:30') and tc.team_id = '131' and tc.customer_division_imprint_id = pd.customer_division_imprint_id and tc.workflow_id = pd.workflow_id and pd.customer_division_imprint_id in ('447','369') and pd.project_id <= '" & rs_iwo.Fields("project_id") & "' " & _
        "UNION " & _
        "select count(project_id)as proj_cnt, year(pd.date_on) as date_on from workflow.project_details pd, ems.team_customer tc where pd.date_on >= timestamp(concat(year(current_date())-1,'-01-01 00:00:00'),'05:30') and tc.team_id = '131' and tc.customer_division_imprint_id = pd.customer_division_imprint_id and tc.workflow_id = pd.workflow_id and pd.customer_division_imprint_id in ('447','369') and pd.project_id <= '" & rs_iwo.Fields("project_id") & "') as temp where temp.proj_cnt>0", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
            If rsTitleCnt.RecordCount > 0 Then
                title_count = rsTitleCnt.Fields("proj_cnt")
                year_id = rsTitleCnt.Fields("date_on")
                rsTitleCnt.Close
            Else
                title_count = ""
                year_id = ""
                rsTitleCnt.Close
            End If
        End If
        
        'Based on Arun request, excluded LARGEPRINT, DANTE product type and Hachette Book Group Perseus Customer IWO schedule on 14-Sep-2018
        If (wo_type = "iwo" And CInt(rs_iwo.Fields("team_id")) = "36") Then
             If InStr(1, product_id, "8") Or InStr(1, product_id, "129") Or InStr(1, product_id, "130") Or InStr(1, product_id, "131") Or InStr(1, product_id, "132") Or InStr(1, product_id, "133") Or CInt(rs_iwo.Fields("customer_division_imprint_id")) = 424 Then
             
             rsVault.Open "select customer_id from lgms.customer_division_imprint cdi where cdi.customer_division_imprint_id = '" & rs_iwo.Fields("customer_division_imprint_id") & "' and cdi.customer_id = '37'", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                    
                If rsVault.RecordCount > 0 Then
                    rsVault.Close
                    GoTo exi
                Else
                    rsVault.Close
                End If
             End If
        End If
        
        
        If CInt(rs_iwo.Fields("cycle_number")) > 0 Then
        cycle_number = rs_iwo.Fields("cycle_number")
        deliverable_label = rs_iwo.Fields("deliverable_label") & " " & cycle_number
        Else
        cycle_number = rs_iwo.Fields("cycle_number")
        deliverable_label = rs_iwo.Fields("deliverable_label")
        End If

        If wo_type = "iwo" Then
            If CInt(rs_iwo.Fields("batch_number")) > 0 Then
            batch_number = CInt(rs_iwo.Fields("batch_number"))
            Else
            batch_number = ""
            End If
        ElseIf rs_iwo.Fields("batch_number") <> "" Then
        batch_number = rs_iwo.Fields("batch_number")
        Else
        batch_number = ""
        End If
        
        If IsNull(rs_iwo.Fields("comments")) Then comments = "" Else comments = rs_iwo.Fields("comments")
        
        If wo_type = "iwo" Then
            If OptionButton1.Value = True Then
            
                'Receipt date
                If Not IsNull(rs_iwo.Fields("receipt_date_sas")) Then
                
                    str2 = rs_iwo.Fields("receipt_date_sas")
                    
                    sas_id = CInt(rs_iwo.Fields("stage_id"))
                    
                    'Commented SAS ID = 6 based on Panner request on 30-Sep-16.
                    'If SAS_ID = 6 Then
                    
'                    If CInt(rs_iwo.Fields("workflow_id")) = 7 Then 'Hachette Composition - Hardcoded 'Finals' SAS due to improper workflow sequence definition in Texflow. By Boopathi on 3-Feb-2015
'                    receipt_date_sas = rs_iwo.Fields("receipt_date_sas") & ",1013"
'                    Else
'                    receipt_date_sas = rs_iwo.Fields("receipt_date_sas")
'                    End If
                    
                    'Commented SAS ID = 6 based on Panner request on 30-Sep-16.
                    'rs_receipt_date.Open "select workorder_id, TIMESTAMP(date_in,'05:30') as end_date, TIMESTAMP(date_in,'" & rs_iwo.Fields("timezone_value") & "') as est_end_date from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                    "and wd.stage_activity_step_id in (" & rs_iwo.Fields("receipt_date_sas") & ") and wd.status_id <> 30 and cycle_number='" & rs_iwo.Fields("cycle_number") & "' order by workorder_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                    
                    'Else
                    
'                   Commented SAS ID = 6 based on Jeeva request on 6-Feb-2020.
                    If sas_id = 6 And CInt(rs_iwo.Fields("workflow_id")) = 4 And (CInt(rs_iwo.Fields("team_id")) = "4" Or CInt(rs_iwo.Fields("team_id")) = "91") Then 'Trade - Hardcoded 'Finals' SAS due to improper workflow sequence definition in Texflow. By Boopathi on 2-Mar-2020
                    receipt_date_sas = rs_iwo.Fields("receipt_date_sas") & ",1994"
                    
                    rs_receipt_date.Open "select workorder_id, TIMESTAMP(date_in,'05:30') as end_date, TIMESTAMP(date_in,'" & rs_iwo.Fields("timezone_value") & "') as est_end_date from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                    "and wd.stage_activity_step_id in (" & receipt_date_sas & ") and wd.status_id <> 30 and cycle_number='" & rs_iwo.Fields("cycle_number") & "' order by workorder_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                    
                   'Hardcoded 'Castoff' SAS due to Revised CastOff IRD Capture - Updated by Boopathi on 30-Jul-2018.
                    ElseIf deliverable_label = "Revised Castoff" And (CInt(rs_iwo.Fields("team_id")) = "4" Or CInt(rs_iwo.Fields("team_id")) = "91") Then
                    
                    createdOn = rs_iwo.Fields("created_on")
                    createdOn = format(createdOn, "yyyy-mm-dd hh:mm:ss")
                    
                    'rs_receipt_date.Open "select convert(TIMESTAMP('" & createdOn & "','05:30') using utf8) as end_date, convert(TIMESTAMP('" & createdOn & "','" & rs_iwo.Fields("timezone_value") & "')using utf8) as est_end_date from dual", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                    rs_receipt_date.Open "select convert(TIMESTAMP(p.created_on,'05:30') using utf8) as end_date, convert(TIMESTAMP(p.created_on,'" & rs_iwo.Fields("timezone_value") & "')using utf8) as est_end_date from workflow.project_deliverables_schedule_details p where p.project_id = '" & rs_iwo.Fields("project_id") & "' and p.stage_activity_step_id = '" & rs_iwo.Fields("delivery_date_sas") & "' " & _
                    "and p.version_id in (select (p1.version_id+0.1) from workflow.project_deliverables_schedule_details_history p1 where p1.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                    "and p1.stage_activity_step_id = '" & rs_iwo.Fields("delivery_date_sas") & "')", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                                       
                                       
                    createdOn = ""
                                       
                    ElseIf (CInt(rs_iwo.Fields("team_id")) = "58" Or CInt(rs_iwo.Fields("team_id")) = "92") And sas_id = 6 Then 'HARDCODED AS REQUESTED BY SUBASH based on TF00020347

                    'rs_receipt_date.Open "select workorder_id, TIMESTAMP(date_in,'05:30') as end_date, TIMESTAMP(date_in,'" & rs_iwo.Fields("timezone_value") & "') as est_end_date from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                    "and wd.stage_activity_step_id = '" & rs_iwo.Fields("receipt_date_sas") & "' and wd.status_id <> 30 and cycle_number='" & rs_iwo.Fields("cycle_number") & "' order by workorder_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText

                    receipt_date_sas = rs_iwo.Fields("receipt_date_sas") & ",999"
                    
                    rs_receipt_date.Open "select workorder_id, TIMESTAMP(date_in,'05:30') as end_date, TIMESTAMP(date_in,'" & rs_iwo.Fields("timezone_value") & "') as est_end_date from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                    "and wd.stage_activity_step_id in (" & receipt_date_sas & ") and wd.status_id <> 30 and cycle_number='" & rs_iwo.Fields("cycle_number") & "' order by workorder_id asc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText


                    Else
                    
                    rs_receipt_date.Open "select workorder_id, TIMESTAMP(end_date,'05:30') as end_date, TIMESTAMP(end_date,'" & rs_iwo.Fields("timezone_value") & "') as est_end_date from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                    "and wd.stage_activity_step_id in ('" & rs_iwo.Fields("receipt_date_sas") & "') and wd.status_id = 50 and cycle_number='" & rs_iwo.Fields("cycle_number") & "' order by workorder_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                    
                    End If
                    
                    If rs_receipt_date.RecordCount > 0 Then
                        If CInt(rs_iwo.Fields("timezone_id")) = 49 Then
                        receipt_date = rs_receipt_date.Fields("end_date")
                        Else
                        receipt_date = rs_receipt_date.Fields("est_end_date")
                        End If
                    Else
                    receipt_date = ""
                    End If
                rs_receipt_date.Close
                Else
                receipt_date = ""
                End If
                'end receipt date
                
                'HARDCODED BASED ON JEEVA AND SATHISHKUMAR JAYARAMAN REQUEST on 12-JULY-2018
                'VAULT FPP/REV/FINALS/OUTSIDE
                If receipt_date = "" Then
                 'If str2 = 920 Or str2 = 943 Or str2 = 2008 Or str2 = 1054 Then
                 If InStr(1, str2, "920") Or InStr(1, str2, "943") Or InStr(1, str2, "2008") Or InStr(1, str2, "1054") Then
                 GoTo exi
                 End If
                End If

            
            Else
                If CInt(rs_iwo.Fields("timezone_id")) = 49 Then
                receipt_date = rs_iwo.Fields("ist_receipt_date")
                Else
                receipt_date = rs_iwo.Fields("est_receipt_date")
                End If
            End If
        Else
            If CInt(rs_iwo.Fields("timezone_id")) = 49 Then
            receipt_date = rs_iwo.Fields("ist_receipt_date")
            Else
            receipt_date = rs_iwo.Fields("est_receipt_date")
            End If
        End If
        

        If CInt(rs_iwo.Fields("timezone_id")) = 49 Then
        planned_date = format(rs_iwo.Fields("ist_estimate_date"), "yyyy-mm-dd hh:mm:ss AM/PM")
        Else
        planned_date = format(rs_iwo.Fields("est_estimate_date"), "yyyy-mm-dd hh:mm:ss AM/PM")
        End If
        
        timezone_date_format = format(planned_date, "yyyy-mm-dd")
        
        'to handle daylight savings
        If CInt(rs_iwo.Fields("timezone_id")) = 14 Then
        
        rs_timezone_value.Open "select if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6)) as timezone_value from workflow.cfg_datetime_preference_est " & _
        "where date('" & timezone_date_format & "') between start_date and end_date", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
        timezone_value = rs_timezone_value.Fields("timezone_value")
        
        rs_timezone_value.Close
        
        ElseIf CInt(rs_iwo.Fields("timezone_id")) = 27 Then
        
        rs_timezone_value.Open "select if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6)) as timezone_value from workflow.cfg_datetime_preference_dst " & _
        "where date('" & timezone_date_format & "') between start_date and end_date", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
        timezone_value = rs_timezone_value.Fields("timezone_value")
        
        rs_timezone_value.Close
        
        Else
        
        timezone_value = rs_iwo.Fields("timezone_value")
        
        End If
        
        'Planned Date Start - for daylight savings update - Temporary fix - This block has to be removed once datetime picker in Texflow has been handled with future daylight savings.
        If CInt(rs_iwo.Fields("timezone_id")) = 14 Then
            planned_date = rs_iwo.Fields("planned_date")
            planned_date = format(planned_date, "yyyy-mm-dd hh:mm:ss")
            created_on = rs_iwo.Fields("created_on")
            created_on = format(created_on, "yyyy-mm-dd hh:mm:ss")
            rs_planned_date.Open "select convert(timestamp('" & planned_date & "',(select if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6)) as timezone_value from workflow.cfg_datetime_preference_est " & _
            "where date('" & created_on & "') between start_date and end_date)) using utf8) as planned_date from dual", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                    
                    If rs_planned_date.RecordCount > 0 Then
                        planned_date = rs_planned_date.Fields("planned_date")
                        planned_date = format(planned_date, "yyyy-mm-dd hh:mm:ss AM/PM")
                    End If
            rs_planned_date.Close
        ElseIf CInt(rs_iwo.Fields("timezone_id")) = 27 Then
            planned_date = rs_iwo.Fields("planned_date")
            planned_date = format(planned_date, "yyyy-mm-dd hh:mm:ss")
            created_on = rs_iwo.Fields("created_on")
            created_on = format(created_on, "yyyy-mm-dd hh:mm:ss")
            rs_planned_date.Open "select convert(timestamp('" & planned_date & "',(select if(left(right(gmt_value,6),1)='+',right(gmt_value,5),right(gmt_value,6)) as timezone_value from workflow.cfg_datetime_preference_dst " & _
            "where date('" & created_on & "') between start_date and end_date)) using utf8) as planned_date from dual", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                    
                    If rs_planned_date.RecordCount > 0 Then
                        planned_date = rs_planned_date.Fields("planned_date")
                        planned_date = format(planned_date, "yyyy-mm-dd hh:mm:ss AM/PM")
                    End If
            rs_planned_date.Close
        End If
        'Planned Date End
        
        
        If wo_type = "iwo" Then
            'Delivered date
            If Not IsNull(rs_iwo.Fields("delivery_date_sas")) Then
               
                rs_deliver_date.Open "select workorder_id, TIMESTAMP(end_date,'05:30') as end_date, timestamp(end_date,'" & timezone_value & "') as est_end_date from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                "and wd.stage_activity_step_id = '" & rs_iwo.Fields("delivery_date_sas") & "' and wd.status_id = 50 and cycle_number='" & rs_iwo.Fields("cycle_number") & "' order by workorder_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                
                If rs_deliver_date.RecordCount > 0 Then
                    delivered_date = format(rs_deliver_date.Fields("end_date"), "yyyy-mm-dd hh:mm:ss AM/PM")
                    est_delivered_date = format(rs_deliver_date.Fields("est_end_date"), "yyyy-mm-dd hh:mm:ss AM/PM")
                    actual_end_time = Right(delivered_date, 11)
                    actual_end_time_est = Right(est_delivered_date, 11)
                    
                ElseIf (CInt(rs_iwo.Fields("team_id")) = "99" And CInt(rs_iwo.Fields("workflow_id")) = "66") Then
                    delivered_date = ""
                    est_delivered_date = ""
                    actual_end_time = ""
                    actual_end_time_est = ""
                    
                Else
                    delivered_date = rs_iwo.Fields("ist_completed_date")
                    est_delivered_date = rs_iwo.Fields("est_completed_date")
                    actual_end_time = rs_iwo.Fields("ist_completed_time")
                    actual_end_time_est = rs_iwo.Fields("est_completed_time")
                End If
            rs_deliver_date.Close
            Else
                delivered_date = ""
                est_delivered_date = ""
                actual_end_time = ""
                actual_end_time_est = ""
            End If
            'end delivered date
        Else
            'for EWO
            rs_deliver_date.Open "select external_workorder_id, TIMESTAMP(end_time,'05:30') as end_date, timestamp(end_time,'" & timezone_value & "') as est_end_date from workflow.external_workorder_details ewd where ewd.project_id = '" & rs_iwo.Fields("project_id") & "' " & _
                "and ewd.external_workorder_id = '" & rs_iwo.Fields("external_workorder_id") & "' and ewd.status_id = 50 and ewd.cycle_id='" & rs_iwo.Fields("cycle_number") & "' order by external_workorder_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
                
            If rs_deliver_date.RecordCount > 0 Then
                delivered_date = format(rs_deliver_date.Fields("end_date"), "yyyy-mm-dd hh:mm:ss AM/PM")
                est_delivered_date = format(rs_deliver_date.Fields("est_end_date"), "yyyy-mm-dd hh:mm:ss AM/PM")
                actual_end_time = Right(delivered_date, 11)
                actual_end_time_est = Right(est_delivered_date, 11)
            Else
                delivered_date = rs_iwo.Fields("ist_completed_date")
                est_delivered_date = rs_iwo.Fields("est_completed_date")
                actual_end_time = rs_iwo.Fields("ist_completed_time")
                actual_end_time_est = rs_iwo.Fields("est_completed_time")
            End If
            rs_deliver_date.Close
        End If
        
        If CInt(rs_iwo.Fields("timezone_id")) = 49 Then
        comp_date = delivered_date
        Else
        comp_date = est_delivered_date
        End If
        
        If comp_date <> "" Then
            If CInt(rs_iwo.Fields("timezone_id")) = 49 Then
            actual_end = format(actual_end_time, "HH:mm:ss")
            Else
            actual_end = format(actual_end_time_est, "HH:mm:ss")
            End If
        Else
        actual_end = ""
        End If
        
        timezone = rs_iwo.Fields("timezone")
        
        If rs_iwo.Fields("force_time_delivery") = "y" Then
        cutoff_time = format(Right(planned_date, 11), "HH:mm:ss")
        Else
        cutoff_time = format(rs_iwo.Fields("cutoff_time") & ":00", "HH:mm:ss")
        End If

        'Status
        If comp_date <> "" Then
            If format(comp_date, "YYYY-MM-DD") > format(planned_date, "YYYY-MM-DD") Then
            
                Status = "Delay"
            
            ElseIf format(comp_date, "YYYY-MM-DD") < format(planned_date, "YYYY-MM-DD") Then
            
                Status = "Ahead"
            
            ElseIf format(comp_date, "YYYY-MM-DD") = format(planned_date, "YYYY-MM-DD") Then
            
                If TimeEarlierThan(actual_end, cutoff_time) = True Then
                    Status = "On Time"
                Else
                    Status = "Delay"
                End If
            
            End If
        Else
            
            Status = "WIP"
        
        End If
        
        If Status <> "WIP" Then
            If CInt(rs_iwo.Fields("team_id")) = "4" Or CInt(rs_iwo.Fields("team_id")) = "91" Or CInt(rs_iwo.Fields("team_id")) = "58" Or CInt(rs_iwo.Fields("team_id")) = "92" _
            Or CInt(rs_iwo.Fields("team_id")) = "46" Or CInt(rs_iwo.Fields("team_id")) = "93" Or CInt(rs_iwo.Fields("team_id")) = "36" Or CInt(rs_iwo.Fields("team_id")) = "99" Or CInt(rs_iwo.Fields("team_id")) = "146" Then
                Status = "Delivered"
            End If
        End If

        If rs_iwo.Fields("force_time_delivery") = "y" Then
        force_time_delivery = "Yes"
        Else
        force_time_delivery = ""
        End If
        
        If IsNull(rs_iwo.Fields("reason_code")) Then reason_code = "" Else reason_code = rs_iwo.Fields("reason_code")
        
        If wo_type = "iwo" Then
            'Complexity
            rs_complexity.Open "select vir_complexity_id, vir_complexity_name, vir_complexity_query " & _
            "from workflow.cfg_vir_complexity_mapping c where vir_complexity_id = '" & rs_iwo.Fields("complexity_mapping_id") & "' limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
            
            If rs_complexity.RecordCount > 0 Then
            
            str1 = rs_complexity.Fields("vir_complexity_query")
            
            Set cmd.ActiveConnection = con_rep
            str1 = Replace(str1, "<projectid>", rs_iwo.Fields("project_id"))
            cmd.CommandText = str1
            'MsgBox str1
            cmd.CommandType = adCmdText
            
            Set rs_label = cmd.Execute
            
                If rs_label.RecordCount > 0 Then
                
                complexity = rs_label.Fields("complexity")
                
                End If
            End If
            rs_complexity.Close
            'Complexity End
        Else
            complexity = rs_iwo.Fields("complexity")
        End If
        
        If (CInt(rs_iwo.Fields("team_id")) = "131") Then
        
        rs_JG_Complexity.Open "select if(c.complexity_level_id between 100 and 120,concat('Level',' ',c.complexity_level_name,' (Approved)'), " & _
        "concat(c.complexity_level_name,' (Approved)')) as complexity " & _
        "from lgms.cfg_complexity_level  c where " & _
        "c.complexity_level_id=(SELECT p.approved_complexity_level_id FROM workflow.project_complexity_approval p " & _
        "where p.project_id='" & rs_iwo.Fields("project_id") & "' and p.category_id=1 and p.approval_type_id=1 and p.approval_status_id=1 " & _
        "and p.version_id=(select max(pca.version_id) from workflow.project_complexity_approval pca " & _
        "where pca.project_id = p.project_id And pca.category_id = p.category_id " & _
        "and pca.approval_status_id=p.approval_status_id and p.approval_type_id=pca.approval_type_id) limit 1) " & _
        "Union " & _
        "select if(c.complexity_level_id between 100 and 120,concat('Level',' ',c.complexity_level_name), " & _
        "c.complexity_level_name) as customer_composition_complexity " & _
        "from lgms.cfg_complexity_level c " & _
        "where c.complexity_level_id=(SELECT customer_complexity_level_id  FROM workflow.budget_estimate be, " & _
        "workflow.budget_estimate_service_item_mapping b, lgms.service_item_activity_mapping siam, lgms.cfg_service_item csi " & _
        "where be.project_id='" & rs_iwo.Fields("project_id") & "' and be.version_id = (select max(be1.version_id) from workflow.budget_estimate be1 " & _
        "where be.project_id=be1.project_id) and b.budget_estimate_id= be.budget_estimate_id " & _
        "and siam.service_item_id=b.service_item_id and b.service_item_id = csi.service_item_id " & _
        "and siam.activity_id=18 order by composition_priority_no limit 1) limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
            If rs_JG_Complexity.RecordCount > 0 Then
            
            complexity = rs_JG_Complexity.Fields("complexity")
            
            End If
        
        rs_JG_Complexity.Close
        
        End If
        
        If wo_type = "iwo" Then
            'MS Pages
            rs_ms_pages.Open "select vir_input_units_id, vir_input_units_name, vir_input_units_query " & _
            "from workflow.cfg_vir_input_units_mapping c where vir_input_units_id = '" & rs_iwo.Fields("ms_pages_mapping_id") & "' limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
            
            If rs_ms_pages.RecordCount > 0 Then
            
            str1 = rs_ms_pages.Fields("vir_input_units_query")
            
            Set cmd.ActiveConnection = con_rep
            str1 = Replace(str1, "<projectid>", rs_iwo.Fields("project_id"))
            str1 = Replace(str1, "<cycle>", rs_iwo.Fields("cycle_number"))
            cmd.CommandText = str1
            'MsgBox str1
            cmd.CommandType = adCmdText
            
            Set rs_ms_pages_label = cmd.Execute
            
                If rs_ms_pages_label.RecordCount > 0 Then
                
                ms_pages = rs_ms_pages_label.Fields("page_count")
                
                End If
            End If
            rs_ms_pages.Close
            'MS Pages End
        Else
            ms_pages = rs_iwo.Fields("input_units")
        End If
        
        If wo_type = "iwo" Then
            'Delivered Pages
            rs_del_pages.Open "select vir_output_units_id, vir_output_units_name, vir_output_units_query " & _
            "from workflow.cfg_vir_output_units_mapping c where vir_output_units_id = '" & rs_iwo.Fields("delivered_pages_mapping_id") & "' limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
            
            If rs_del_pages.RecordCount > 0 Then
            
            str1 = rs_del_pages.Fields("vir_output_units_query")
            
            Set cmd.ActiveConnection = con_rep
            str1 = Replace(str1, "<projectid>", rs_iwo.Fields("project_id"))
            str1 = Replace(str1, "<stageid>", rs_iwo.Fields("stage_id"))
            str1 = Replace(str1, "<cycle>", rs_iwo.Fields("cycle_number"))
            cmd.CommandText = str1
            'MsgBox str1
            cmd.CommandType = adCmdText
            
            Set rs_del_pages_label = cmd.Execute
            
                If rs_del_pages_label.RecordCount > 0 Then
                
                del_pages = rs_del_pages_label.Fields("page_count")
                
                End If
            End If
            rs_del_pages.Close
            'Delivered Pages End
        Else
            del_pages = rs_iwo.Fields("output_units")
        End If

        
        If wo_type = "iwo" Then
            rs_corr_cnt.Open "select project_id from workflow.correction_count_entity where project_id=" & rs_iwo.Fields("project_id") & " " & _
            "and revises_id=" & rs_iwo.Fields("cycle_number") & " and stage_id=" & rs_iwo.Fields("stage_id") & " order by version_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
            
            If rs_corr_cnt.RecordCount > 0 Then
            cnt = "Yes"
            Else
            cnt = "No"
            End If
            rs_corr_cnt.Close
        Else
            If rs_iwo.Fields("corrections_count_required") = "y" Then
            cnt = "Yes"
            Else
            cnt = "No"
            End If
        End If

        
        customer_contact = rs_iwo.Fields("customer_contact")
        
        pm_pc = rs_iwo.Fields("pm_pc")
        
        csr_name = rs_iwo.Fields("csr_name")
        
        'Embargoed
        If rs_iwo("is_embargoed") = "y" Then
        is_embargoed = "Yes"
        Else
        is_embargoed = ""
        End If
        
        'Composition
        If CInt(rs_iwo.Fields("workflow_id")) = "3" Or CInt(rs_iwo.Fields("team_id")) = "5" Then
        rs_comp.Open "select project_id,(select group_concat(vendor_id) from finance.purchase_order_details pod,finance.purchase_order_service_item_mapping posim " & _
        "where pod.project_id=pd.project_id and posim.purchase_order_id=pod.purchase_order_id) as vendor_id,(select group_concat(service_item_id) from finance.purchase_order_details pod, " & _
        "finance.purchase_order_service_item_mapping posim where pod.project_id=pd.project_id and posim.purchase_order_id=pod.purchase_order_id) as service_id from workflow.project_details pd " & _
        "where pd.project_id = " & rs_iwo.Fields("project_id") & " and (select group_concat(service_item_id) from finance.purchase_order_details pod, finance.purchase_order_service_item_mapping posim where pod.project_id=pd.project_id and posim.purchase_order_id=pod.purchase_order_id) " & _
        "in (select service_item_id from lgms.cfg_service_item where service_item_name like '%composition%')", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        If rs_comp.RecordCount > 0 Then
        composition = "Vendor"
        rs_comp.Close
        Else
        composition = "Jouve India"
        rs_comp.Close
        End If
        Else
        composition = "Jouve India"
        End If
        
        billing_status = rs_iwo.Fields("billing_status")
        
        est_distro_date = rs_iwo.Fields("est_distro_date")
        
        If rs_iwo.Fields("isbn") <> "" Then
            isbn = rs_iwo.Fields("isbn")
        Else
            isbn = ""
        End If
        
        If rs_iwo.Fields("workorder_type") <> "" Then
            workorder_type = rs_iwo.Fields("workorder_type")
        Else
            workorder_type = ""
        End If
        
        If rs_iwo.Fields("designer_contact") <> "" Then
            designer_contact = rs_iwo.Fields("designer_contact")
        Else
            designer_contact = ""
        End If
        
        If rs_iwo.Fields("prh_team") <> "" Then
            prh_team = rs_iwo.Fields("prh_team")
        Else
            prh_team = ""
        End If
        
        If Status = "Delay" Then
        
        'Delay-Color Code (RED)
        ActiveSheet.Rows(row_inv).Select
        Selection.font.ColorIndex = 3
        
        diff_mins = DateDiff("n", planned_date, comp_date)
            If diff_mins <= 30 Then
            t1 = t1 + 1
            Msg = "< 30 Mins"
            ElseIf diff_mins > 30 And diff_mins <= 60 Then
            t2 = t2 + 1
            Msg = "30 Mins - 1 Hour"
            ElseIf diff_mins > 60 And diff_mins <= 120 Then
            t3 = t3 + 1
            Msg = "1 Hour - 2 Hours"
            ElseIf diff_mins > 120 And diff_mins <= 180 Then
            t4 = t4 + 1
            Msg = "2 Hours - 3 Hours"
            ElseIf diff_mins > 180 And diff_mins <= 240 Then
            t5 = t5 + 1
            Msg = "3 Hours - 4 Hours"
            ElseIf diff_mins > 240 And diff_mins <= 300 Then
            t6 = t6 + 1
            Msg = "4 Hours - 5 Hours"
            ElseIf diff_mins > 300 And diff_mins <= 360 Then
            t7 = t7 + 1
            Msg = "5 Hours - 6 Hours"
            ElseIf diff_mins > 360 Then
            t8 = t8 + 1
            Msg = "> 6 Hours"
            End If
            
        project_name = rs_iwo.Fields("project_id") & " " & rs_iwo.Fields("project_name")
        If rs_iwo.Fields("reason_code") = "" Or IsNull(rs_iwo.Fields("reason_code")) Then reason_code = "" Else reason_code = rs_iwo.Fields("reason_code")
        'reason_code = rs_iwo.Fields("reason_code")
        If rs_iwo.Fields("comments") = "" Or IsNull(rs_iwo.Fields("comments")) Then comments = "" Else comments = rs_iwo.Fields("comments")
        'comments = rs_iwo.Fields("comments")
        delay_cnter = delay_cnter + 1
        
        If CheckBox1.Value = True Then
        Call summary(project_name, deliverable_label, Msg, delay_cnter, reason_code, comments)
        End If
        
        project_name = rs_iwo.Fields("project_name")
        
        End If
                
        'Completed - Color Code (Yellow)
        If comp_date <> "" Then
            ActiveSheet.Rows(row_inv).Select
            Selection.Interior.ColorIndex = 6
        End If
        
'Commented on 26-Jul-2016
'        'Overdue Color Code (Red)
'        If (IsNull(comp_date) Or comp_date = "") And Format(planned_date, "yyyy-mm-dd") < Format(Now(), "yyyy-mm-dd") Then
'            Sheet1.Rows(row_inv).Select
'            Selection.Font.ColorIndex = 3
'        End If
        
'Added on 26-Jul-2016 to Capture color coded based on the timezone
        'Overdue Color Code (Red)
        curr_time = ""
        curr_date = ""
        If (Left(timezone_value, 1)) = "-" Then
        curr_time = Replace(timezone_value, "-", "")
        curr_time = CInt(Left(curr_time, 2)) * 60 + CInt(Right(curr_time, 2))
        curr_time = "-" & curr_time
        ElseIf (Left(timezone_value, 1)) = "+" Then
        curr_time = Replace(timezone_value, "+", "")
        curr_time = CInt(Left(curr_time, 2)) * 60 + CInt(Right(curr_time, 2))
        ElseIf timezone_value <> "" Then
        curr_time = Replace(timezone_value, "+", "")
        curr_time = CInt(Left(curr_time, 2)) * 60 + CInt(Right(curr_time, 2))
        End If
        
        curr_date = format(DateAdd("n", curr_time, Now()), "yyyy-mm-dd")
        If (IsNull(comp_date) Or comp_date = "") And format(planned_date, "yyyy-mm-dd") < format(curr_date, "yyyy-mm-dd") Then
            Sheet1.Rows(row_inv).Select
            Selection.font.ColorIndex = 3
        End If
        
        If CInt(rs_iwo.Fields("is_onhold")) = "2" Then
            ActiveSheet.Rows(row_inv).Select
            Selection.Interior.ColorIndex = 22
        End If
        
        If wo_type = "ewo" Then
            If CInt(rs_iwo.Fields("status_id")) = "30" Then
                ActiveSheet.Rows(row_inv).Select
                Selection.Interior.ColorIndex = 22
            End If
        End If
        
        rs_query.Open "select * from roundup._issue where project_id = " & rs_iwo.Fields("project_id") & "  and _status not in (7,8) and issue_type_id=1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
        If rs_query.RecordCount > 0 Then
        query_flag = 1
        Else
        query_flag = 0
        End If
        rs_query.Close
        
        'Query Color Code
        If (IsNull(comp_date) Or comp_date = "") And query_flag = 1 Then
            Status = "Query"
            ActiveSheet.Rows(row_inv).Select
            Selection.Interior.ColorIndex = 44
        End If
        
        'Sample Castoff Approval check for TUK Team START
        If InStr(1, sTemp, "'58'") Or InStr(1, sTemp, "'92'") Then
        
        rs_query_approval.Open "select workorder_id from workflow.workorder_details wd where wd.project_id = '" & rs_iwo.Fields("project_id") & "'  and wd.status_id not in (50,30) and wd.stage_activity_step_id = '1333' limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
        'rs_query_approval.Open "select approved_by_customer from workflow.puk_email_approval_details where project_id = '" & rs_iwo.Fields("project_id") & "'  order by puk_email_approval_details_id desc limit 1", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
        samplecastoff_flag = 0
        If rs_query_approval.RecordCount > 0 Then
            'If rs_query_approval.Fields("approved_by_customer") = "y" Then
            samplecastoff_flag = 1
        Else
            samplecastoff_flag = 0
            'End If
        End If
        rs_query_approval.Close
        
        'Sample Castoff Approval Color Code TUK Team
        If (InStr(1, deliverable_label, "FPP", vbTextCompare) Or InStr(1, deliverable_label, "First Proofs", vbTextCompare)) And samplecastoff_flag = 1 And comp_date = "" Then
            If IsNull(Status) Or Status = "" Then
                Status = "Sample Castoff Not Yet Approved"
            Else
            Status = Status & " and " & "Sample Castoff Not Yet Approved"
            End If
            ActiveSheet.Rows(row_inv).Select
            Selection.Interior.ColorIndex = 28
        End If
        
        End If
        'Sample Castoff Approval check for TUK Team END
        
        
qry_proj = "pd.project_id = '" & rs_iwo.Fields("project_id") & "'"

qry_stage = "s.stage_id = '" & rs_iwo.Fields("stage_id") & "'"
qry_cycle = "wd.cycle_number = '" & rs_iwo.Fields("cycle_number") & "'"

qry_stage_ewo = "wd.stage_id = '" & rs_iwo.Fields("stage_id") & "'"
qry_cycle_ewo = "wd.cycle_id = '" & rs_iwo.Fields("cycle_number") & "'"
        
If wo_type = "iwo" Then

    If (InStr(1, deliverable_label, "Vault", vbTextCompare) Or InStr(1, deliverable_label, "Spine", vbTextCompare)) Then
    
    GoTo jum:
    
    Else
            
        If (sTemp = "'36'" Or sTemp = "'146'") Then
        
        rs_sch.Open "select pd.project_id, pd.project_name, pd.workflow_id, (concat_ws(' ',(select customer_name from lgms.customer_details c where c.customer_id=cdi.customer_id), (select division_name from lgms.division_details c where c.division_id=cdi.division_id), (select imprint_name from lgms.imprint_details c where c.imprint_id=cdi.imprint_id))) as Customer, " & _
        "pt.product_name, if(wd.stage_activity_step_id in (2303,2505,1061,827,765), Ifnull((select if(cl.complexity_level_id between 100 and 120,concat('Level',' ',cl.complexity_level_name) ,cl.complexity_level_name) from lgms.cfg_complexity_level cl where cl.complexity_level_id =(select complexity_level_id from workflow.xml_job_analysis xja where xja.project_id = pd.project_id " & _
        "order by version_id desc limit 1)),(select if(cl.complexity_level_id between 100 and 120,concat('Level',' ',cl.complexity_level_name) ,cl.complexity_level_name) from lgms.cfg_complexity_level cl where cl.complexity_level_id =(select complexity_level_id from workflow.backlist_file_analysis bfa where bfa.project_id = pd.project_id limit 1))), ifnull((select if(c.complexity_level_id between 100 and 120,concat('Level','',c.complexity_level_name), c.complexity_level_name) " & _
        "from lgms.cfg_complexity_level  c where c.complexity_level_id=(SELECT p.internal_complexity_level_id FROM workflow.project_complexity_mapping p where p.project_id = pd.project_id And p.category_id = 1 and p.version_id=(select max(p1.version_id) from workflow.project_complexity_mapping p1 where p.project_id=p1.project_id and p.category_id=p1.category_id) limit 1) limit 1), (SELECT (select if(cl.complexity_level_id between 100 and 120,concat('Level',' ',complexity_level_name),concat(complexity_level_name)) from lgms.cfg_complexity_level cl where cl.complexity_level_id = ifnull(textech_complexity_level_id,customer_complexity_level_id)) " & _
        "FROM workflow.budget_estimate_service_item_mapping b, lgms.cfg_service_item cs, workflow.budget_estimate be where pd.project_id=be.project_id and b.budget_estimate_id=be.budget_estimate_id and be.version_id = (select max(version_id) from workflow.budget_estimate be1 where be1.project_id=be.project_id) and cs.service_item_id=b.service_item_id  and cs.composition_priority_no <> 1000 order by composition_priority_no limit 1)))  as compcmpx, " & _
        "s.stage_id, s.stage_name, wd.cycle_number, convert(if(wd.stage_activity_step_id in (2303,2505,1061,827,765),(Ifnull((select no_of_pages from workflow.xml_job_analysis xja where xja.project_id = pd.project_id order by version_id desc limit 1),(select bfa.no_of_pages from workflow.backlist_file_analysis bfa where bfa.project_id = pd.project_id limit 1))), (select page_count from workflow.phase1_page_count_entity p where p.project_id = pd.project_id And s.stage_id = p.stage_id and p.number=wd.cycle_number order by -sequence_no,-p.stage_id,-p.number limit 1) " & _
        ") using utf8) as typeset_pages, Ifnull((select blank_pages from workflow.xml_job_analysis xja where xja.project_id = pd.project_id order by version_id desc limit 1),(select blank_pages from workflow.backlist_file_analysis bfa where bfa.project_id = pd.project_id limit 1)) as blank_pages, " & _
        "(select input_type from workflow.cfg_input_type it where it.input_type_id = (select Ifnull((select input_file_id from workflow.xml_job_analysis xja " & _
        "where xja.project_id = pd.project_id order by version_id desc limit 1), " & _
        "(select input_type_id from workflow.backlist_file_analysis bfa where bfa.project_id = pd.project_id limit 1)))) as input_type, " & _
        "timestamp(wd.start_date,'05:30') as start_date,timestamp((select end_date from workflow.workorder_details pic where pic.project_id=wd.project_id " & _
        "and if(wd.stage_activity_step_id in (873),pic.stage_activity_step_id in (875),if(wd.stage_activity_step_id in (346),pic.stage_activity_step_id in (857),if(wd.stage_activity_step_id in (375),pic.stage_activity_step_id in (934), " & _
        "if(wd.stage_activity_step_id in (2303),pic.stage_activity_step_id in (2303),if(wd.stage_activity_step_id in (2505),pic.stage_activity_step_id in (2505),if(wd.stage_activity_step_id in (1061),pic.stage_activity_step_id in (1061), " & _
        "if(wd.stage_activity_step_id in (827),pic.stage_activity_step_id in (827),if(wd.stage_activity_step_id in (765),pic.stage_activity_step_id in (765),pic.stage_activity_step_id in (955) )))))))) " & _
        "and wd.cycle_number=pic.cycle_number and pic.status_id =50 limit 1),'05:30') as coq_out, wd.employee_assigned_to, concat(tr.fname) as Name, (select team_name from ems.team_member tm, ems.team_details td where tm.team_id=td.team_id and tm.empid =wd.employee_assigned_to and member_type_id=1 limit 1) as vendor_name, " & _
        "(select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_id, " & _
        "(select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_name " & _
        "from workflow.workorder_details wd, workflow.project_details pd, lgms.customer_division_imprint cdi, workflow.cfg_product pt, workflow.cfg_stages s, workflow.cfg_stage_activity_step sas, ems.textech_resources tr where wd.project_id = pd.project_id And pd.project_status_id <> 30 " & _
        "and " & qry_proj & " and " & qry_cust & " and " & qry_wf & " and " & qry_stage & " and " & qry_cycle & " and pd.customer_division_imprint_id= cdi.customer_division_imprint_id and pd.product_id=pt.product_id and wd.stage_activity_step_id=sas.stage_activity_step_id and sas.stage_id=s.stage_id and wd.status_id =50 and wd.stage_activity_step_id in (375, 346, 405, 873,2303,2505,1061,827,765) and wd.employee_assigned_to =tr.empid and (tr.company_id=4 or (tr.company_id = 1 and tr.resource_type_id = 2)) " & _
        "and ((wd.stage_activity_step_id in (873) and wd.approval_counter in (2)) or (wd.stage_activity_step_id in (346) and wd.approval_counter in (2)) or (wd.stage_activity_step_id in (375) and wd.approval_counter in (3)) or (wd.stage_activity_step_id in (405) and wd.approval_counter in (3)) or (wd.stage_activity_step_id in (2303) and wd.approval_counter in (0)) or (wd.stage_activity_step_id in (2505) and wd.approval_counter in (0)) or (wd.stage_activity_step_id in (1061) and wd.approval_counter in (0)) " & _
        "or (wd.stage_activity_step_id in (827) and wd.approval_counter in (0)) or (wd.stage_activity_step_id in (765) and wd.approval_counter in (0)) )", con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        'and " & date_qry2 & "
        
        Else
        
        qry_ewo1 = "select pd.project_id, pd.project_name, pd.workflow_id, (concat_ws(' ',(select customer_name from lgms.customer_details c where c.customer_id=cdi.customer_id), (select division_name from lgms.division_details c where c.division_id=cdi.division_id), (select imprint_name from lgms.imprint_details c where c.imprint_id=cdi.imprint_id))) as Customer, " & _
        "pt.product_name, (select product_sub_type_name from workflow.cfg_product_sub_type pst where pst.product_sub_type_id = pd.product_sub_type_id) as product_sub_name, " & _
        "ifnull((select if(c.complexity_level_id between 100 and 120,concat('Level','',c.complexity_level_name), c.complexity_level_name) " & _
        "from lgms.cfg_complexity_level  c where c.complexity_level_id=(SELECT p.internal_complexity_level_id " & _
        "FROM workflow.project_complexity_mapping p where p.project_id = pd.project_id And p.category_id = 1 " & _
        "and p.version_id=(select max(p1.version_id) from workflow.project_complexity_mapping p1 " & _
        "where p.project_id=p1.project_id and p.category_id=p1.category_id) limit 1) limit 1), (SELECT (select if(cl.complexity_level_id between 100 and 120,concat('Level',' ',complexity_level_name),concat(complexity_level_name)) from lgms.cfg_complexity_level cl where cl.complexity_level_id = ifnull(textech_complexity_level_id,customer_complexity_level_id)) " & _
        "FROM workflow.budget_estimate_service_item_mapping b, lgms.cfg_service_item cs, workflow.budget_estimate be where pd.project_id=be.project_id and b.budget_estimate_id=be.budget_estimate_id and be.version_id = (select max(version_id) from workflow.budget_estimate be1 where be1.project_id=be.project_id) and cs.service_item_id=b.service_item_id  and cs.composition_priority_no <> 1000 order by composition_priority_no limit 1)) as compcmpx, " & _
        "s.stage_id, s.stage_name, wd.cycle_number, (select page_count from workflow.phase1_page_count_entity p where p.project_id = pd.project_id And s.stage_id = p.stage_id and p.number=wd.cycle_number order by -sequence_no,-p.stage_id,-p.number limit 1) as typeset_pages, timestamp(wd.start_date,'05:30') as start_date, timestamp((select end_date from workflow.workorder_details pic where pic.project_id=wd.project_id and if(wd.stage_activity_step_id in (873),pic.stage_activity_step_id in (875),if(wd.stage_activity_step_id in (346),pic.stage_activity_step_id in (857),if(wd.stage_activity_step_id in (375),pic.stage_activity_step_id in (934),if(wd.stage_activity_step_id in (470),pic.stage_activity_step_id in (827),if(wd.stage_activity_step_id in (530),pic.stage_activity_step_id in (531),pic.stage_activity_step_id in (955) ))))) and wd.cycle_number=pic.cycle_number and pic.status_id =50 limit 1),'05:30') as coq_out, " & _
        "wd.employee_assigned_to, concat(tr.fname) as Name, (select team_name from ems.team_member tm, ems.team_details td where tm.team_id=td.team_id and tm.empid =wd.employee_assigned_to and member_type_id=1 limit 1) as vendor_name, " & _
        "(select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_id, " & _
        "(select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_name " & _
        "from workflow.workorder_details wd, workflow.project_details pd, lgms.customer_division_imprint cdi, workflow.cfg_product pt, workflow.cfg_stages s, workflow.cfg_stage_activity_step sas, ems.textech_resources tr where wd.project_id = pd.project_id And pd.project_status_id <> 30 " & _
        "and " & qry_proj & " and " & qry_cust & " and " & qry_wf & " and " & qry_stage & " and " & qry_cycle & " and pd.customer_division_imprint_id= cdi.customer_division_imprint_id and pd.product_id=pt.product_id and wd.stage_activity_step_id=sas.stage_activity_step_id and sas.stage_id=s.stage_id and wd.status_id =50 and wd.stage_activity_step_id in (375, 346, 405, 873,470,530) and wd.employee_assigned_to =tr.empid and (tr.company_id=4 or (tr.company_id = 1 and tr.resource_type_id = 2)) and ((wd.stage_activity_step_id in (873) and wd.approval_counter in (2)) or (wd.stage_activity_step_id in (346) and wd.approval_counter in (2)) or (wd.stage_activity_step_id in (375) and wd.approval_counter in (3)) or (wd.stage_activity_step_id in (405) and wd.approval_counter in (3)) or (wd.stage_activity_step_id in (470) and wd.approval_counter in (0)) or (wd.stage_activity_step_id in (530) and wd.approval_counter in (89)) ) "
        
        qry_ewo2 = qry_ewo1
        
        rs_sch.Open qry_ewo2, con_rep, adOpenKeyset, adLockOptimistic, adCmdText
        
        'and " & date_qry3 & "
        
        'and (sewo.customer_division_imprint_id in (258) and sewo.customer_standard_ewo_details_id in (69173))
        
        End If
        
        If rs_sch.RecordCount > 0 Then

        vendor_name = rs_sch.Fields("Name")
        
        End If
        
        rs_sch.Close
    
jum:
    
    End If

Else

qry_ewo2 = "select pd.project_id, pd.project_name, pd.workflow_id, (select workflow_name from workflow.workflow_details wd where wd.workflow_id = pd.workflow_id) as workflow_name,(concat_ws(' ',(select customer_name from lgms.customer_details c where c.customer_id=cdi.customer_id), (select division_name from lgms.division_details c where c.division_id=cdi.division_id), (select imprint_name from lgms.imprint_details c where c.imprint_id=cdi.imprint_id))) as Customer, " & _
"pt.product_name, (select product_sub_type_name from workflow.cfg_product_sub_type pst where pst.product_sub_type_id = pd.product_sub_type_id) as product_sub_name, ifnull((select if(c.complexity_level_id between 100 and 120,concat('Level','',c.complexity_level_name), c.complexity_level_name) " & _
"from lgms.cfg_complexity_level  c where c.complexity_level_id=(SELECT p.internal_complexity_level_id " & _
"FROM workflow.project_complexity_mapping p where p.project_id = pd.project_id And p.category_id = 1 " & _
"and p.version_id=(select max(p1.version_id) from workflow.project_complexity_mapping p1 " & _
"where p.project_id=p1.project_id and p.category_id=p1.category_id) limit 1) limit 1), (SELECT (select if(cl.complexity_level_id between 100 and 120,concat('Level',' ',complexity_level_name),concat(complexity_level_name)) from lgms.cfg_complexity_level cl where cl.complexity_level_id = ifnull(textech_complexity_level_id,customer_complexity_level_id)) " & _
"FROM workflow.budget_estimate_service_item_mapping b, lgms.cfg_service_item cs, workflow.budget_estimate be where pd.project_id=be.project_id and b.budget_estimate_id=be.budget_estimate_id and be.version_id = (select max(version_id) from workflow.budget_estimate be1 where be1.project_id=be.project_id) and cs.service_item_id=b.service_item_id  and cs.composition_priority_no <> 1000 order by composition_priority_no limit 1)) as compcmpx, " & _
"s.stage_id, s.stage_name, wd.cycle_id, convert((select page_count from workflow.phase1_page_count_entity p where p.project_id = pd.project_id And s.stage_id = p.stage_id and p.number=wd.cycle_id order by -sequence_no,-p.stage_id,-p.number,-phase1_page_count_entity_id limit 1)using utf8) as typeset_pages , timestamp(wd.start_time,'05:30') as start_date, timestamp((select end_time from workflow.external_workorder_details pic,workflow.cfg_stage_activity_step sas where pic.project_id=wd.project_id and wd.external_workorder_id = pic.external_workorder_id " & _
"and pic.stage_id = sas.stage_id and pic.activity_id = sas.activity_id and pic.step_id = sas.step_id and " & _
"if(sas.stage_activity_step_id in (827),sas.stage_activity_step_id in (827), if(sas.stage_activity_step_id in (344),sas.stage_activity_step_id in (344), if(sas.stage_activity_step_id in (375),sas.stage_activity_step_id in (375), " & _
"sas.stage_activity_step_id in (827)))) and wd.cycle_id=pic.cycle_id and pic.status_id =50 limit 1),'05:30') as coq_out, " & _
"wd.assigned_to, concat(tr.fname) as Name, (select team_name from ems.team_member tm, ems.team_details td where tm.team_id=td.team_id and tm.empid =wd.assigned_to and member_type_id=1 limit 1) as vendor_name, " & _
"(select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_id, " & _
"(select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_name " & _
"from workflow.external_workorder_details wd, workflow.project_details pd, lgms.customer_division_imprint cdi, workflow.cfg_product pt, workflow.cfg_stages s, workflow.cfg_stage_activity_step sas, ems.textech_resources tr,vms.freelancer_details fd where wd.project_id = pd.project_id And pd.project_status_id <> 30 And fd.freelancer_id = tr.empid And fd.vendor_type_id in (1,2) " & _
"and " & qry_proj & " and " & qry_cust & " and " & qry_wf & " and " & qry_stage_ewo & " and " & qry_cycle_ewo & " " & _
"and wd.stage_id = sas.stage_id and wd.activity_id = sas.activity_id and wd.step_id = sas.step_id " & _
"and pd.customer_division_imprint_id= cdi.customer_division_imprint_id and pd.product_id=pt.product_id and sas.stage_id=s.stage_id and wd.status_id =50 and sas.stage_activity_step_id in (827,344,375) and wd.assigned_to =tr.empid " & _
"and (tr.company_id=4 or (tr.company_id = 1 and tr.resource_type_id = 2)) and (wd.summary= 'AuroTech-XML - Perform XSLT' or wd.summary= 'MightyMinds-XML - Perform XSLT' or wd.summary= 'AuroTech-FPP - Perform FPP' or wd.summary= 'MightyMinds-FPP - Perform FPP' or wd.summary= 'AuroTech-Revises - Perform Revises' or wd.summary= 'MightyMinds-Revises - Perform Revises' or wd.summary= 'ProMicro - Perform FPP' or wd.summary= 'ProMicro-Revises - Perform Revises' or wd.summary= 'Globalen - Perform FPP' or wd.summary= 'Globalen-Revises - Perform Revises') " & _
"and ((sas.stage_activity_step_id in (827) and wd.cycle_id in (0)) or (sas.stage_activity_step_id in (344) and wd.cycle_id in (0)) or (sas.stage_activity_step_id in (375) ) ) "

'#### COMMENTED BY BOOPATHI ON 20-MAR-2020 BASED ON JEEVA REQUEST TH00000316
'qry_ewo2 = "select pd.project_id, pd.project_name, pd.workflow_id, (concat_ws(' ',(select customer_name from lgms.customer_details c where c.customer_id=cdi.customer_id), (select division_name from lgms.division_details c where c.division_id=cdi.division_id), (select imprint_name from lgms.imprint_details c where c.imprint_id=cdi.imprint_id))) as Customer, " & _
"pt.product_name, (select product_sub_type_name from workflow.cfg_product_sub_type pst where pst.product_sub_type_id = pd.product_sub_type_id) as product_sub_name, ifnull((select if(c.complexity_level_id between 100 and 120,concat('Level','',c.complexity_level_name), c.complexity_level_name) " & _
"from lgms.cfg_complexity_level  c where c.complexity_level_id=(SELECT p.internal_complexity_level_id " & _
"FROM workflow.project_complexity_mapping p where p.project_id = pd.project_id And p.category_id = 1 " & _
"and p.version_id=(select max(p1.version_id) from workflow.project_complexity_mapping p1 " & _
"where p.project_id=p1.project_id and p.category_id=p1.category_id) limit 1) limit 1), (SELECT (select if(cl.complexity_level_id between 100 and 120,concat('Level',' ',complexity_level_name),concat(complexity_level_name)) from lgms.cfg_complexity_level cl where cl.complexity_level_id = ifnull(textech_complexity_level_id,customer_complexity_level_id)) " & _
"FROM workflow.budget_estimate_service_item_mapping b, lgms.cfg_service_item cs, workflow.budget_estimate be where pd.project_id=be.project_id and b.budget_estimate_id=be.budget_estimate_id and be.version_id = (select max(version_id) from workflow.budget_estimate be1 where be1.project_id=be.project_id) and cs.service_item_id=b.service_item_id  and cs.composition_priority_no <> 1000 order by composition_priority_no limit 1)) as compcmpx, " & _
"s.stage_id, s.stage_name, wd.cycle_id, (select page_count from workflow.phase1_page_count_entity p where p.project_id = pd.project_id And s.stage_id = p.stage_id and p.number=wd.cycle_id order by -sequence_no,-p.stage_id,-p.number limit 1) as typeset_pages, timestamp(wd.start_time,'05:30') as start_date, timestamp((select end_time from workflow.external_workorder_details pic,workflow.cfg_stage_activity_step sas where pic.project_id=wd.project_id " & _
"and pic.stage_id = sas.stage_id and pic.activity_id = sas.activity_id and pic.step_id = sas.step_id and " & _
"if(sas.stage_activity_step_id in (827),sas.stage_activity_step_id in (827), " & _
"sas.stage_activity_step_id in (827)) and wd.cycle_id=pic.cycle_id and pic.status_id =50 limit 1),'05:30') as coq_out, " & _
"wd.assigned_to, concat(tr.fname) as Name, (select team_name from ems.team_member tm, ems.team_details td where tm.team_id=td.team_id and tm.empid =wd.assigned_to and member_type_id=1 limit 1) as vendor_name, " & _
"(select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_id from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_id, " & _
"(select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and pd.workflow_id=tc.workflow_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 Union select td.team_name from ems.team_customer tc,ems.team_details td, ems.textech_resources tr where pd.customer_division_imprint_id = tc.customer_division_imprint_id and tc.team_id = td.team_id and td.owner_id=tr.empid and tr.company_id=1 limit 1) as team_name " & _
"from workflow.external_workorder_details wd, workflow.project_details pd, lgms.customer_division_imprint cdi, workflow.cfg_product pt, workflow.cfg_stages s, workflow.cfg_stage_activity_step sas, ems.textech_resources tr where wd.project_id = pd.project_id And pd.project_status_id <> 30 " & _
"and " & qry_proj & " and " & qry_cust & " and " & qry_wf & " and " & qry_stage_ewo & " and " & qry_cycle_ewo & " " & _
"and wd.stage_id = sas.stage_id and wd.activity_id = sas.activity_id and wd.step_id = sas.step_id " & _
"and pd.customer_division_imprint_id= cdi.customer_division_imprint_id and pd.product_id=pt.product_id and sas.stage_id=s.stage_id and wd.status_id =50 and sas.stage_activity_step_id in (827) and wd.assigned_to =tr.empid " & _
"and (tr.company_id=4 or (tr.company_id = 1 and tr.resource_type_id = 2))  and (wd.summary= 'AuroTech-XML - Perform XSLT' or wd.summary= 'MightyMinds-XML - Perform XSLT') " & _
"and ((sas.stage_activity_step_id in (827) and wd.cycle_id in (0)) )"

rs_sch.Open qry_ewo2, con_rep, adOpenKeyset, adLockOptimistic, adCmdText

'"and pd.customer_division_imprint_id = sewo.customer_division_imprint_id " & _
',lgms.customer_standard_ewo_details sewo

If rs_sch.RecordCount > 0 Then

vendor_name = rs_sch.Fields("Name")
        
End If
        
rs_sch.Close

End If
        
        
        'Call VIR value layout proceedure
        Call vir_value_display(sno, customer_name, wf_name, project_id, query_flag, project_name, book_title, pname, sub_pname, workorder_type, deliverable_label, batch_number, comments, receipt_date, planned_date, comp_date, actual_end, timezone, cutoff_time, force_time_delivery, Status, reason_code, complexity, ms_pages, del_pages, cnt, customer_contact, pm_pc, csr_name, composition, est_distro_date, billing_status, isbn, is_embargoed, vendor_name, title_count, year_id, designer_contact, prh_team)
        
'        If rs_iwo.Fields("team_id") = "46" Or rs_iwo.Fields("team_id") = "58" Or rs_iwo.Fields("team_id") = 4 Then
'            'Call DELIVERABLES REPORT value layout proceedure (for TRADE US/UK/PUS Teams)
'            If ActiveSheet.Name = "Deliverables" Then
'            Call vir_value_display(sno, customer_name, wf_name, project_id, query_flag, project_name, book_title, pname, sub_pname, deliverable_label, batch_number, comments, receipt_date, planned_date, comp_date, actual_end, timezone, cutoff_time, force_time_delivery, Status, reason_code, complexity, ms_pages, del_pages, cnt, customer_contact, pm_pc, csr_name, composition, est_distro_date, billing_status, isbn)
'            Call vir_value_display(sno, customer_name, "", project_id, query_flag, project_name, "", "", "", deliverable_label, "", "", receipt_date, planned_date, comp_date, actual_end, timezone, cutoff_time, force_time_delivery, Status, reason_code, "", "", "", "", customer_contact, "", "", "", "", "", "")
'            ElseIf ActiveSheet.Name = "WIP" Then
'            Call vir_value_display(sno, customer_name, "", project_id, query_flag, project_name, "", "", "", deliverable_label, "", "", receipt_date, planned_date, "", "", "", "", "", Status, "", "", "", "", "", customer_contact, "", "", "", "", "", "")
'            End If
'        End If
         
        Status = ""
        complexity = ""
        ms_pages = ""
        del_pages = ""
        vendor_name = ""
        deliverable_label = ""
        title_count = ""
        year_id = ""
        
        row_inv = row_inv + 1
        column_inv = 1
        sno = sno + 1
        
exi:
        str2 = ""
        
        record_counter = record_counter + 1
        
        Call progress_bar((record_counter / rs_iwo.RecordCount), rs_iwo.RecordCount)
        
        rs_iwo.MoveNext
        Loop

End If

    If wo_type = "iwo" Then
        If rs_iwo.RecordCount = 0 Then
        progress_status.Caption = "No IWO Records available...!"
        Else
        progress_status.Caption = "IWO Records...Done!" & " (" & rs_iwo.RecordCount & ")"
        progress_status.Caption = "Checking EWO Records..."
        End If
    Else
        If rs_iwo.RecordCount = 0 Then
        progress_status.Caption = "No EWO Records available...!"
        Else
        progress_status.Caption = "EWO Records...Done!" & " (" & rs_iwo.RecordCount & ")"
        End If
    End If
    

End Sub

Public Function vir_value_display(sno, customer_name, wf_name, project_id, query_flag, project_name, book_title, pname, sub_pname, workorder_type, deliverable_label, batch_number, comments, receipt_date, planned_date, comp_date, actual_end, timezone, cutoff_time, force_time_delivery, Status, reason_code, complexity, ms_pages, del_pages, cnt, customer_contact, pm_pc, csr_name, composition, est_distro_date, billing_status, isbn, is_embargoed, vendor_name, title_count, year_id, designer_contact, prh_team)

'The below block commented based on Jeeva Request (Ticket Number: TF00018190) on Sep 17, 2016
'If CheckBox2.Value = True And query_flag = 1 And comp_date <> "" And Status = "Query" Then
'
'    If InStr(1, sTemp, "46", vbTextCompare) Then
'    timezone = ""
'    cutoff_time = ""
'    ElseIf InStr(1, sTemp, "58", vbTextCompare) Then
'    timezone = ""
'    cutoff_time = ""
'    ElseIf InStr(1, sTemp, "4", vbTextCompare) Then
'    timezone = ""
'    cutoff_time = ""
'    End If
'
'End If

Dim splitv() As String

    splitv = Split(vir_field_name, ",")
    
For i = 0 To UBound(splitv)
    
    If UBound(splitv) > 0 Then
        
        a = CStr(splitv(i))
        
        If a = "sno" Then
        ActiveSheet.Cells(row_inv, column_inv) = sno
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "customer_name" Then
        ActiveSheet.Cells(row_inv, column_inv) = customer_name
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "wf_name" Then
        ActiveSheet.Cells(row_inv, column_inv) = wf_name
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "platform" Then
        ActiveSheet.Cells(row_inv, column_inv) = platform
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "is_embargoed" Then
        ActiveSheet.Cells(row_inv, column_inv) = is_embargoed
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "project_id" Then
        ActiveSheet.Cells(row_inv, column_inv) = project_id
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "project_name" Then
        ActiveSheet.Cells(row_inv, column_inv) = project_name
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "book_title" Then
        ActiveSheet.Cells(row_inv, column_inv) = book_title
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "isbn" Then
        ActiveSheet.Cells(row_inv, column_inv) = isbn
        ActiveSheet.Cells(row_inv, column_inv).NumberFormat = "0"
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "pname" Then
        ActiveSheet.Cells(row_inv, column_inv) = pname
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "sub_pname" Then
        ActiveSheet.Cells(row_inv, column_inv) = sub_pname
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "workorder_type" Then
        ActiveSheet.Cells(row_inv, column_inv) = workorder_type
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "deliverable_label" Then
        ActiveSheet.Cells(row_inv, column_inv) = deliverable_label
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "batch_number" Then
        ActiveSheet.Cells(row_inv, column_inv) = batch_number
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "comments" Then
        ActiveSheet.Cells(row_inv, column_inv) = comments
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "receipt_date" Then
        ActiveSheet.Cells(row_inv, column_inv) = receipt_date
        ActiveSheet.Cells(row_inv, column_inv).NumberFormat = "[$-409]d-mmm;@"
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "planned_date" Then
        ActiveSheet.Cells(row_inv, column_inv) = planned_date
        ActiveSheet.Cells(row_inv, column_inv).NumberFormat = "[$-409]d-mmm;@"
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "comp_date" Then
        ActiveSheet.Cells(row_inv, column_inv) = comp_date
        ActiveSheet.Cells(row_inv, column_inv).NumberFormat = "[$-409]d-mmm;@"
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "actual_end" Then
        ActiveSheet.Cells(row_inv, column_inv) = format(actual_end, "HH:mm:ss")
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        
        If a = "timezone" Then
        ActiveSheet.Cells(row_inv, column_inv) = timezone
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If

        If a = "cutoff_time" Then
        ActiveSheet.Cells(row_inv, column_inv) = format(cutoff_time, "HH:mm:ss")
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "force_time_delivery" Then
        ActiveSheet.Cells(row_inv, column_inv) = force_time_delivery
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "Status" Then
        ActiveSheet.Cells(row_inv, column_inv) = Status
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "reason_code" Then
        ActiveSheet.Cells(row_inv, column_inv) = reason_code
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "complexity" Then
        ActiveSheet.Cells(row_inv, column_inv) = complexity
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "ms_pages" Then
        ActiveSheet.Cells(row_inv, column_inv) = ms_pages
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "del_pages" Then
        ActiveSheet.Cells(row_inv, column_inv) = del_pages
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "cnt" Then
        ActiveSheet.Cells(row_inv, column_inv) = cnt
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "customer_contact" Then
        ActiveSheet.Cells(row_inv, column_inv) = customer_contact
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "pm_pc" Then
        ActiveSheet.Cells(row_inv, column_inv) = pm_pc
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "csr_name" Then
        ActiveSheet.Cells(row_inv, column_inv) = csr_name
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
        If a = "composition" Then
        ActiveSheet.Cells(row_inv, column_inv) = composition
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "billing_status" Then
        ActiveSheet.Cells(row_inv, column_inv) = billing_status
        ActiveSheet.Cells(row_inv, column_inv).NumberFormat = "[$-409]d-mmm-yyyy;@"
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "est_distro_date" Then
        ActiveSheet.Cells(row_inv, column_inv) = est_distro_date
        ActiveSheet.Cells(row_inv, column_inv).NumberFormat = "[$-409]d-mmm-yyyy;@"
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "vendor_name" Then
        ActiveSheet.Cells(row_inv, column_inv) = vendor_name
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If

        If a = "title_count" Then
        ActiveSheet.Cells(row_inv, column_inv) = title_count
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "year_id" Then
        ActiveSheet.Cells(row_inv, column_inv) = year_id
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlCenter
        column_inv = column_inv + 1
        End If
        
        If a = "designer_contact" Then
        ActiveSheet.Cells(row_inv, column_inv) = designer_contact
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
                
        If a = "prh_team" Then
        ActiveSheet.Cells(row_inv, column_inv) = prh_team
        ActiveSheet.Cells(row_inv, column_inv).HorizontalAlignment = xlLeft
        column_inv = column_inv + 1
        End If
        
    End If
    
Next i


End Function

Sub Status_sort(LastCol)

Dim lastrow As Integer

lastrow = ActiveSheet.Cells.Find("*", _
    searchorder:=xlByRows, LookIn:=xlValues, _
    SearchDirection:=xlPrevious).EntireRow.row
    
Dim LastCol1 As Long
LastCol1 = Cells.Find("*", _
    searchorder:=xlByColumns, LookIn:=xlValues, _
    SearchDirection:=xlPrevious).EntireColumn.Column
    'MsgBox LastCol
    
myCol1 = GetColumnLetter(LastCol1)

Range("A8:" & myCol1 & lastrow).Select

'Move the WIP projects, next to the delivered projects
Dim j As Long
For j = 1 To LastCol1
    If Cells(8, j).Value = "Status" Then
    
    myCol = GetColumnLetter(j)
    
    Selection.Sort key1:=Range(myCol & "9"), _
      order1:=xlAscending, Header:=xlYesro
      
    End If
Next j

End Sub
